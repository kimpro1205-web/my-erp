<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MakeFree ERP Ultimate [UIFIX_20260221_V20]</title>
<style>
  :root{
    --bg:#f3f5f9; --card:#fff; --line:#e5e7eb; --txt:#111827; --sub:#6b7280;
    --pri:#2563eb; --pri2:#1d4ed8; --ok:#059669; --warn:#d97706; --danger:#dc2626;
    --shadow: 0 10px 30px rgba(17,24,39,.08); --r:14px;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Apple SD Gothic Neo","Noto Sans KR",sans-serif; background:var(--bg); color:var(--txt); }
  header{
    position:sticky; top:0; z-index:10;
    background:rgba(255,255,255,.92); backdrop-filter: blur(10px);
    border-bottom:1px solid var(--line);
  }
  .wrap{ max-width:1600px; margin:0 auto; padding:14px 16px; }
  .top{ display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
  .brand{ display:flex; align-items:center; gap:10px; }
  .logo{ width:34px; height:34px; border-radius:10px; background:linear-gradient(135deg,var(--pri),#60a5fa); box-shadow:0 10px 22px rgba(37,99,235,.25); }
  h1{ margin:0; font-size:15px; }
  .meta{ color:var(--sub); font-size:12px; margin-top:2px; }
  .btns{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
  button,.btn{
    appearance:none; border:1px solid var(--line); background:#fff; color:var(--txt);
    padding:9px 11px; border-radius:12px; cursor:pointer; font-weight:900; font-size:13px;
    transition:.12s ease;
  }
  button:hover,.btn:hover{ transform:translateY(-1px); box-shadow:0 10px 18px rgba(17,24,39,.08); }
  .pri{ background:var(--pri); color:#fff; border-color:transparent; }
  .pri:hover{ background:var(--pri2); }
  .ok{ background:var(--ok); color:#fff; border-color:transparent; }
  .danger{ background:var(--danger); color:#fff; border-color:transparent; }
  .pill{ padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:#fff; color:var(--sub); font-size:12px; font-weight:900; }
  .pill.danger{ border-color:rgba(220,38,38,.25); background:rgba(220,38,38,.08); color:var(--danger); }
  main{ padding:18px 0 40px; }
  .grid{ display:grid; grid-template-columns: 300px 1fr; gap:14px; }
  @media (max-width: 1100px){ .grid{ grid-template-columns:1fr; } }

  /* --- Responsive fix: prevent whole-page horizontal scroll --- */
  html, body{ overflow-x:hidden; }
  .grid > nav, .grid > section{ min-width:0; }
  .panel{ min-width:0; }
  .gridwrap{ max-width:100%; }


  nav{
    background:var(--card); border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow);
    padding:10px; position:sticky; top:78px; height: calc(100vh - 98px); overflow:auto;
  }
  .navtitle{ padding:10px 10px 6px; color:var(--sub); font-size:12px; font-weight:900; }
  .navbtn{
    width:100%; text-align:left; padding:10px 10px; border-radius:12px;
    border:1px solid transparent; background:#fff; cursor:pointer; font-weight:900;
    display:flex; justify-content:space-between; align-items:center; gap:10px;
  }
  .navbtn small{ color:var(--sub); font-weight:900; }
  .navbtn.active{ background:rgba(37,99,235,.10); border-color:rgba(37,99,235,.20); }

  section.panel{
    background:var(--card); border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow);
    padding:14px;
  }
  .panel h2{ margin:0 0 10px; font-size:15px; }
  .hr{ height:1px; background:var(--line); margin:12px 0; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:stretch; }
  .col{ flex:1; min-width:260px; }
  .card{ border:1px solid var(--line); border-radius:14px; padding:12px; background:#fff; }
  .kpi .label{ color:var(--sub); font-size:12px; font-weight:900; }
  .kpi .value{ font-size:18px; font-weight:1000; letter-spacing:-.2px; margin-top:4px; }
  .kpi .hint{ color:var(--sub); font-size:12px; margin-top:6px; }

  label{ display:block; font-size:12px; font-weight:900; margin-bottom:6px; color:#374151; }
  input, select, textarea{
    width:100%; padding:9px 10px; border-radius:12px; border:1px solid var(--line);
    outline:none; font-size:13px; background:#fff;
  }
  input:focus, select:focus, textarea:focus{ border-color:rgba(37,99,235,.55); box-shadow:0 0 0 4px rgba(37,99,235,.12); }
  textarea{ min-height:130px; resize:vertical; }
  .form{ display:grid; grid-template-columns: repeat(12,1fr); gap:10px; }
  .f2{ grid-column: span 2; } .f3{ grid-column: span 3; } .f4{ grid-column: span 4; } .f6{ grid-column: span 6; } .f8{ grid-column: span 8; } .f12{ grid-column: span 12; }
  @media (max-width: 920px){ .f2,.f3,.f4,.f6,.f8{ grid-column: span 12; } }

  table{ width:100%; border-collapse:collapse; }
  th,td{ border-bottom:1px solid var(--line); padding:8px 8px; font-size:13px; vertical-align:top; }
  /* UI fix: readable rows */
  td{ line-height:1.25; }
  /* UI fix: prevent date wrapping (avoid "겹쳐보임") */
  #view-search .txgrid th:nth-child(2), #view-search .txgrid td:nth-child(2){ min-width:110px; white-space:nowrap; }
  #view-month .txgrid th:nth-child(1),  #view-month .txgrid td:nth-child(1){  min-width:110px; white-space:nowrap; }
  #view-ledger .txgrid th:nth-child(1), #view-ledger .txgrid td:nth-child(1){ min-width:110px; white-space:nowrap; }

  th{ text-align:left; font-size:12px; color:#374151; letter-spacing:.1px; }
  tbody tr:hover{ background:rgba(17,24,39,.02); }
  tr.qActive{ background:rgba(37,99,235,.08) !important; }
  .right{ text-align:right; }
  .muted{ color:var(--sub); }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
  .badge{
    display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px;
    border:1px solid var(--line); background:#fff; font-size:12px; font-weight:1000; color:#374151;
  }
  .b-pri{ border-color:rgba(37,99,235,.25); background:rgba(37,99,235,.08); color:var(--pri2); }
  .b-ok{ border-color:rgba(5,150,105,.25); background:rgba(5,150,105,.08); color:var(--ok); }
  .b-warn{ border-color:rgba(217,119,6,.25); background:rgba(217,119,6,.08); color:var(--warn); }
  .b-danger{ border-color:rgba(220,38,38,.25); background:rgba(220,38,38,.08); color:var(--danger); }

  .gridwrap{ overflow:auto; border:1px solid var(--line); border-radius:14px; }
  .txgrid{ min-width:1500px; }
  .txgrid th{ position:sticky; top:0; background:#fff; z-index:2; }
  .txgrid tr.sel{ background: rgba(37,99,235,.06); }
  .cell{
    width:100%; border:1px solid transparent; border-radius:10px; padding:7px 8px;
    font-size:13px; background:#fff;
  }
  .cell:focus{ outline:none; border-color:rgba(37,99,235,.55); box-shadow:0 0 0 3px rgba(37,99,235,.12); }
  .chk{ width:18px; height:18px; cursor:pointer; }
.btn.mini{ padding:6px 8px; font-size:12px; border-radius:10px; }
  .btn.mini.ok{ background:var(--ok); color:#fff; border-color:transparent; }
.chklabel{ display:inline-flex; align-items:center; gap:6px; white-space:nowrap; }
.tiny{ font-size:12px; }
  .toolbar{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center; }
  .toolbar .left, .toolbar .right{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .note{ color:var(--sub); font-size:12px; line-height:1.45; }
  .dangerText{ color:var(--danger); font-weight:900; }
  .warnText{ color:var(--warn); font-weight:900; }
  .linklike{ color:var(--pri2); cursor:pointer; font-weight:900; }
  .miniInput{ width:140px; padding:6px 8px; border-radius:10px; border:1px solid var(--line); font-size:12px; }

  /* Modals */
  .modal{ position:fixed; inset:0; z-index:9999; }
  .modal.hidden{ display:none; }
  .modal__backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.35); }
  .modal__panel{ position:relative; width:min(1180px,92vw); margin:6vh auto; background:#fff; border-radius:14px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.2);  max-height:90vh; }
  .modal__head{ display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid var(--line); }
  .modal__title{ font-weight:1000; }
  .modal__body{ padding:14px 16px; max-height:70vh; overflow:auto; }
  .tinyRow{ font-size:12px; line-height:1.25; }


  /* Compact mode: reduce horizontal scrolling */
  body.compactTables .txgrid{ min-width:0 !important; width:100% !important; table-layout:fixed; }
  body.compactTables .txgrid th, body.compactTables .txgrid td{ min-width:0 !important; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  body.compactTables .gridwrap{ overflow-x:hidden; }


  .miniActBtn{ padding:6px 8px !important; border-radius:10px !important; font-size:12px !important; font-weight:900 !important; }
  .miniActBtnRow{ display:flex; gap:6px; align-items:center; justify-content:flex-end; }
  .miniActBtnRow input{ flex:1; min-width:90px; }


/* === UI FIX: 거래 수정 패널(우측) 수량/단가 가독성 개선 === */
#mfPanelBody .form{ gap:14px; } /* 기존 10px → 14px */
#mfPanelBody input#eQty{ text-align:right; padding-right:14px; }
#mfPanelBody .miniActBtnRow{ gap:10px; }
#mfPanelBody .miniActBtnRow input#eUnit{ min-width:140px; text-align:right; padding-right:14px; }
#mfPanelBody .miniActBtn{ min-width:54px; }



/* MASTER3: dashboard project table readability */
#dashProjStatusBody td, #dashProjStatusBody th{ white-space:nowrap; }
#dashProjStatusBody td:nth-child(1), #dashProjStatusBody th:nth-child(1){ min-width:180px; }
#dashProjStatusBody td:nth-child(2), #dashProjStatusBody th:nth-child(2){ min-width:120px; }
#dashProjStatusBody td:nth-child(3), #dashProjStatusBody th:nth-child(3){ min-width:120px; }
#dashProjStatusBody td:nth-child(4), #dashProjStatusBody th:nth-child(4){ min-width:120px; }


.gridwrap.scrollY{ max-height:520px; overflow:auto; }

.txgrid td:first-child, .txgrid th:first-child{ min-width:110px; }

  .nowrap{ white-space:nowrap !important; }
  /* Search/조합: 날짜 줄바꿈 방지 + 가독성 */
  #view-search .txgrid th:nth-child(2),
  #view-search .txgrid td:nth-child(2){ min-width:110px; white-space:nowrap; }
  #view-search .txgrid td:nth-child(2){ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
  #view-search .txgrid td{ line-height:1.35; }


/* ===== Month Quick Edit Side Panel (A) ===== */
.qeOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.25);
  z-index: 9998;
}
.qePanel{
  position:fixed;
  top:0; right:-460px;
  width:460px; height:100%;
  background:var(--bg);
  border-left:1px solid var(--line);
  z-index: 9999;
  box-shadow: -16px 0 40px rgba(0,0,0,.12);
  transition:right .18s ease;
  display:flex;
  flex-direction:column;
}
.qePanel.open{ right:0; }
.qeHead{
  padding:14px 14px;
  border-bottom:1px solid var(--line);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.qeTitle{ font-weight:800; }
.qeBody{ padding:14px; overflow:auto; }
.qeBody .form .f1,.qeBody .form .f2,.qeBody .form .f3{ margin-bottom:10px; }

</style>

<script>
/* MF_ERROR_OVERLAY */
(function(){
  function show(title, detail){
    try{
      var el = document.getElementById("mf_error_overlay");
      if(!el){
        el = document.createElement("div");
        el.id = "mf_error_overlay";
        el.style.position="fixed";
        el.style.inset="0";
        el.style.zIndex="999999";
        el.style.background="rgba(0,0,0,.55)";
        el.style.padding="18px";
        el.style.display="flex";
        el.style.alignItems="flex-start";
        el.style.justifyContent="center";
        el.innerHTML = '<div style="width:min(980px,95vw);background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25)">'+
          '<div style="padding:12px 14px;border-bottom:1px solid #e5e7eb;font-weight:900">MakeFreeERP 오류</div>'+
          '<div style="padding:14px">'+
          '<div id="mf_err_title" style="font-weight:900;margin-bottom:8px"></div>'+
          '<pre id="mf_err_detail" style="white-space:pre-wrap;word-break:break-word;background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;padding:12px;max-height:55vh;overflow:auto"></pre>'+
          '<div style="margin-top:10px;font-size:12px;color:#6b7280">이 화면이 뜨면 스크립트가 중간에서 멈춘 상태입니다. 내용을 복사해서 보내주면 바로 수정 가능합니다.</div>'+
          '</div></div>';
        document.body.appendChild(el);
      }
      document.getElementById("mf_err_title").textContent = title || "오류";
      document.getElementById("mf_err_detail").textContent = detail || "";
    }catch(e){}
  }
  window.addEventListener("error", function(ev){
    var msg = ev && ev.message ? ev.message : "Unknown error";
    var src = ev && ev.filename ? ev.filename : "";
    var line = ev && ev.lineno ? ev.lineno : "";
    var col = ev && ev.colno ? ev.colno : "";
    show("스크립트 오류: " + msg, (src ? (src + ":" + line + ":" + col + "\n\n") : "") + ((ev && ev.error && ev.error.stack) ? ev.error.stack : ""));
  });
  window.addEventListener("unhandledrejection", function(ev){
    var r = ev && ev.reason ? ev.reason : "Unhandled rejection";
    var detail = "";
    try{ detail = (r && r.stack) ? r.stack : String(r); }catch(e){ detail = "Unhandled rejection"; }
    show("Promise 오류", detail);
  });
})();
</script>


<script>
/* MF_OPEN_NOTICE */
(function(){
  try{
    if(location.protocol==="file:"){
      console.warn("MakeFreeERP: opened via file:// . Use Run .bat and http://localhost to avoid issues.");
    }
  }catch(e){}
})();
</script>

</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>MakeFree ERP Ultimate (AR/AP 분리 · 정산/상계 · 엑셀입력) <span class="badge b-pri" style="margin-left:8px;">UIFIX_20260221_V20</span></h1>
          <div class="meta" id="saveStatus">[UIFIX_20260116] 로컬 자동저장 · A6_FIX 준비중… <span id="buildTag" style="margin-left:8px; opacity:.65;">Build: A17_INTEGRATED_EXPENSE_PAIR_UI_SCALE_SORT_20260201</span></div>
        </div>
      </div>
      <div class="btns">
        <span class="pill" id="monthPill">월: -</span>
        <span class="pill danger" id="payDuePill" style="display:none;" title="수금완료·지급대기 프로젝트">지급대기: 0</span>
        

        <button id="btnAutoMatchToggle" class="btn">수금/지급 자동정산: OFF</button>
        <span class="pill" id="autoMatchPill" title="수금/지급 입력 저장 시 자동정산">자동정산: OFF</span>
<button id="btnAutoBackupSetup" class="btn ok">폴더 자동백업 설정</button>
<button id="btnAutoBackupOff" class="btn" title="폴더 연결 해제">자동백업 해제</button>
<span class="pill" id="autoBackupPill" title="폴더 자동백업 상태">자동백업: OFF</span>

        <button id="btnCompactToggle" class="btn">표: 줄임</button>
<span class="pill" id="compactPill" title="가로스크롤 최소화">표: 줄임</span>
<button id="btnBackup" class="btn">백업 JSON</button>
        <label class="btn" for="importJson" style="cursor:pointer;">
          JSON 불러오기<input id="importJson" type="file" accept="application/json" style="display:none;">
        </label>
        <button id="btnResetDemo" class="btn">데모데이터</button>
        <button id="btnClear" class="btn danger">전체초기화</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="grid">

      <nav>
        <div class="navtitle">기본</div>
        <button class="navbtn active" data-view="dash">대시보드 <small>월요약/상세</small></button>
<button class="navbtn" data-view="month">월 거래내역 <small>상세(기준월)</small></button>
        <button class="navbtn" data-view="excel">엑셀입력 <small>다건/붙여넣기</small></button>
        <button class="navbtn" data-view="search">검색/조합 <small>미정산 필터</small></button>

        <div class="navtitle">정산/원장</div>
        <button class="navbtn" data-view="settle">고급 정산/매칭 <small>부분수금·예외용</small></button>
        <button class="navbtn" data-view="arap">미수/미지급 <small>자동상계 금지</small></button>

        <div class="navtitle">리포트</div>
        <button class="navbtn" data-view="ledger">거래처원장 <small>기간/출력</small></button>

        <button class="navbtn" data-view="proj">프로젝트 손익 <small>월/연</small></button>

        <div class="navtitle">기초자료</div>
        <button class="navbtn" data-view="base">기초자산/계정 <small>통장·대출</small></button>
        <button class="navbtn" data-view="master">마스터 <small>거래처/프로젝트/품목</small></button>

        <div class="hr"></div>
        <div class="note" style="padding:0 10px 10px;">
          <b>원칙:</b> 거래처가 같아도 <b>미수(AR)</b>와 <b>미지급(AP)</b>은 자동 상계하지 않습니다.<br/>
          상계는 <b>정산/매칭</b>에서 <b>수동 상계</b>로만 처리합니다.
        </div>
      </nav>

      <!-- DASH -->
      <section class="panel" id="view-dash">
        <h2>이번달 요약 + 상세(항상)</h2>

        <div class="row">
          <div class="col card kpi">
            <div class="label">이번달 매출(총)</div>
            <div class="value" id="kpiSales">0</div>
            <div class="hint">미발행(매출+매입): <b id="kpiUninvSales">0</b> / 미발행 매입: <b id="kpiUninvPurch">0</b></div>
          </div>
          <div class="col card kpi">
            <div class="label">이번달 매입(총)</div>
            <div class="value" id="kpiPurch">0</div>
            <div class="hint">지급(출금): <b id="kpiPay">0</b></div>
          </div>
          <div class="col card kpi">
            <div class="label">이번달 경비(총)</div>
            <div class="value" id="kpiExp">0</div>
            <div class="hint">수금(입금): <b id="kpiRecv">0</b></div>
          </div>
          <div class="col card kpi">
            <div class="label">이번달 이익(간이)</div>
            <div class="value" id="kpiProfit">0</div>
            <div class="hint">매출-(매입+경비)</div>
          </div>
</div>

        <div class="hr"></div>

        
        <div class="row">
          <div class="col card">
            <div class="toolbar">
              <div class="left">
                <span class="badge b-pri">월말 체크리스트(이번달)</span>
                <span class="note">버튼 클릭 → 검색/조합으로 이동</span>
              </div>
            </div>
            <div class="row" style="margin-top:10px;">
              <div class="col card kpi">
                <div class="label">미발행 매출</div>
                <div class="value" id="dashUninvSales">0</div>
                <div class="hint">건수: <b id="dashUninvSalesCnt">0</b> · <button class="btn tiny" id="btnDashUninvSales">보기</button></div>
              </div>
              <div class="col card kpi">
                <div class="label">미발행 매입/경비</div>
                <div class="value" id="dashUninvCost">0</div>
                <div class="hint">건수: <b id="dashUninvCostCnt">0</b> · <button class="btn tiny" id="btnDashUninvCost">보기</button></div>
              </div>
              <div class="col card kpi">
                <div class="label">미수(미정산)</div>
                <div class="value" id="dashOpenAR">0</div>
                <div class="hint"><button class="btn tiny" id="btnDashOpenAR">보기</button></div>
              </div>
              <div class="col card kpi">
                <div class="label">미지급(미정산)</div>
                <div class="value" id="dashOpenAP">0</div>
                <div class="hint"><button class="btn tiny" id="btnDashOpenAP">보기</button></div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="row">
              <div class="col card kpi">
                <div class="label">미배분 수금(이번달)</div>
                <div class="value" id="dashUnallocRecv">0</div>
                <div class="hint">배분: <b id="dashAllocRecv">0</b> · <button class="btn tiny" id="btnDashUnallocRecv">보기</button></div>
              </div>
              <div class="col card kpi">
                <div class="label">미배분 지급(이번달)</div>
                <div class="value" id="dashUnallocPay">0</div>
                <div class="hint">배분: <b id="dashAllocPay">0</b> · <button class="btn tiny" id="btnDashUnallocPay">보기</button></div>
              </div>
              <div class="col card">
                <div class="toolbar">
                  <div class="left">
                    <span class="badge b-warn">장기 미수/미지급(60일+)</span>
                    <span class="note">상위 10건</span>
                  </div>

              <div class="right">
                <button class="btn tiny" id="btnDashAgedMore">전체보기</button>
              </div>
            </div>
                <div class="gridwrap scrollY" style="margin-top:10px;">
            <table class="txgrid">
              <thead><tr><th>경과</th><th>구분</th><th>거래처</th><th class="right">잔액</th></tr></thead>
                    <tbody id="dashAgedBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="col card">
            <div class="toolbar">
              <div class="left">
                <span class="badge b-ok">거래처 Top 잔액</span>
                <span class="note">미수/미지급 상위 10</span>
              </div>
            </div>
            <div class="row" style="margin-top:10px;">
              <div class="col">
                <div class="gridwrap scrollY">
            <table class="txgrid">
              <thead><tr><th>거래처</th><th class="right">미수(AR)</th></tr></thead>
                    <tbody id="dashTopARBody"></tbody>
                  </table>
                </div>
              </div>
              <div class="col">
                <div class="gridwrap scrollY">
                  <table class="txgrid">
                    <thead><tr><th>거래처</th><th class="right">미지급(AP)</th></tr></thead>
                    <tbody id="dashTopAPBody"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="toolbar">
              <div class="left">
                <span class="badge b-pri">프로젝트 현황(이번달·Top10)</span>
                <span class="note">매출/비용/이익</span>
              </div>
              <div class="right">
                <button class="btn" id="btnGoProj2">프로젝트 화면</button>
              </div>
            </div>
            <div class="gridwrap" style="margin-top:10px;">
              <table class="txgrid">
                <thead><tr><th>프로젝트</th><th class="right">매출</th><th class="right">비용</th><th class="right">이익</th></tr></thead>
                <tbody id="dashProjStatusBody"></tbody>
              </table>
            </div>

            <div class="hr"></div>

            <div class="toolbar">
              <div class="left">
                <span class="badge b-danger">지급대기 프로젝트</span>
                <span class="note">매출 수금완료(미수=0)인데 매입/경비 미지급(미지급&gt;0)</span>
              </div>
              <div class="right">
                <span class="pill">대기 <b id="dashPayDueCnt">0</b></span>
                <span class="pill">미지급합 <b id="dashPayDueAmt">0</b></span>
              </div>
            </div>
            <div class="gridwrap" style="margin-top:10px;">
              <table class="txgrid">
                <thead><tr><th>프로젝트</th><th class="right">미지급(AP)</th><th class="right">미발행(매입/경비)</th><th>바로가기</th></tr></thead>
                <tbody id="dashPayDueBody"></tbody>
              </table>
            </div>
          </div>
        </div>

      </section>
      <section class="panel" id="view-month" style="display:none;">
        <h2>월 거래내역 (상세)</h2>

        <div class="card">
          <div class="toolbar">
            <div class="left">
              <span class="badge b-pri">기준월</span>
              <input class="in" type="month" id="monthPick" style="width:170px;">
              <button class="btn" id="btnMonthPrev">이전달</button>
              <button class="btn" id="btnMonthNow">이번달</button>
              <button class="btn" id="btnMonthNext">다음달</button>
              <button class="btn" id="btnMonthRefresh">새로고침</button>
            </div>
            <div class="right">
              <button class="btn pri" id="btnMonthGoExcel">엑셀입력</button>
              <button class="btn" id="btnMonthGoSearch">검색/조합</button>
              <button class="btn" id="btnMonthGoARAP">미수/미지급</button>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="col card kpi">
              <div class="label">매출(총)</div>
              <div class="value" id="mSumSales">0</div>
              <div class="hint">미발행: 매출 <b id="mUninvSalesCnt">0</b> / 매입 <b id="mUninvPurchCnt">0</b></div>
            </div>
            <div class="col card kpi">
              <div class="label">매입(총)</div>
              <div class="value" id="mSumPurch">0</div>
              <div class="hint">지급(총): <b id="mSumPay">0</b></div>
            </div>
            <div class="col card kpi">
              <div class="label">경비(총)</div>
              <div class="value" id="mSumExp">0</div>
              <div class="hint">수금(총): <b id="mSumRec">0</b></div>
            </div>
            <div class="col card kpi">
              <div class="label">당월 손익(매출-매입-경비)</div>
              <div class="value" id="mSumProfit">0</div>
              <div class="hint">순현금흐름(수금-지급): <b id="mNetCash">0</b></div>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="col">
              <div class="toolbar" style="padding:8px 10px; border:1px solid var(--line); border-radius:12px;">
                <div class="left">
                  <span class="badge">필터</span>
                  <label class="chklabel"><input type="checkbox" class="mType" value="SALE" checked> 매출</label>
                  <label class="chklabel"><input type="checkbox" class="mType" value="PURCHASE" checked> 매입</label>
                  <label class="chklabel"><input type="checkbox" class="mType" value="EXPENSE" checked> 경비</label>
                  <label class="chklabel"><input type="checkbox" class="mType" value="RECEIPT" checked> 수금</label>
                  <label class="chklabel"><input type="checkbox" class="mType" value="PAYMENT" checked> 지급</label>
                  <select class="in" id="mInvoiceFilter" style="width:160px;">
                    <option value="">세금계산서(전체)</option>
                    <option value="Y">발행</option>
                    <option value="N">미발행</option>
                  </select>
                  <select class="in" id="mOpenFilter" style="width:160px;">
                    <option value="">정산(전체)</option>
                    <option value="OPEN">미정산만</option>
                    <option value="SETTLED">정산완료만</option>
                  </select>
                  <input class="in" id="mKeyword" placeholder="거래처/품목/메모 검색" style="width:220px;">
                </div>
                <div class="right">
  <select class="in" id="mSort" style="width:210px; margin-right:8px;">
    <option value="DATE_ASC_INPUT">정렬: 날짜↑ · 입력순</option>
    <option value="DATE_ASC_FLOW">정렬: 날짜↑ · 입력순</option>
    <option value="DATE_DESC_INPUT">정렬: 날짜↓ · 입력순</option>
    <option value="DATE_ASC_TYPE">정렬: 날짜↑ · 구분순</option>
    <option value="TYPE_DATE_ASC">정렬: 구분 → 날짜↑</option>
  </select>
  <span class="badge" id="mSortHint" style="margin-right:8px;">정렬: 날짜↑ · 입력순</span>
  <span class="note">행 더블클릭: 검색/수정 화면으로 이동</span>
                </div>
              </div>
            </div>
          </div>

          <div class="gridwrap" style="margin-top:10px;">
            <table class="txgrid">
              <thead>
                <tr>
                  <th style="min-width:110px;">일자</th>
                  <th style="min-width:90px;">구분</th>
                  <th style="min-width:160px;">거래처</th>
                  <th style="min-width:160px;">프로젝트</th>
                  <th style="min-width:220px;">품목</th>
                  <th class="right" style="min-width:80px;">수량</th>
                  <th class="right" style="min-width:110px;">단가</th>
                  <th class="right" style="min-width:120px;">공급가</th>
                  <th class="right" style="min-width:110px;">부가세</th>
                  <th class="right" style="min-width:140px;">총액</th>
                  <th class="right" style="min-width:140px;">미정산(잔액)</th>
                                    <th style="min-width:120px;">세금계산서</th>
                  <th style="min-width:140px;">번호(선택)</th>
                  <th style="min-width:240px;">메모</th>
                </tr>
              </thead>
              <tbody id="monthBody"></tbody>
            </table>
          </div>
        </div>
      
</section>


      <!-- EXCEL INPUT -->
      <section class="panel" id="view-excel" style="display:none;">
        <h2>엑셀입력 (다건 입력/붙여넣기)</h2>

        <div class="card">
          <div class="toolbar">
            <div class="left">
              <span class="badge b-pri">빠른 입력 그리드</span>
              <span class="note">Tab/Enter로 이동. 행 저장하면 즉시 반영.</span>
            </div>
            <div class="right">
              <button class="btn" id="btnAddRows">행 10개 추가</button>
              <button class="btn" id="btnFillDown">스마트 채우기</button>
              <button class="btn pri" id="btnSaveRows">입력행 저장</button>
            </div>
            <!-- Autocomplete lists (powered by Master data) -->
            <datalist id="dlParties"></datalist>
            <datalist id="dlItems"></datalist>
            <datalist id="dlProjects"></datalist>

          </div>

          <div class="note" style="margin-top:8px;">
            - 구분: 매출 / 매입 / 경비 / 수금 / 지급 (내부코드: SALE/PURCHASE/EXPENSE/RECEIPT/PAYMENT도 인식)<br/>
            - 부가세: 총액(포함) / 별도 / 면세 (내부코드: INCLUDED/EXCLUDED/ZERO도 인식)<br/>
            - 거래처/프로젝트/품목은 이름으로 입력하면 없을 시 자동 생성.
          </div>

          <div class="hr"></div>

          <div class="gridwrap">
            <table class="txgrid" id="excelTable">
              <thead>
                <tr>
                  <th style="min-width:120px;">일자</th>
                  <th style="min-width:120px;">구분</th>
                  <th style="min-width:200px;">거래처(명)</th>
                  <th style="min-width:200px;">프로젝트(명)</th>
                  <th style="min-width:200px;">품목(명)</th>
                  <th style="min-width:90px;" class="right">수량</th>
                  <th style="min-width:110px;" class="right">단가</th><th style="min-width:140px;" class="right">합계</th>
                  <th style="min-width:110px;">부가세</th>
                  <th style="min-width:120px;">세금계산서</th>
                  <th style="min-width:140px;">번호(선택)</th>
                  <th style="min-width:260px;">메모</th>
                  <th style="min-width:90px;" class="right">삭제</th>
                </tr>
              </thead>
              <tbody id="excelBody"></tbody>
            </table>
          </div>
          <div class="hr"></div>
          <div class="toolbar">
            <div class="left">
              <span class="badge">하단 패널</span>
              <span class="note">거래처 미수/미지급, 붙여넣기, 선택월 상세 등을 접을 수 있습니다.</span>
            </div>
            <div class="right">
              <button class="btn" id="btnExcelExtrasToggle">하단 패널 펼치기</button>
            </div>
          </div>
          <div id="excelExtras" style="display:none;">

        
        <div class="row">
          <div class="col card">
            <div class="toolbar">
              <div class="left">
                <span class="badge b-ok">거래처별 미수/미지급(항상)</span>
                <span class="pill">AR(미수): <b id="dashARTotal">0</b></span>
                <span class="pill">AP(미지급): <b id="dashAPTotal">0</b></span>
              </div>
              <div class="right">
                <input id="dashARAPText" class="miniInput" placeholder="검색: 거래처명" />
                <span class="note">자동상계 금지(표시만)</span>
              </div>
            </div>
            <div class="gridwrap">
              <table class="txgrid">
                <thead>
                  <tr>
                    <th style="min-width:220px">거래처</th>
                    <th class="right" style="min-width:160px">AR(미수)</th>
                    <th class="right" style="min-width:160px">AP(미지급)</th>
                    <th class="right" style="min-width:160px">순합(표시)</th>
                  </tr>
                </thead>
                <tbody id="dashARAPBody"></tbody>
              </table>
            </div>
          </div>
        </div>

</div>

        <div class="hr"></div>

        <div class="card" style="margin-top:12px;">
          <div class="toolbar">
            <div class="left">
              <span class="badge b-pri">선택월 거래내역(상세)</span>
              <input class="in" type="month" id="excelMonthPick" style="width:170px;">
              <button class="btn" id="btnExcelMonthNow">이번달</button>
              <button class="btn" id="btnExcelMonthRefresh">새로고침</button>
            </div>
            <div class="right">
              <button class="btn" id="btnOpenMonthView">전체화면</button>
            </div>
          </div>
          <div class="gridwrap">
            <table class="txgrid">
              <thead>
                <tr>
                  <th style="min-width:110px;">일자</th><th>구분</th><th>거래처</th><th>프로젝트</th><th>품목</th>
                  <th class="right">수량</th><th class="right">단가</th><th class="right">총액</th>
                  <th class="right">미정산</th><th>세금계산서</th><th>메모</th>
                </tr>
              </thead>
              <tbody id="excelMonthBody"></tbody>
            </table>
          </div>
        </div>

          </div>
</section>

      <!-- SEARCH / COMBO -->
      <section class="panel" id="view-search" style="display:none;">
        <h2>검색/조합 (미정산 필터 포함)</h2>
        <div class="card">
          <div class="toolbar">
            <div class="left">
              <span class="badge b-pri">조합 필터</span>
              <span class="note">미정산(잔액&gt;0) / 미발행(매출+매입) / 매출·매입·수금·지급 조합</span>
            </div>
            <div class="right">
              <button class="btn" id="btnExportCsv">CSV(현재결과)</button>
            </div>
          </div>

          <div class="hr"></div>

          <div class="form">
            <div class="f3"><label>기간 From</label><input type="date" id="qFrom"></div>
            <div class="f3"><label>기간 To</label><input type="date" id="qTo"></div>
            <div class="f3"><label>거래처</label><select id="qParty"></select></div>
            <div class="f3"><label>프로젝트</label><select id="qProject"></select></div>
            <div class="f3"><label>품목</label><select id="qItem"></select></div>

            <div class="f4">
              <label>구분(다중)</label>
              <div class="card" style="padding:10px;">
                <div class="row" style="gap:8px;">
                  <label class="tiny"><input type="checkbox" class="qType" value="SALE" checked> 매출</label>
                  <label class="tiny"><input type="checkbox" class="qType" value="PURCHASE" checked> 매입</label>
                  <label class="tiny"><input type="checkbox" class="qType" value="EXPENSE" checked> 경비</label>
                  <label class="tiny"><input type="checkbox" class="qType" value="RECEIPT" checked> 수금</label>
                  <label class="tiny"><input type="checkbox" class="qType" value="PAYMENT" checked> 지급</label>
                  <label class="tiny"><input type="checkbox" class="qType" value="OFFSET" checked> 상계(수동)</label>
                </div>
              </div>
            </div>

            <div class="f4"><label>세금계산서(매출/매입/경비)</label>
              <select id="qInvoice">
                <option value="">전체</option>
                <option value="Y">발행</option>
                <option value="N">미발행</option>
              </select>
            </div>

            <div class="f4"><label>정산상태(매출/매입/경비)</label>
              <select id="qSettle">
                <option value="">전체</option>
                <option value="OPEN">미정산(잔액&gt;0)</option>
                <option value="CLOSED">정산완료(잔액=0)</option>
              </select>
            </div>

            <div class="f6"><label>검색어(메모/품목/거래처/계산서번호(선택))</label>
              <input id="qText" placeholder="예: 12월 / 파워 / 2025-12-001 / 운송비">
            </div>
            <div class="f3"><label>금액 최소</label><input type="number" id="qMin" placeholder="예: 100000"></div>
            <div class="f3"><label>금액 최대</label><input type="number" id="qMax" placeholder="예: 3000000"></div>

            <div class="f12">
              <label>빠른 조합</label>
              <div class="row">
                <button class="btn" id="quickUninvoicedSales">미발행(매출+매입)</button>
                <button class="btn" id="quickOpenSales">미정산 매출</button>
                <button class="btn" id="quickOpenPurch">미정산 매입/경비</button>
                <button class="btn" id="quickSalesOnly">매출만</button>
                <button class="btn" id="quickPurchOnly">매입만</button>
                <button class="btn" id="quickReceiptsOnly">수금만</button>
                <button class="btn" id="quickPaymentsOnly">지급만</button>
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="toolbar">
            <div class="left">
              <span class="badge">결과</span>
              <span class="note" id="qCount">0건</span>
              <label class="mini" style="margin-left:10px;">정렬
                <select id="qSort" style="margin-left:6px;">
                  <option value="DATE_ASC_INPUT">날짜↑ · 입력순</option>
                  <option value="DATE_DESC_INPUT">날짜↓ · 입력순</option>
                  <option value="DATE_ASC_FLOW">날짜↑ · 흐름(매입→매출)</option>
                  <option value="DATE_DESC_FLOW">날짜↓ · 흐름(매입→매출)</option>
                </select>
              </label>
              <span class="note" id="qSortHint"></span>

              <span class="note">* 행 클릭 → <b>오른쪽 편집 패널</b>에서 수정/삭제 (체크박스는 합계용)</span>
            </div>
            <div class="right" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
              <span class="pill">선택 <b id="qSelCnt">0</b>건 / 합계 <b id="qSelSum">0</b></span>
              <button class="btn" id="qSelClear">선택해제</button>
              <button class="btn" id="btnGoLedgerFromSel">선택 원장</button>
              <button class="btn" id="btnExportSelCsv">선택 CSV</button>
              <button class="btn danger" id="btnDeleteOne" disabled>선택 1건 삭제</button>
            </div>
          </div>

          <div class="gridwrap">
            <table class="txgrid">
              <thead>
                <tr>
                  <th style="width:86px;"><label class="tiny" style="display:flex;gap:6px;align-items:center;"><input type="checkbox" id="qSelAll">선택</label></th>
                  <th>일자</th><th>구분</th><th>거래처</th><th>프로젝트</th><th>품목</th>
                  <th class="right">수량</th>
                  <th class="right">단가</th>
                  <th class="right">총액</th>
                  <th class="right">정산(누적)</th>
                  <th class="right">정산(잔액)</th>
                  <th>세금계산서</th><th>번호</th><th>메모</th>
                </tr>
              </thead>
              <tbody id="qBody"></tbody>
            </table>
          </div>

          <div class="hr"></div>

          <div class="card">
            <div class="toolbar">
              <div class="left">
                <span class="badge b-warn">선택 거래 수정</span>
                <span class="note">간단 수정 후 저장</span>
              </div>
              <div class="right">
                <button class="btn pri" id="btnSaveEdit">수정 저장</button>
                  <button class="btn danger" id="btnDeleteEdit">삭제</button>
              </div>
            </div>
            <div class="form" style="margin-top:10px;">
              <div class="f3"><label>일자</label><input type="date" id="eDate"></div>
              <div class="f3"><label>구분</label>
                <select id="eType">
                  <option value="SALE">매출</option><option value="PURCHASE">매입</option><option value="EXPENSE">경비</option>
                  <option value="RECEIPT">수금</option><option value="PAYMENT">지급</option>
                  <option value="OFFSET">상계(수동)</option>
                </select>
              </div>
              <div class="f3"><label>거래처</label><select id="eParty"></select></div>
              <div class="f3"><label>프로젝트</label><select id="eProject"></select></div>
              <div class="f6"><label>품목</label><select id="eItem"></select></div>
              <div class="f6"><label>수량</label><input type="number" id="eQty"></div>

              <div class="f6"><label>단가</label>
                <div class="miniActBtnRow">
                  <input type="number" id="eUnit" placeholder="단가">
                  <button type="button" class="btn miniActBtn" id="btnEUnitMul" title="별도→포함(×1.1)">×1.1</button>
                  <button type="button" class="btn miniActBtn" id="btnEUnitDiv" title="포함→별도(÷1.1)">÷1.1</button>
                </div>
              </div>
              <div class="f6"><label>금액(공급/총)</label><input type="number" id="eAmount"></div>
              <div class="f3"><label>부가세</label>
                <select id="eVat"><option value="INCLUDED">총액(포함)</option><option value="EXCLUDED">공급가(별도)</option><option value="ZERO">면세</option></select>
              </div>
              <div class="f3"><label>세금계산서</label>
                <select id="eInv"><option value="N">미발행</option><option value="Y">발행</option></select>
              </div>
              <div class="f3"><label>계산서번호(선택)</label><input id="eInvNo"></div>
              <div class="f12"><label>메모</label><input id="eMemo"></div>
            </div>
            <div class="note" style="margin-top:8px;">
              <span class="dangerText">반품/차감/에누리</span>는 금액을 <b>마이너스</b>로 입력하면 됩니다.<br/>
              이미 정산(매칭)된 건의 금액을 크게 바꾸면 잔액이 뒤틀릴 수 있으니, 필요 시 정산내역을 먼저 삭제하세요.
            </div>
          </div>

        </div>
      </section>

      <!-- SETTLEMENT -->
      <section class="panel" id="view-settle" style="display:none;">
        <h2>정산/매칭 (수금↔매출, 지급↔매입/경비) + 수동 상계</h2>

        <div class="card">
          <div class="form">
            <div class="f4"><label>거래처</label><select id="sParty"></select></div>
            <div class="f4"><label>모드</label>
              <select id="sMode">
                <option value="AR">수금 → 매출 정산(AR)</option>
                <option value="AP">지급 → 매입/경비 정산(AP)</option>
                <option value="OFFSET">수동 상계(AR ↔ AP)</option>
              </select>
            </div>
            <div class="f4"><label>자동정산 규칙</label>
              <select id="sAutoRule">
                <option value="FIFO">오래된 건부터(FIFO)</option>
                <option value="LIFO">최신 건부터(LIFO)</option>
              </select>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div class="col card kpi">
              <div class="label">해당 거래처 미수(AR 잔액)</div>
              <div class="value" id="sArOpen">0</div>
              <div class="hint">매출 잔액 합계 (수금/상계로만 감소)</div>
            </div>
            <div class="col card kpi">
              <div class="label">해당 거래처 미지급(AP 잔액)</div>
              <div class="value" id="sApOpen">0</div>
              <div class="hint">매입+경비 잔액 합계 (지급/상계로만 감소)</div>
            </div>
            <div class="col card kpi">
              <div class="label">원칙</div>
              <div class="value">자동 상계 금지</div>
              <div class="hint">OFFSET 모드에서만 수동 상계 처리</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="toolbar">
            <div class="left">
              <span class="badge b-pri">자동 정산</span>
              <span class="note">AR: 수금→매출 / AP: 지급→매입·경비</span>
            </div>
            <div class="right">
              <button class="btn" id="btnAutoSettle">자동 정산 실행</button>
              <button class="btn danger" id="btnUnallocateAll">이 거래처 정산 전체 해제</button>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div class="col card">
              <div class="toolbar">
                <div class="left">
                  <span class="badge b-ok" id="sPayTitle">원천(미배분)</span>
                  <span class="note">원천 1건 선택</span>
                </div>
              </div>
              <div class="gridwrap" style="margin-top:10px;">
                <table class="txgrid">
                  <thead>
                    <tr><th>일자</th><th>구분</th><th class="right">총액</th><th class="right">배분</th><th class="right">잔액</th><th>메모</th></tr>
                  </thead>
                  <tbody id="sPayBody"></tbody>
                </table>
              </div>
              <div class="note" style="margin-top:8px;">
                * OFFSET 모드에서는 원천이 자동 생성됩니다(상계금액 입력 후 실행).
              </div>
            </div>

            <div class="col card">
              <div class="toolbar">
                <div class="left">
                  <span class="badge b-warn" id="sInvTitle">대상(미정산)</span>
                  <span class="note">대상 1건 선택</span>
                </div>
              </div>

              <div class="gridwrap" style="margin-top:10px;">
                <table class="txgrid">
                  <thead>
                    <tr>
                      <th>일자</th><th>구분</th><th class="right">총액</th><th class="right">정산</th><th class="right">잔액</th>
                      <th>번호</th><th>메모</th><th class="right">AR/AP</th>
                    </tr>
                  </thead>
                  <tbody id="sInvBody"></tbody>
                </table>
              </div>

              <div class="hr"></div>

              <div class="toolbar">
                <div class="left">
                  <span class="badge">수동 배분/상계</span>
                  <span class="note">AR/AP: 원천+대상 선택 / OFFSET: 금액만</span>
                </div>
                <div class="right">
                  <input type="number" id="sManualAmt" placeholder="금액" style="width:160px;">
                  <button class="btn pri" id="btnManualAllocate">실행</button>
                </div>
              </div>

              <div class="note" style="margin-top:8px;">
                - OFFSET 모드는 <b>AR 잔액</b>과 <b>AP 잔액</b>을 동시에 줄입니다(수동 상계).<br/>
                - 같은 거래처라도 자동으로 서로 상계하지 않으며, 이 기능은 “필요할 때만” 사용.
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="card">
            <div class="toolbar">
              <div class="left">
                <span class="badge b-danger">정산 내역(배분 로그)</span>
                <span class="note">삭제하면 잔액이 즉시 변경</span>
              </div>
            </div>
            <div class="gridwrap" style="margin-top:10px;">
              <table class="txgrid">
                <thead><tr><th>일자</th><th>원천</th><th>대상</th><th class="right">배분금액</th><th>비고</th><th class="right">삭제</th></tr></thead>
                <tbody id="sAllocBody"></tbody>
              </table>
            </div>
          </div>

        </div>
      </section>

      <!-- AR/AP -->
      <section class="panel" id="view-arap" style="display:none;">
        <h2>거래처별 미수/미지급 (자동상계 금지)</h2>

        <div class="card" style="margin:10px 0;">
          <div class="toolbar">
            <div class="left">
              <span class="badge b-pri">기간</span>
              <input type="date" id="arapFrom" style="width:160px;">
              <input type="date" id="arapTo" style="width:160px;">
              <button class="btn" id="arapThisMonth">이번달</button>
              <button class="btn" id="arapLastMonth">지난달</button>
              <button class="btn" id="arapThisYear">올해</button>
              <select id="arapBasis" style="width:220px;">
                <option value="ASOF" selected>기간말 잔액(해당기간 계산서 잔액)</option>
                <option value="FLOW">기간 발생(매출-수금 / 매입+경비-지급)</option>
              </select>
            </div>
            <div class="right">
              <span class="pill">기간 AR: <b id="arapPeriodAR">0</b></span>
              <span class="pill">기간 AP: <b id="arapPeriodAP">0</b></span>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col card kpi"><div class="label">전체 미수(AR 잔액)</div><div class="value" id="kpiAR">0</div><div class="hint">매출 잔액 합계</div></div>
          <div class="col card kpi"><div class="label">전체 미지급(AP 잔액)</div><div class="value" id="kpiAP">0</div><div class="hint">매입+경비 잔액 합계</div></div>
          <div class="col card kpi"><div class="label">참고</div><div class="value">순합은 표시만</div><div class="hint">정산에 자동 반영 안함</div></div>
        
        <div class="row">
          <div class="col card">
            <div class="toolbar">
              <div class="left">
                <span class="badge b-ok">거래처별 미수/미지급(항상)</span>
                <span class="pill">AR(미수): <b id="dashARTotal">0</b></span>
                <span class="pill">AP(미지급): <b id="dashAPTotal">0</b></span>
              </div>
              <div class="right">
                <input id="dashARAPText" class="miniInput" placeholder="검색: 거래처명" />
                <span class="note">자동상계 금지(표시만)</span>
              </div>
            </div>
            <div class="gridwrap">
              <table class="txgrid">
                <thead>
                  <tr>
                    <th style="min-width:220px">거래처</th>
                    <th class="right" style="min-width:160px">AR(미수)</th>
                    <th class="right" style="min-width:160px">AP(미지급)</th>
                    <th class="right" style="min-width:160px">순합(표시)</th>
                  </tr>
                </thead>
                <tbody id="dashARAPBody"></tbody>
              </table>
            </div>
          </div>
        </div>

</div>

        <div class="hr"></div>

        <div class="card">
          <div class="toolbar">
            <div class="left">
              <span class="badge">거래처별 잔액(분리)</span>
              <input id="arapText" placeholder="검색: 거래처명" style="width:220px;">
              <button class="btn" id="btnGoSettle2">선택 거래처 정산</button>
            </div>
            <div class="right">
              <span class="note">AR/AP를 분리 표시</span>
            </div>
          </div>

          <div class="gridwrap" style="margin-top:10px;">
            <table>
              <thead><tr><th>거래처</th><th class="right">AR(미수)</th><th class="right">AP(미지급)</th><th class="right">순합(표시만)</th></tr></thead>
              <tbody id="arapBody"></tbody>
            </table>
          </div>
        </div>
      </section>


<!-- PROJECT -->
      <section class="panel" id="view-proj" style="display:none;">
        <h2>프로젝트 손익(월/연)</h2>
        <div class="card">
          <div class="toolbar">
            <div class="left">
              <span class="badge b-ok">월</span>
              <input type="month" id="pmMonth">
              <select id="pmProject"></select>
              <button class="btn" id="btnRunPm">조회</button>
              <button class="btn" id="btnPmToggleDetail">상세: 숨김</button>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div class="col card kpi"><div class="label">월 매출</div><div class="value" id="pmSales">0</div></div>
            <div class="col card kpi"><div class="label">월 비용(매입+경비)</div><div class="value" id="pmCost">0</div></div>
            <div class="col card kpi"><div class="label">월 이익</div><div class="value" id="pmProfit">0</div></div>
            <div class="col card kpi"><div class="label">이익률</div><div class="value" id="pmMargin">0%</div></div>
          </div>

          <div class="hr"></div>


          <div class="card" id="pmSplitCard" style="margin-top:12px;">
            <div class="toolbar">
              <div class="left">
                <span class="badge b-ok">이달 손익 요약</span>
                <span class="note">프로젝트 지정/미지정/전체 합계</span>
              </div>
            </div>
            <div class="note">* '프로젝트 합계'는 프로젝트가 지정된 거래만, '미지정 합계'는 프로젝트가 비어있는 거래만 집계합니다. (매출 - (매입+경비))</div>
            <div class="table-wrap" style="margin-top:8px;">
              <table class="grid">
                <thead>
                  <tr>
                    <th>구분</th>
                    <th class="right">매출</th>
                    <th class="right">비용(매입+경비)</th>
                    <th class="right">이익</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><b>프로젝트 합계</b></td>
                    <td class="right mono" id="pmPSales">0</td>
                    <td class="right mono" id="pmPCost">0</td>
                    <td class="right mono" id="pmPProfit">0</td>
                  </tr>
                  <tr>
                    <td><b>미지정 합계</b></td>
                    <td class="right mono" id="pmNSales">0</td>
                    <td class="right mono" id="pmNCost">0</td>
                    <td class="right mono" id="pmNProfit">0</td>
                  </tr>
                  <tr>
                    <td><b>전체 합계</b></td>
                    <td class="right mono" id="pmTSales">0</td>
                    <td class="right mono" id="pmTCost">0</td>
                    <td class="right mono" id="pmTProfit">0</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>


          <div class="card" id="pmAllCard" style="margin-top:12px;">
            <div class="toolbar">
              <div class="left">
                <span class="badge b-pri">프로젝트 요약(월)</span>
                <span class="note">프로젝트 미선택 시 전체 프로젝트를 이익 순으로 표시</span>
              </div>
              <div class="right">
                <span class="note">프로젝트 클릭 → 검색/조합 이동</span>
              </div>
            </div>
            <div class="gridwrap" style="margin-top:10px;">
              <table class="txgrid">
                <thead><tr><th>프로젝트</th><th class="right">매출</th><th class="right">비용</th><th class="right">이익</th><th class="right">이익률</th></tr></thead>
                <tbody id="pmAllBody"></tbody>
              </table>
            </div>
          </div>
          
          <div class="card" id="pmStatusCard" style="margin-top:12px; display:none;">
            <div class="toolbar">
              <div class="left">
                <span class="badge b-pri">프로젝트 상태</span>
                <span class="note" id="pmStatusTitle"></span>
              </div>
            </div>
            <div class="row" style="margin-top:10px;">
              <div class="col card kpi"><div class="label">미발행 매출</div><div class="value" id="pmUninvSales">0</div><div class="hint">건수: <b id="pmUninvSalesCnt">0</b></div></div>
              <div class="col card kpi"><div class="label">미발행 매입/경비</div><div class="value" id="pmUninvCost">0</div><div class="hint">건수: <b id="pmUninvCostCnt">0</b></div></div>
              <div class="col card kpi"><div class="label">미수(프로젝트)</div><div class="value" id="pmAROpen">0</div><div class="hint">매출 잔액 합</div></div>
              <div class="col card kpi"><div class="label">미지급(프로젝트)</div><div class="value" id="pmAPOpen">0</div><div class="hint">매입/경비 잔액 합</div></div>
            </div>
            <div class="hr"></div>
            <div class="gridwrap scrollY" style="max-height:520px;">
              <table class="txgrid">
                <thead><tr><th style="min-width:220px">거래처</th><th class="right" style="min-width:160px">미수(AR)</th><th class="right" style="min-width:160px">미지급(AP)</th><th class="right" style="min-width:160px">순합(표시)</th></tr></thead>
                <tbody id="pmPartyBody"></tbody>
              </table>
            </div>
            <div class="note" style="margin-top:8px;">* 거래처별 잔액 클릭 → 검색/조합 이동(프로젝트/거래처/미정산 필터 자동 적용)</div>
          </div>

          <div class="gridwrap scrollY" id="pmDetailWrap" style="display:none;">
            <table class="txgrid">
              <thead><tr><th>일자</th><th>구분</th><th>거래처</th><th>프로젝트</th><th>품목</th><th class="right">총액</th><th class="right">정산(잔액)</th><th>세금계산서</th><th>메모</th></tr></thead>
              <tbody id="pmBody"></tbody>
            </table>
          </div>

          <div class="hr"></div>

          <div class="toolbar">
            <div class="left">
              <span class="badge">연도 요약</span>
              <input type="number" id="pyYear" style="width:120px;">
              <button class="btn" id="btnRunPy">연도 집계</button>
            </div>
          </div>
          <div class="gridwrap" style="margin-top:10px;">
            <table>
              <thead><tr><th>월</th><th class="right">매출</th><th class="right">비용</th><th class="right">이익</th></tr></thead>
              <tbody id="pyBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      
      <!-- LEDGER -->
      <section class="panel" id="view-ledger" style="display:none;">
        <h2>거래처원장 (기간/출력)</h2>

        <div class="card">
          <div class="toolbar">
            <div class="left">
              <span class="badge b-pri">거래처</span>
              <select id="ledParty" style="width:220px;"></select>

              <span class="badge b-pri">기간</span>
              <input type="date" id="ledFrom" style="width:160px;">
              <input type="date" id="ledTo" style="width:160px;">
              <button class="btn" id="ledThisMonth">이번달</button>
              <button class="btn" id="ledLastMonth">지난달</button>

              <select id="ledMode" style="width:200px;">
                <option value="SALES">매출원장(매출+수금)</option>
                <option value="PURCHASE">매입원장(매입/경비+지급)</option>
                <option value="ALL">전체(모든 거래)</option>
              </select>

              <button class="btn" id="ledOnlyUninvoiced">미발행만</button>
              <button class="btn" id="ledOnlyOpen">미정산만</button>
              <select id="ledAged" style="width:150px;">
                <option value="">장기(전체)</option>
                <option value="30">30일+</option>
                <option value="60">60일+</option>
                <option value="90">90일+</option>
              </select>

              
              <span class="badge b-pri">기준월</span>
              <input type="month" id="ledMonth" style="width:170px;">
              <button class="btn" id="ledPrev">이전달</button>
              <button class="btn" id="ledNow">이번달</button>
              <button class="btn" id="ledNext">다음달</button>
<input id="ledQ" placeholder="프로젝트/품목/번호/메모 검색" style="width:260px;">
            </div>

            <div class="right">
              <span class="pill">매출 <b id="ledSales">0</b></span>
              <span class="pill">수금 <b id="ledRecv">0</b></span>
              <span class="pill">미수(표시) <b id="ledARFlow">0</b></span>

              <span class="pill">매입+경비 <b id="ledCost">0</b></span>
              <span class="pill">지급 <b id="ledPay">0</b></span>
              <span class="pill">미지급(표시) <b id="ledAPFlow">0</b></span>

              <button class="btn ok" id="btnLedAutoSettle">정산맞추고 출력</button>
              <button class="btn" id="btnLedCsv">CSV</button>
              <button class="btn" id="btnLedTsv">TSV</button>
            </div>
          </div>

          <div class="note" style="margin-top:8px;">
            - 매출원장: <b>매출+수금</b>을 함께 표시하고, 매출행에는 <b>정산/잔액/결제일</b>이 표시됩니다.<br/>
            - 매입원장: <b>매입/경비+지급</b>을 함께 표시하고, 매입/경비행에는 <b>정산/잔액/결제일</b>이 표시됩니다.<br/>
            - “정산맞추고 출력”은 선택 거래처에 대해 AR/AP 자동정산(FIFO)을 실행해 잔액을 현실화한 뒤 출력합니다(권장).
          </div>

          <div class="gridwrap" style="margin-top:10px;">
            <table class="txgrid">
              <thead>
                <tr>
                  <th style="min-width:110px;">일자</th>
                  <th style="min-width:90px;">구분</th>
                  <th style="min-width:180px;">거래처</th>
                  <th style="min-width:180px;">프로젝트</th>
                  <th style="min-width:220px;">품목</th>
                  <th class="right" style="min-width:90px;">수량</th>
                  <th class="right" style="min-width:110px;">단가</th>
                  <th class="right" style="min-width:120px;">공급가</th>
                  <th class="right" style="min-width:110px;">부가세</th>
                  <th class="right" style="min-width:140px;">총액</th>
                  <th class="right" style="min-width:140px;">정산(누적)</th>
                  <th class="right" style="min-width:140px;">잔액</th>
                  <th style="min-width:120px;">결제상태</th>
                  <th style="min-width:120px;">최근결제일</th>
                  <th style="min-width:120px;">계산서</th>
                  <th style="min-width:140px;">번호</th>
                  <th style="min-width:240px;">메모</th>
</tr>
              </thead>
              <tbody id="ledBody"></tbody>
            </table>
          </div>
        </div>
      
        <div class="card" style="margin-top:12px;">
          <div class="toolbar">
            <div class="left">
              <span class="badge b-pri">연도</span>
              <input type="number" id="ledYear" style="width:120px;">
              <button class="btn" id="ledYearRun">월별 집계</button>
              <span class="note">행 클릭 → 해당 월 원장으로 이동</span>
            </div>
            <div class="right">
              <span class="pill">연매출 <b id="ledYearSales">0</b></span>
              <span class="pill">연비용 <b id="ledYearCost">0</b></span>
              <span class="pill">연이익 <b id="ledYearProfit">0</b></span>
            </div>
          </div>
          <div class="gridwrap" style="margin-top:10px;">
            <table class="txgrid">
              <thead>
                <tr>
                  <th style="min-width:110px;">월</th>
                  <th class="right" style="min-width:140px;">매출</th>
                  <th class="right" style="min-width:140px;">매입+경비</th>
                  <th class="right" style="min-width:140px;">이익</th>
                  <th class="right" style="min-width:140px;">수금</th>
                  <th class="right" style="min-width:140px;">지급</th>
                  <th class="right" style="min-width:140px;">순현금(수금-지급)</th>
                </tr>
              </thead>
              <tbody id="ledYearBody"></tbody>
            </table>
          </div>
        </div>
</section>

<!-- BASE -->
      <section class="panel" id="view-base" style="display:none;">
        <h2>기초자산/계정(통장·대출)</h2>
        <div class="card">
          <div class="note">
            - BANK: 기초잔액 + (수금-지급) 누적(간이) 표시<br/>
            - LOAN: 기초잔액(부채)로 순자산 계산에 반영<br/>
            - 순자산(간이): BANK현재합 - LOAN기초합 + AR - AP
          </div>
          <div class="hr"></div>

          <div class="form">
            <div class="f3"><label>유형</label>
              <select id="aType"><option value="BANK">BANK(통장/현금)</option><option value="LOAN">LOAN(대출)</option><option value="OTHER">OTHER</option></select>
            </div>
            <div class="f6"><label>계정명</label><input id="aName" placeholder="예: 기업은행 / 현금 / 운영자금대출"></div>
            <div class="f3"><label>기초잔액</label><input type="number" id="aOpen" placeholder="예: 5000000"></div>
            <div class="f12"><button class="btn pri" id="btnAddAcc">계정 추가</button></div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div class="col card kpi"><div class="label">BANK 현재합(간이)</div><div class="value" id="bankSum">0</div><div class="hint">기초 + (수금-지급)</div></div>
            <div class="col card kpi"><div class="label">LOAN 기초합</div><div class="value" id="loanSum">0</div><div class="hint">부채</div></div>
            <div class="col card kpi"><div class="label">순자산(간이)</div><div class="value" id="netWorth">0</div><div class="hint">BANK - LOAN + AR - AP</div></div>
          </div>

          <div class="hr"></div>

          <div class="gridwrap">
            <table>
              <thead><tr><th>유형</th><th>계정명</th><th class="right">기초잔액</th><th class="right">현재(간이)</th><th class="right">삭제</th></tr></thead>
              <tbody id="accBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- MASTER -->
      <section class="panel" id="view-master" style="display:none;">
        <h2>마스터(거래처/프로젝트/품목)</h2>

        <div class="row">
          <div class="col card">
            <div class="toolbar">
              <div class="left"><span class="badge">거래처</span></div>
              <div class="right">
                <input id="mParty" placeholder="거래처명" style="width:220px;">
                <button class="btn pri" id="btnAddParty">추가</button>
              </div>
            </div>
            <div class="gridwrap" style="margin-top:10px;">
              <table><thead><tr><th>거래처명</th><th class="right">삭제</th></tr></thead><tbody id="partyBody"></tbody></table>
            </div>
          </div>

          <div class="col card">
            <div class="toolbar">
              <div class="left"><span class="badge">프로젝트</span></div>
              <div class="right">
                <input id="mProj" placeholder="프로젝트명" style="width:220px;">
                <button class="btn pri" id="btnAddProj">추가</button>
              </div>
            </div>
            <div class="gridwrap" style="margin-top:10px;">
              <table><thead><tr><th>프로젝트명</th><th class="right">삭제</th></tr></thead><tbody id="projBody"></tbody></table>
            </div>
          </div>

          <div class="col card">
            <div class="toolbar">
              <div class="left"><span class="badge">품목</span></div>
              <div class="right">
                <input id="mItem" placeholder="품목명" style="width:220px;">
                <button class="btn pri" id="btnAddItem">추가</button>
              </div>
            </div>
            <div class="gridwrap" style="margin-top:10px;">
              <table><thead><tr><th>품목명</th><th class="right">삭제</th></tr></thead><tbody id="itemBody"></tbody></table>
            </div>
          </div>
        
        <div class="row">
          <div class="col card">
            <div class="toolbar">
              <div class="left">
                <span class="badge b-ok">거래처별 미수/미지급(항상)</span>
                <span class="pill">AR(미수): <b id="dashARTotal">0</b></span>
                <span class="pill">AP(미지급): <b id="dashAPTotal">0</b></span>
              </div>
              <div class="right">
                <input id="dashARAPText" class="miniInput" placeholder="검색: 거래처명" />
                <span class="note">자동상계 금지(표시만)</span>
              </div>
            </div>
            <div class="gridwrap">
              <table class="txgrid">
                <thead>
                  <tr>
                    <th style="min-width:220px">거래처</th>
                    <th class="right" style="min-width:160px">AR(미수)</th>
                    <th class="right" style="min-width:160px">AP(미지급)</th>
                    <th class="right" style="min-width:160px">순합(표시)</th>
                  </tr>
                </thead>
                <tbody id="dashARAPBody"></tbody>
              </table>
            </div>
          </div>
        </div>

</div>

        <div class="hr"></div>
        <div class="note">엑셀입력에서 이름으로 입력하면 없을 경우 자동 생성됩니다.</div>
<div class="hr"></div>
<div class="card">
  <div class="toolbar">
    <div class="left"><span class="badge b-warn">중복 점검</span><span class="note">공백/특수문자 차이를 무시하고 중복을 찾아줍니다(삭제는 수동)</span></div>
    <div class="right">
      <button class="btn" id="btnDedupParties">거래처 중복보기</button>
      <button class="btn" id="btnDedupProjects">프로젝트 중복보기</button>
      <button class="btn" id="btnDedupItems">품목 중복보기</button>
    </div>
  </div>
  <textarea id="dedupResult" placeholder="중복 점검 결과가 여기에 표시됩니다." style="min-height:160px;"></textarea>
</div>
      </section>

    </div>
  </div>
</main>

<script>
(async () => {
  "use strict";

  const LS = "makefree_erp_ultimate_v20251224";

  // ===== IndexedDB 저장소 (장기운영용) =====
  const DB_NAME = "makefree_erp_ultimate_idb";
  const DB_VER = 1;
  const DB_STORE = "kv"; // {k, v, ts}

  let __dbp = null;

  function idbOpen(){
    if(__dbp) return __dbp;
    __dbp = new Promise((resolve, reject)=>{
      try{
        const req = indexedDB.open(DB_NAME, DB_VER);
        req.onupgradeneeded = ()=>{
          const db = req.result;
          if(!db.objectStoreNames.contains(DB_STORE)){
            db.createObjectStore(DB_STORE, { keyPath:"k" });
          }
        };
        req.onsuccess = ()=> resolve(req.result);
        req.onerror = ()=> reject(req.error || new Error("IndexedDB open failed"));
      }catch(e){ reject(e); }
    });
    return __dbp;
  }

  async function idbGet(k){
    const db = await idbOpen();
    return await new Promise((resolve, reject)=>{
      try{
        const tx = db.transaction(DB_STORE, "readonly");
        const st = tx.objectStore(DB_STORE);
        const req = st.get(k);
        req.onsuccess = ()=> resolve(req.result || null);
        req.onerror = ()=> reject(req.error || new Error("IndexedDB get failed"));
      }catch(e){ reject(e); }
    });
  }

  async function idbSet(k, v){
    const db = await idbOpen();
    return await new Promise((resolve, reject)=>{
      try{
        const tx = db.transaction(DB_STORE, "readwrite");
        const st = tx.objectStore(DB_STORE);
        const req = st.put({ k, v, ts: Date.now() });
        req.onsuccess = ()=> resolve(true);
        req.onerror = ()=> reject(req.error || new Error("IndexedDB put failed"));
      }catch(e){ reject(e); }
    });
  }

  async function idbDel(k){
    const db = await idbOpen();
    return await new Promise((resolve, reject)=>{
      try{
        const tx = db.transaction(DB_STORE, "readwrite");
        const st = tx.objectStore(DB_STORE);
        const req = st.delete(k);
        req.onsuccess = ()=> resolve(true);
        req.onerror = ()=> reject(req.error || new Error("IndexedDB delete failed"));
      }catch(e){ reject(e); }
    });
  }


  // ===== Excel Input Draft Auto-저장 (임시저장) =====
  // Purpose: prevent data loss while typing in Excel-style grid.
  // This does NOT commit transactions automatically; "행 저장" is still the confirm step.
  const LS_EXCEL_DRAFT = LS + "_excel_draft_v1";
  let excelDraftTimer = null;

  function setDraftPill(on, detail=""){
    const pill = $("excelDraftPill");
    if(!pill) return;
    pill.textContent = "임시저장: " + (on ? "ON" : "OFF");
    pill.style.borderColor = on ? "rgba(5,150,105,.25)" : "rgba(220,38,38,.25)";
    pill.style.background = on ? "rgba(5,150,105,.08)" : "rgba(220,38,38,.08)";
    pill.style.color = on ? "var(--ok)" : "var(--danger)";
    if(detail) pill.title = detail;
  }

  function saveExcelDraftNow(reason=""){
    try{
      localStorage.setItem(LS_EXCEL_DRAFT, JSON.stringify({ ts: Date.now(), excelRows }));
      setDraftPill(true, reason ? ("임시저장 완료: " + reason) : "임시저장 완료");
    }catch(e){
      // storage full or blocked
      setDraftPill(false, "임시저장 실패(저장공간/권한 확인)");
    }
  }

  function saveExcelDraftDebounced(reason="입력"){
    if(excelDraftTimer) clearTimeout(excelDraftTimer);
    excelDraftTimer = setTimeout(()=> saveExcelDraftNow(reason), 500);
  }

  function loadExcelDraft(){
    try{
      const raw = localStorage.getItem(LS_EXCEL_DRAFT);
      if(!raw) return false;
      const obj = JSON.parse(raw);
      if(!obj || !Array.isArray(obj.excelRows)) return false;
      excelRows = obj.excelRows;
      setDraftPill(true, "임시저장 불러옴 · " + new Date(obj.ts||Date.now()).toLocaleString("ko-KR"));
      return true;
    }catch(e){
      return false;
    }
  }

  function clearExcelDraft(){
    try{ localStorage.removeItem(LS_EXCEL_DRAFT); }catch(e){}
    setDraftPill(false, "임시저장 삭제됨");
    toast("임시저장 삭제");
  }

  // ===== Folder Auto Backup (Chromium File System Access API) =====
  // Notes:
  // - Works only in secure contexts: https:// or http://localhost (NOT file://).
  // - Supported in Chromium-based browsers (Chrome/Edge/Whale). Safari/Firefox: not supported.
  const FS_DB = "mf_erp_fs";
  const FS_STORE = "kv";
  const FS_KEY_DIR = "backupDirHandle";
  let autoBackupDirHandle = null;
  let autoBackupEnabled = false;
  let autoBackupTimer = null;
  let autoBackupBusy = false;

  function setAutoBackupUI(status, detail=""){
    const pill = $("autoBackupPill");
    if(!pill) return;
    pill.textContent = "자동백업: " + status;
    pill.style.borderColor = status==="ON" ? "rgba(5,150,105,.25)" : "rgba(220,38,38,.25)";
    pill.style.background = status==="ON" ? "rgba(5,150,105,.08)" : "rgba(220,38,38,.08)";
    pill.style.color = status==="ON" ? "var(--ok)" : "var(--danger)";
    if(detail) pill.title = detail;
  }

  function fsIdbOpen(){
    return new Promise((resolve,reject)=>{
      const req = indexedDB.open(FS_DB, 1);
      req.onupgradeneeded = ()=>{
        const db = req.result;
        if(!db.objectStoreNames.contains(FS_STORE)) db.createObjectStore(FS_STORE);
      };
      req.onsuccess = ()=> resolve(req.result);
      req.onerror = ()=> reject(req.error);
    });
  }
  async function fsIdbGet(key){
    const db = await fsIdbOpen();
    return new Promise((resolve,reject)=>{
      const tx = db.transaction(FS_STORE, "readonly");
      const st = tx.objectStore(FS_STORE);
      const rq = st.get(key);
      rq.onsuccess = ()=> resolve(rq.result ?? null);
      rq.onerror = ()=> reject(rq.error);
    });
  }
  async function fsIdbSet(key, val){
    const db = await fsIdbOpen();
    return new Promise((resolve,reject)=>{
      const tx = db.transaction(FS_STORE, "readwrite");
      const st = tx.objectStore(FS_STORE);
      const rq = st.put(val, key);
      rq.onsuccess = ()=> resolve(true);
      rq.onerror = ()=> reject(rq.error);
    });
  }
  async function fsIdbDel(key){
    const db = await fsIdbOpen();
    return new Promise((resolve,reject)=>{
      const tx = db.transaction(FS_STORE, "readwrite");
      const st = tx.objectStore(FS_STORE);
      const rq = st.delete(key);
      rq.onsuccess = ()=> resolve(true);
      rq.onerror = ()=> reject(rq.error);
    });
  }

  async function verifyDirPermission(handle){
    if(!handle) return false;
    try{
      const opts = { mode: "readwrite" };
      const q = await handle.queryPermission(opts);
      if(q === "granted") return true;
      const r = await handle.requestPermission(opts);
      return r === "granted";
    }catch(e){
      return false;
    }
  }

  async function setupAutoBackupFolder(){
    if(!window.showDirectoryPicker){
      alert("이 브라우저에서는 폴더 자동백업을 지원하지 않습니다. (크롬/엣지/웨일 권장)");
      return;
    }
    // Secure context check: file://는 대부분 막힘
    if(!(location.protocol === "https:" || location.hostname === "localhost" || location.hostname === "127.0.0.1")){
      alert("폴더 자동백업은 보안상 'https' 또는 'http://localhost'에서만 동작합니다.\n\n해결: 이 파일을 로컬 서버로 열어주세요.\n예) 폴더에서 터미널(명령프롬프트) → python -m http.server 8000 → 브라우저에서 http://localhost:8000 접속");
      return;
    }
    try{
      const dir = await window.showDirectoryPicker({ mode: "readwrite" });
      const ok = await verifyDirPermission(dir);
      if(!ok){
        alert("폴더 쓰기 권한이 필요합니다. 권한을 허용해주세요.");
        return;
      }
      autoBackupDirHandle = dir;
      await fsIdbSet(FS_KEY_DIR, dir);
      autoBackupEnabled = true;
      setAutoBackupUI("ON", "폴더 자동백업 활성화됨");
      await writeAutoBackupNow("초기 자동백업");
      save("폴더 자동백업 설정 완료");
    }catch(e){
      // user cancel is fine
      if(e && (e.name==="AbortError" || e.name==="NotAllowedError")) return;
      alert("폴더 자동백업 설정 중 오류: " + (e?.message || e));
    }
  }

  async function disableAutoBackupFolder(){
    autoBackupEnabled = false;
    autoBackupDirHandle = null;
    try{ await fsIdbDel(FS_KEY_DIR); }catch(e){}
    setAutoBackupUI("OFF", "폴더 자동백업 해제됨");
    save("자동백업 해제");
  }

  async function initAutoBackupFromCache(){
    try{
      const h = await fsIdbGet(FS_KEY_DIR);
      if(!h){
        setAutoBackupUI("OFF", "폴더 자동백업 미설정");
        return;
      }
      const ok = await verifyDirPermission(h);
      if(!ok){
        setAutoBackupUI("OFF", "폴더 권한 필요(설정 버튼으로 재승인)");
        autoBackupDirHandle = h;
        autoBackupEnabled = false;
        return;
      }
      autoBackupDirHandle = h;
      autoBackupEnabled = true;
      setAutoBackupUI("ON", "폴더 자동백업 활성화됨");
    }catch(e){
      setAutoBackupUI("OFF", "폴더 자동백업 초기화 실패");
    }
  }

  async function writeAutoBackupNow(reason=""){
    if(!autoBackupEnabled || !autoBackupDirHandle) return;
    if(autoBackupBusy) return;
    autoBackupBusy = true;
    try{
      const fileHandle = await autoBackupDirHandle.getFileHandle("MakeFreeERP_AutoBackup.json", { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write(JSON.stringify(state, null, 2));
      await writable.close();
      // optional rolling copy (daily)
      const d = today();
      const dailyName = `MakeFreeERP_AutoBackup_${d}.json`;
      const dailyHandle = await autoBackupDirHandle.getFileHandle(dailyName, { create: true });
      const w2 = await dailyHandle.createWritable();
      await w2.write(JSON.stringify(state, null, 2));
      await w2.close();
      if(reason) $("saveStatus").textContent = `폴더 자동백업 완료(${reason}) · ` + new Date().toLocaleString("ko-KR");
    }catch(e){
      // If permission revoked, show status
      setAutoBackupUI("OFF", "폴더 권한이 해제됨(설정 버튼으로 재승인)");
      autoBackupEnabled = false;
    }finally{
      autoBackupBusy = false;
    }
  }

  function scheduleAutoBackup(){
    if(!autoBackupEnabled) return;
    if(autoBackupTimer) clearTimeout(autoBackupTimer);
    autoBackupTimer = setTimeout(()=>{ writeAutoBackupNow("자동"); }, 800);
  }

  const APP_VER = "2025.12.24-ultimate";
  const $ = (id)=>document.getElementById(id);
  
  // Remove duplicated "거래처별 미수/미지급(항상)" cards to prevent UI break (A option).
  function removeAlwaysARAPCards(){
    try{
      document.querySelectorAll(".badge").forEach(b=>{
        const t = (b.textContent||"").trim();
        if(t.includes("거래처별 미수/미지급")){
          const card = b.closest(".card");
          if(card) card.remove();
        }
      });
    }catch(e){}
  }

  
  const $all = (sel, root=document)=>Array.from(root.querySelectorAll(sel));

  // ===== Compatibility helpers (avoid silent failures) =====
  function num(v){ return toNum(v); }
  function fmtMoney(v){ return fmt(v); }

const fmt = (n)=>Number(n||0).toLocaleString("ko-KR");
  const toNum = (v)=> {
    const s = (v===null||v===undefined) ? "" : String(v);
    const t = s.replace(/,/g,"").trim();
    if(t==="") return 0;
    const x = Number(t);
    return Number.isFinite(x) ? x : 0;
  };
  const today = ()=>{
    const d=new Date();
    const z=new Date(d.getTime()-d.getTimezoneOffset()*60000);
    return z.toISOString().slice(0,10);
  };
  const thisMonth = ()=>{
    const d=new Date();
    const z=new Date(d.getTime()-d.getTimezoneOffset()*60000);
    return z.toISOString().slice(0,7);
  };
  const uid = ()=> "id_" + Math.random().toString(36).slice(2,9) + "_" + Date.now().toString(36);

  // ===== Sorting helpers (deterministic) =====
  const LS_MONTH_SORT = LS + "_month_sort_v1";
  function txOrderKey(t){
    if(!t) return 0;
    if(typeof t.createdAt === "number") return t.createdAt;
    const id = (t.id||"");
    const last = id.split("_").pop();
    const v = parseInt(last, 36);
    return Number.isFinite(v) ? v : 0;
  }
  function monthSortDesc(mode){
    switch(mode){
      case "DATE_ASC_FLOW": return "날짜↑ · 품목묶음(등장순, 매입→매출)";
      case "DATE_DESC_INPUT": return "날짜↓ · 입력순";
      case "DATE_ASC_TYPE": return "날짜↑ · 구분순";
      case "TYPE_DATE_ASC": return "구분 → 날짜↑";
      default: return "날짜↑ · 입력순";
    }
  }

  // 흐름정렬(같은날: 매입→경비→매출→수금→지급, 그룹은 입력순 유지)
  function typeFlowWeight(type){
    return (type==="PURCHASE") ? 10
      : (type==="EXPENSE") ? 15
      : (type==="SALE") ? 20
      : (type==="RECEIPT") ? 30
      : (type==="PAYMENT") ? 40
      : (type==="OFFSET") ? 50
      : 99;
  }
  
  function txItemSortKey(t){
    try{
      const ty = (t && t.type) ? t.type : "";
      const projId = (t && t.projectId) ? t.projectId : "";
      const raw = (t && t.itemId) ? (getItemName(t.itemId) || "") : ((t && t.itemName) ? t.itemName : "");
      // nk(): 공백/기호 정규화(뒤쪽에 선언되어 있어도 함수 선언은 hoist 됨)
      const key = nk((raw||"").toString());
      const isCommonExpense = (ty==="EXPENSE" && !projId); // 프로젝트 없는 경비(급여/이자/세금 등)
      const isCashFlow = (ty==="RECEIPT" || ty==="PAYMENT"); // 수금/지급은 하단 고정
      if(isCashFlow) return "\uffffcash" + (key||"");
      if(isCommonExpense) return "\uffffexp" + (key||"");
      if(!key) return "\uffff";
      return key;
    }catch(e){ return "\uffff"; }
  }
function flowGroupKey(t){
    const d = (t && t.date) ? t.date : "";
    const ik = txItemSortKey(t);
    // 품목이 있으면: 같은 날짜 + 품목키로 묶어서 '매입 → 매출' 흐름이 붙도록
    if(ik && !String(ik).startsWith("\uffff")){
      return d + "|IT:" + ik;
    }
    // 품목이 없거나(공통경비/수금/지급 등): 과도한 묶음을 피하기 위해 더 세분화
    const tp = (t && t.type) ? t.type : "";
    const party = (t && t.partyId) ? ("C:"+t.partyId) : "C:-";
    const proj  = (t && t.projectId) ? ("P:"+t.projectId) : "P:-";
    const memo  = (t && t.memo) ? ("M:"+(t.memo+"").slice(0,24)) : "M:-";
    return d + "|X:"+tp+"|" + party + "|" + proj + "|" + memo;
  }

  function buildFlowFirstKeyMap(arr){
    const m = new Map();
    (arr||[]).forEach(t=>{
      const k = flowGroupKey(t);
      const ok = txOrderKey(t);
      const cur = m.get(k);
      if(cur===undefined || ok<cur) m.set(k, ok);
    });
    return m;
  }
  function getMonthSortMode(){
    const sel = $("mSort");
    const v = sel ? sel.value : "";
    const saved = localStorage.getItem(LS_MONTH_SORT) || "";
    return (v || saved || "DATE_ASC_INPUT");
  }
  function setMonthSortMode(v){
    try{ localStorage.setItem(LS_MONTH_SORT, v); }catch(_){}
    const sel = $("mSort");
    if(sel) sel.value = v;
    const hint = $("mSortHint");
    if(hint) hint.textContent = "정렬: " + monthSortDesc(v);
  }
  
  // ===== Month Quick Cash (Safe Draft) =====
  const LS_MONTH_QC = LS + "_month_quickcash_v1";
  function getQuickCashOn(){
    try{
      const v = localStorage.getItem(LS_MONTH_QC);
      return v === "1";
    }catch(e){ return false; }
  }
  function setQuickCashOn(on){
    try{ localStorage.setItem(LS_MONTH_QC, on ? "1" : "0"); }catch(e){}
    try{ document.body.classList.toggle("qc-on", !!on); }catch(e){}
    const cb = $("mQuickCash");
    if(cb) cb.checked = !!on;
  }

// ===== Month Quick Edit Side Panel (A) =====
  let __qeId = null;
  let __qeMode = "EDIT"; // EDIT | NEW_CASH
  let __qeDraft = null; // {srcId, kind, role, maxOpen, partyId}


  function qeOpen(id){
    const tx = state.tx.find(x=>x.id===id);
    if(!tx) return;
    __qeMode = "EDIT";
    __qeDraft = null;
    try{ const t = $("qeTitle"); if(t) t.textContent = "월 거래내역 퀵수정"; }catch(e){}
    try{ $("qeDraftBox").style.display = "none"; }catch(e){}
    try{ $("qeDraftInfo").textContent = ""; $("qeDraftWarn").textContent = ""; }catch(e){}
    __qeId = id;
    try{ window.__qeId = id; }catch(e){}
    $("qeIdText").textContent = id ? ("ID: " + id) : "";
    $("qeDate").value = tx.date || "";
    $("qeType").value = tx.type || "SALE";
    $("qeParty").value = getName(state.masters.parties, tx.partyId) || "";
    $("qeProj").value  = getName(state.masters.projects, tx.projectId) || "";
    $("qeItem").value  = getName(state.masters.items, tx.itemId) || "";
    $("qeQty").value = (tx.qty||0) ? String(tx.qty) : "";
    $("qeUnitPrice").value = (tx.unitPrice||0) ? String(tx.unitPrice) : "";
    $("qeAmount").value = (tx.amount||0) ? String(tx.amount) : String(tx.total||0);
    $("qeVatMode").value = tx.vatMode || "INCLUDED";
    $("qeInvIssued").checked = !!tx.invoiceIssued;
    $("qeInvNo").value = tx.invoiceNo || "";
    $("qeMemo").value = tx.memo || "";
    qePreview();
    $("qeOverlay").style.display = "block";
    $("qePanel").classList.add("open");
    $("qePanel").setAttribute("aria-hidden","false");
  }

  function qeClose(){
    $("qeOverlay").style.display = "none";
    $("qePanel").classList.remove("open");
    $("qePanel").setAttribute("aria-hidden","true");
    __qeId = null;
    __qeMode = "EDIT";
    __qeDraft = null;
    try{ window.__qeId = null; }catch(e){}
    try{ const t = $("qeTitle"); if(t) t.textContent = "월 거래내역 퀵수정"; }catch(e){}
    try{ $("qeDraftBox").style.display = "none"; }catch(e){}
  }


  function qePreview(){
    const type = $("qeType").value;
    const qty = toNum($("qeQty").value||0);
    const up  = toNum($("qeUnitPrice").value||0);
    const amtRaw = toNum($("qeAmount").value||0);
    const amount = (qty>0 && up>0) ? Math.round(qty*up) : amtRaw;
    const vatMode = $("qeVatMode").value || "INCLUDED";
    let total=amount, vat=0, supply=amount;
    if(type==="SALE"||type==="PURCHASE"||type==="EXPENSE"){
      const v = calcVat(amount, vatMode);
      total = v.total;
      const sp = splitVatFromTotal(total, vatMode);
      supply = sp.supply; vat = sp.vat;
    }else{
      total = amount; vat = 0; supply = amount;
    }
    $("qePrevSupply").textContent = fmtMoney(supply);
    $("qePrevVat").textContent = fmtMoney(vat);
    $("qePrevTotal").textContent = fmtMoney(total);
  }


  function qeSyncTypeUI(){
    const type = ($("qeType")?.value) || "SALE";
    const isInv = (type==="SALE"||type==="PURCHASE"||type==="EXPENSE");
    const isCash = (type==="RECEIPT"||type==="PAYMENT");
    try{
      if($("qeVatMode")) $("qeVatMode").disabled = !isInv;
      if($("qeInvIssued")) $("qeInvIssued").disabled = !isInv;
      if($("qeInvNo")) $("qeInvNo").disabled = !isInv;
      if(!isInv){
        if($("qeVatMode")) $("qeVatMode").value = "ZERO";
        if($("qeInvIssued")) $("qeInvIssued").checked = false;
        if($("qeInvNo")) $("qeInvNo").value = "";
      }
      if($("qeQty")) $("qeQty").disabled = isCash;
      if($("qeUnitPrice")) $("qeUnitPrice").disabled = isCash;
      if(isCash){
        if($("qeQty")) $("qeQty").value = "";
        if($("qeUnitPrice")) $("qeUnitPrice").value = "";
      }
    }catch(e){}
  }

  function qeValidate(){
    const btn = $("qeSave");
    if(!btn) return;
    if(__qeMode !== "NEW_CASH"){
      btn.disabled = false;
      try{ if($("qeDraftWarn")) $("qeDraftWarn").textContent = ""; }catch(e){}
      return;
    }
    const date = ($("qeDate")?.value || "").trim();
    const type = ($("qeType")?.value || "").trim();
    const party = ($("qeParty")?.value || "").trim();
    const amt = toNum(($("qeAmount")?.value || "0"));
    let ok = !!date && !!party && (amt > 0) && (type==="RECEIPT"||type==="PAYMENT");
    btn.disabled = !ok;

    const warns = [];
    if(!party) warns.push("거래처 필요");
    if(!(amt>0)) warns.push("금액>0 필요");
    if(__qeDraft && (__qeDraft.maxOpen||0)>0 && amt > (__qeDraft.maxOpen||0)) warns.push("잔액 초과(저장 시 확인)");
    try{ if($("qeDraftWarn")) $("qeDraftWarn").textContent = warns.join(" · "); }catch(e){}
  }

  function qcOpenDraftCash(srcId, kind){
    if(!getQuickCashOn()){
      toast("수금/지급 퀵추가가 OFF 입니다.");
      return;
    }
    const src = state.tx.find(x=>x.id===srcId);
    if(!src) return;
    if(!(src.type==="SALE" || src.type==="PURCHASE" || src.type==="EXPENSE")) return;

    const open = invoiceSettled(src).open || 0;
    if(open <= 0){
      toast("이미 정산완료(잔액 0) 입니다.");
      return;
    }
    const role = (kind==="RECEIPT") ? "AR" : "AP";
    const partyName = getName(state.masters.parties, src.partyId) || "";
    __qeId = null;
    try{ window.__qeId = null; }catch(e){}
    __qeMode = "NEW_CASH";
    __qeDraft = {srcId, kind, role, maxOpen: open, partyId: src.partyId};

    try{ const t = $("qeTitle"); if(t) t.textContent = (kind==="RECEIPT" ? "수금 초안(안전모드)" : "지급 초안(안전모드)"); }catch(e){}
    try{
      $("qeDraftBox").style.display = "block";
      $("qeDraftInfo").textContent = `원거래: ${typeLabel(src.type)} ${src.date} · 잔액 ${fmtMoney(open)} · 거래처 ${partyName}`;
    }catch(e){}

    $("qeIdText").textContent = "DRAFT (저장 전에는 DB에 반영되지 않음)";
    $("qeDate").value = today();
    $("qeType").value = kind;
    $("qeParty").value = partyName;
    $("qeProj").value = ""; // 현금거래는 프로젝트를 비워도 됩니다(필요 시 수동 입력)
    $("qeItem").value = "";
    $("qeQty").value = "";
    $("qeUnitPrice").value = "";
    $("qeAmount").value = String(open);
    $("qeVatMode").value = "ZERO";
    $("qeInvIssued").checked = false;
    $("qeInvNo").value = "";
    $("qeMemo").value = (kind==="RECEIPT" ? "정산용 수금(초안)" : "정산용 지급(초안)");

    qeSyncTypeUI();
    qePreview();
    qeValidate();

    $("qeOverlay").style.display = "block";
    $("qePanel").classList.add("open");
    $("qePanel").setAttribute("aria-hidden","false");
  }

  function qeSaveDraftCash(){
    // Safety: always validate again
    const date = ($("qeDate")?.value || "").trim();
    const type = ($("qeType")?.value || "").trim();
    const partyName = ($("qeParty")?.value || "").trim();
    const projName = ($("qeProj")?.value || "").trim();
    const itemName = ($("qeItem")?.value || "").trim();
    const amt = toNum(($("qeAmount")?.value || "0"));
    if(!date || !partyName || !(amt>0) || !(type==="RECEIPT"||type==="PAYMENT")){
      toast("필수값(일자/거래처/금액)을 확인하세요.");
      return;
    }
    if(__qeDraft && (__qeDraft.maxOpen||0)>0 && amt > (__qeDraft.maxOpen||0)){
      const ok = confirm("입력 금액이 잔액보다 큽니다. 초과분은 미배분(선수금/선지급)으로 남습니다. 저장할까요?");
      if(!ok) return;
    }

    const partyId = findOrCreate(state.masters.parties, partyName);
    const projectId = projName ? findOrCreate(state.masters.projects, projName) : "";
    const itemId = itemName ? findOrCreate(state.masters.items, itemName) : "";
    const defaultBank = state.masters.accounts.find(a=>a.type==="BANK")?.id || "";
    const accountId = defaultBank;
    const newId = uid();

    state.tx.push({
      id: newId,
      date,
      type,
      partyId, projectId, itemId,
      qty: 0,
      unitPrice: 0,
      amount: amt,
      vatMode: "ZERO",
      vat: 0,
      total: amt,
      invoiceIssued: false,
      invoiceNo: "",
      memo: ($("qeMemo")?.value || "").trim(),
      accountId
    });

    sortTx();
    save(type==="RECEIPT" ? "수금 저장" : "지급 저장");
    renderAll();
    qeClose();

    // Jump to settle view (NO auto-match)
    try{
      const mode = (type==="RECEIPT") ? "AR" : "AP";
      window.__mf_focus_source_id = newId;
      if($("sParty")) $("sParty").value = partyId;
      if($("sMode")) $("sMode").value = mode;
      setView("settle");
      try{ renderSettle(); }catch(e){}
      setTimeout(()=>{ try{ document.getElementById('sPayBody')?.scrollIntoView({behavior:'smooth', block:'start'}); }catch(e){} }, 30);
    }catch(e){}
  }
  function qeSave(){
    if(__qeMode === "NEW_CASH"){
      qeSaveDraftCash();
      return;
    }
    const id = __qeId;
    const tx = state.tx.find(x=>x.id===id);
    if(!tx) return;

    const date = $("qeDate").value || tx.date;
    const type = $("qeType").value || tx.type;

    const partyName = ($("qeParty").value||"").trim();
    const projName  = ($("qeProj").value||"").trim();
    const itemName  = ($("qeItem").value||"").trim();

    if(partyName) tx.partyId = findOrCreate(state.masters.parties, partyName);
    if(itemName) tx.itemId = findOrCreate(state.masters.items, itemName);
    tx.projectId = projName ? findOrCreate(state.masters.projects, projName) : "";

    tx.date = date;
    tx.type = type;

    const qty = toNum($("qeQty").value||0);
    const up  = toNum($("qeUnitPrice").value||0);
    const amtRaw = toNum($("qeAmount").value||0);
    const amount = (qty>0 && up>0) ? Math.round(qty*up) : amtRaw;

    if(type==="SALE"||type==="PURCHASE"||type==="EXPENSE"){
      tx.qty = qty;
      tx.unitPrice = up;
      tx.amount = amount;
      tx.vatMode = $("qeVatMode").value || "INCLUDED";
      const v = calcVat(amount, tx.vatMode);
      tx.total = v.total;
      tx.vat = v.vat;
      tx.invoiceIssued = !!$("qeInvIssued").checked;
      tx.invoiceNo = (tx.invoiceIssued ? ($("qeInvNo").value||"").trim() : "");
    }else{
      tx.qty = 0;
      tx.unitPrice = 0;
      tx.amount = amount;
      tx.vatMode = "ZERO";
      tx.vat = 0;
      tx.total = amount;
      tx.invoiceIssued = false;
      tx.invoiceNo = "";
    }
    tx.memo = ($("qeMemo").value||"").trim();

    save("월 거래내역 퀵수정 저장");
    renderMonthLedger();
    qeClose();
  }



  

  // ===== Auto Match on Save (RECEIPT/PAYMENT → 자동정산) =====
  function setAutoMatchUI(){
    const on = !!(state?.meta?.autoMatchOnSave);
    const pill = $("autoMatchPill");
    const btn = $("btnAutoMatchToggle");
    if(pill){
      pill.textContent = "자동정산: " + (on ? "ON" : "OFF");
      pill.style.borderColor = on ? "rgba(5,150,105,.25)" : "rgba(220,38,38,.25)";
      pill.style.background = on ? "rgba(5,150,105,.08)" : "rgba(220,38,38,.08)";
      pill.style.color = on ? "var(--ok)" : "var(--danger)";
    }
    if(btn){
      btn.textContent = "수금/지급 자동정산: " + (on ? "ON" : "OFF");
      btn.classList.toggle("ok", on);
    }
  }

  function autoAllocateForSource(sourceTx){
    try{
      if(!sourceTx) return 0;
      if(!(sourceTx.type==="RECEIPT" || sourceTx.type==="PAYMENT")) return 0;
      if(!(toNum(sourceTx.total)>0)) return 0;
      const partyId = sourceTx.partyId;
      if(!partyId) return 0;
      const role = (sourceTx.type==="RECEIPT") ? "AR" : "AP";
      const rule = ($("sAutoRule")?.value) || "FIFO";
      const key = (x)=> x.date + x.id;
      let targets = [];
      if(role==="AR"){
        targets = state.tx.filter(t=>t.partyId===partyId && t.type==="SALE" && toNum(t.total)>0)
          .filter(t=> invoiceSettled(t).open > 0);
      }else{
        targets = state.tx.filter(t=>t.partyId===partyId && (t.type==="PURCHASE"||t.type==="EXPENSE") && toNum(t.total)>0)
          .filter(t=> invoiceSettled(t).open > 0);
      }
      targets.sort((a,b)=> rule==="FIFO" ? key(a).localeCompare(key(b)) : key(b).localeCompare(key(a)));
      let rem = sourceRemaining(sourceTx, role).rem;
      if(rem<=0) return 0;
      let cnt = 0;
      for(const t of targets){
        const open = invoiceSettled(t).open;
        if(open<=0) continue;
        const use = Math.min(rem, open);
        if(use<=0) continue;
        addAllocation(sourceTx.id, t.id, use, role, "저장시 자동정산");
        cnt++;
        rem -= use;
        if(rem<=0) break;
      }
      return cnt;
    }catch(e){ return 0; }
  }
function esc(s){
    return String(s??"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function opt(val, label, cur){ return `<option value="${val}" ${val===cur?"selected":""}>${label}</option>`; }
  function sum(arr, fn){ return arr.reduce((a,x)=>a+toNum(fn(x)),0); }

  // ===== Safe toast (fallback) =====
  function toast(msg){
    try{
      msg = (msg==null) ? "" : String(msg);
      let el = document.getElementById("mf_toast");
      if(!el){
        el = document.createElement("div");
        el.id = "mf_toast";
        el.style.position = "fixed";
        el.style.left = "50%";
        el.style.bottom = "22px";
        el.style.transform = "translateX(-50%)";
        el.style.zIndex = "999999";
        el.style.padding = "10px 12px";
        el.style.border = "1px solid rgba(0,0,0,.08)";
        el.style.borderRadius = "12px";
        el.style.background = "rgba(255,255,255,.96)";
        el.style.boxShadow = "0 10px 25px rgba(0,0,0,.15)";
        el.style.fontSize = "13px";
        el.style.fontWeight = "900";
        el.style.color = "#111827";
        el.style.maxWidth = "min(680px,92vw)";
        el.style.display = "none";
        document.body.appendChild(el);
      }
      el.textContent = msg;
      el.style.display = "block";
      clearTimeout(el._t);
      el._t = setTimeout(()=>{ try{ el.style.display="none"; }catch(e){} }, 1600);
    }catch(e){
      try{ console.log("[toast]", msg); }catch(_){}
    }
  }



// ===== Settle UX helpers (recent parties / focus source) =====
const MF_RECENT_PARTIES_KEY = "MF_RECENT_PARTIES_V1";

function mfRecentPartyGet(){
  try{
    const raw = localStorage.getItem(MF_RECENT_PARTIES_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(arr)) return [];
    const valid = new Set((state && state.masters && state.masters.parties ? state.masters.parties : []).map(p=>p.id));
    return arr.filter(x=> typeof x==="string" && valid.has(x));
  }catch(e){ return []; }
}
function mfRecentPartySet(arr){
  try{ localStorage.setItem(MF_RECENT_PARTIES_KEY, JSON.stringify(arr||[])); }catch(e){}
}
function mfRecentPartyAdd(id){
  try{
    if(!id) return;
    let arr = mfRecentPartyGet();
    arr = [id] + arr.filter(x=>x!==id);
    arr = arr.slice(0,6);
    mfRecentPartySet(arr);
  }catch(e){}
}
function mfEnsureRecentPartyUI(){
  try{
    if(document.getElementById('mfRecentPartyWrap')) return;
    const sel = document.getElementById('sParty');
    if(!sel) return;
    const form = sel.closest('.form');
    if(!form) return;
    const wrap = document.createElement('div');
    wrap.className = 'f12';
    wrap.id = 'mfRecentPartyWrap';
    wrap.style.display = 'none';
    wrap.innerHTML = '<label>최근 거래처</label>'+
      '<div id="mfRecentPartyBtns" class="row" style="gap:6px; align-items:center; flex-wrap:wrap;"></div>';
    const anchor = sel.closest('.f4');
    if(anchor && anchor.parentElement===form){
      form.insertBefore(wrap, anchor.nextSibling);
    }else{
      form.appendChild(wrap);
    }
  }catch(e){}
}
function mfRenderRecentPartyBtns(){
  try{
    mfEnsureRecentPartyUI();
    const wrap = document.getElementById('mfRecentPartyWrap');
    const host = document.getElementById('mfRecentPartyBtns');
    if(!wrap || !host) return;
    const arr = mfRecentPartyGet();
    host.innerHTML = '';
    if(!arr.length){ wrap.style.display='none'; return; }
    wrap.style.display='';
    arr.forEach(pid=>{
      const name = getName(state.masters.parties, pid) || '(거래처)';
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'btn';
      b.style.padding = '6px 9px';
      b.style.borderRadius = '10px';
      b.style.fontSize = '12px';
      b.style.fontWeight = '900';
      b.textContent = name;
      b.title = '클릭하면 정산 거래처로 선택';
      b.addEventListener('click', ()=>{
        const sParty = document.getElementById('sParty');
        if(sParty){ sParty.value = pid; }
        try{ renderSettle(); }catch(e){}
      });
      host.appendChild(b);
    });
    const clr = document.createElement('button');
    clr.type = 'button';
    clr.className = 'btn';
    clr.style.padding = '6px 9px';
    clr.style.borderRadius = '10px';
    clr.style.fontSize = '12px';
    clr.textContent = '초기화';
    clr.title = '최근 거래처 목록 초기화';
    clr.addEventListener('click', ()=>{ mfRecentPartySet([]); mfRenderRecentPartyBtns(); });
    host.appendChild(clr);
  }catch(e){}
}

  

// ===== Settle UX helpers (pinned parties + target filter) =====
const MF_PINNED_PARTIES_KEY = "MF_PINNED_PARTIES_V1";

function mfPinnedPartyGet(){
  try{
    const raw = localStorage.getItem(MF_PINNED_PARTIES_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(arr)) return [];
    const valid = new Set((state && state.masters && state.masters.parties ? state.masters.parties : []).map(p=>p.id));
    return arr.filter(x=> typeof x==="string" && valid.has(x));
  }catch(e){ return []; }
}
function mfPinnedPartySet(arr){
  try{ localStorage.setItem(MF_PINNED_PARTIES_KEY, JSON.stringify(arr||[])); }catch(e){}
}
function mfPinnedPartyAdd(id){
  try{
    if(!id) return;
    let arr = mfPinnedPartyGet();
    arr = [id] + arr.filter(x=>x!==id);
    arr = arr.slice(0,10);
    mfPinnedPartySet(arr);
  }catch(e){}
}
function mfPinnedPartyRemove(id){
  try{
    if(!id) return;
    let arr = mfPinnedPartyGet().filter(x=>x!==id);
    mfPinnedPartySet(arr);
  }catch(e){}
}

function mfEnsurePinnedPartyUI(){
  try{
    if(document.getElementById('mfPinnedPartyWrap')) return;
    const sel = document.getElementById('sParty');
    if(!sel) return;
    const form = sel.closest('.form');
    if(!form) return;

    const wrap = document.createElement('div');
    wrap.className = 'f12';
    wrap.id = 'mfPinnedPartyWrap';
    wrap.innerHTML = '<label>고정 거래처(핀)</label>'+
      '<div class="row" style="gap:6px; align-items:center; flex-wrap:wrap;">'+
        '<div id="mfPinnedPartyBtns" class="row" style="gap:6px; align-items:center; flex-wrap:wrap;"></div>'+
        '<button type="button" class="btn" id="mfBtnPinCur" style="padding:6px 9px;border-radius:10px;font-size:12px;font-weight:900;">★ 현재 핀</button>'+
        '<button type="button" class="btn" id="mfBtnPinnedClear" style="padding:6px 9px;border-radius:10px;font-size:12px;">핀 초기화</button>'+
      '</div>'+
      '<div class="note" style="margin-top:6px;">자주 쓰는 5~10개 거래처를 고정해두면 정산이 훨씬 빨라집니다.</div>';

    const recentWrap = document.getElementById('mfRecentPartyWrap');
    if(recentWrap && recentWrap.parentElement===form){
      form.insertBefore(wrap, recentWrap);
    }else{
      form.appendChild(wrap);
    }

  }catch(e){}
}

function mfRenderPinnedPartyBtns(){
  try{
    mfEnsurePinnedPartyUI();
    const wrap = document.getElementById('mfPinnedPartyWrap');
    const host = document.getElementById('mfPinnedPartyBtns');
    const btnPin = document.getElementById('mfBtnPinCur');
    const btnClr = document.getElementById('mfBtnPinnedClear');
    if(!wrap || !host) return;

    host.innerHTML = '';
    const arr = mfPinnedPartyGet();

    // Render pinned buttons
    arr.forEach(pid=>{
      const name = getName(state.masters.parties, pid) || '(거래처)';
      const box = document.createElement('span');
      box.style.display = 'inline-flex';
      box.style.gap = '4px';
      box.style.alignItems = 'center';

      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'btn';
      b.style.padding = '6px 9px';
      b.style.borderRadius = '10px';
      b.style.fontSize = '12px';
      b.style.fontWeight = '900';
      b.textContent = name;
      b.title = '클릭하면 정산 거래처로 선택';
      b.addEventListener('click', ()=>{
        const sParty = document.getElementById('sParty');
        if(sParty){ sParty.value = pid; }
        try{ renderSettle(); }catch(e){}
      });

      const x = document.createElement('button');
      x.type = 'button';
      x.className = 'btn';
      x.style.padding = '6px 7px';
      x.style.borderRadius = '10px';
      x.style.fontSize = '12px';
      x.textContent = '×';
      x.title = '핀 해제';
      x.addEventListener('click', (ev)=>{
        ev.preventDefault(); ev.stopPropagation();
        mfPinnedPartyRemove(pid);
        mfRenderPinnedPartyBtns();
      });

      box.appendChild(b);
      box.appendChild(x);
      host.appendChild(box);
    });

    // Bind pin/clear once
    if(btnPin && !btnPin.__bound){
      btnPin.__bound = true;
      btnPin.addEventListener('click', ()=>{
        const sel = document.getElementById('sParty');
        const pid = sel ? (sel.value||'') : '';
        if(!pid){ alert('거래처를 먼저 선택하세요.'); return; }
        mfPinnedPartyAdd(pid);
        mfRenderPinnedPartyBtns();
      });
    }
    if(btnClr && !btnClr.__bound){
      btnClr.__bound = true;
      btnClr.addEventListener('click', ()=>{
        if(!confirm('고정(핀) 거래처를 모두 초기화할까요?')) return;
        mfPinnedPartySet([]);
        mfRenderPinnedPartyBtns();
      });
    }

  }catch(e){}
}

function mfEnsureSettleTargetFilterUI(){
  try{
    if(document.getElementById('mfSettleTargetFilterWrap')) return;
    const tb = document.getElementById('sInvBody');
    if(!tb) return;
    const gridwrap = tb.closest('.gridwrap');
    if(!gridwrap) return;

    const wrap = document.createElement('div');
    wrap.id = 'mfSettleTargetFilterWrap';
    wrap.className = 'toolbar';
    wrap.style.marginTop = '8px';
    wrap.style.padding = '8px 10px';
    wrap.style.border = '1px solid var(--line)';
    wrap.style.borderRadius = '12px';

    wrap.innerHTML = '<div class="left" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">'
      +'<span class="badge">대상 필터</span>'
      +'<input id="mfSettleTargetKw" class="in" placeholder="프로젝트/품목/번호/메모 검색" style="width:260px;">'
      +'<span class="note" id="mfSettleTargetCnt">-</span>'
      +'</div>'
      +'<div class="right" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">'
      +'<button type="button" class="btn" id="mfSettleTargetClear">지우기</button>'
      +'</div>';

    gridwrap.parentElement.insertBefore(wrap, gridwrap);

    const kw = document.getElementById('mfSettleTargetKw');
    const clr = document.getElementById('mfSettleTargetClear');

    if(kw && !kw.__bound){
      kw.__bound = true;
      kw.addEventListener('input', ()=>{
        clearTimeout(window.__mfSettleFilterT);
        window.__mfSettleFilterT = setTimeout(()=>{ try{ mfApplySettleTargetFilter(); }catch(e){} }, 120);
      });
    }
    if(clr && !clr.__bound){
      clr.__bound = true;
      clr.addEventListener('click', ()=>{
        const k = document.getElementById('mfSettleTargetKw');
        if(k) k.value='';
        mfApplySettleTargetFilter();
      });
    }

  }catch(e){}
}

function mfApplySettleTargetFilter(){
  try{
    mfEnsureSettleTargetFilterUI();
    const kwEl = document.getElementById('mfSettleTargetKw');
    const cntEl = document.getElementById('mfSettleTargetCnt');
    const tb = document.getElementById('sInvBody');
    if(!tb) return;

    const kw = (kwEl ? kwEl.value : '').trim().toLowerCase();
    const rows = Array.from(tb.querySelectorAll('tr'));

    let shown = 0;
    let total = 0;
    rows.forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      if(!tds.length){ return; }
      total += 1;
      // message rows
      if(tds.length==1 && tds[0].getAttribute('colspan')){
        tr.style.display = '';
        shown += 1;
        return;
      }
      if(!kw){ tr.style.display=''; shown += 1; return; }

      const hay = ((tr.dataset.search||'') + ' ' + (tr.innerText||'')).toLowerCase();
      if(hay.indexOf(kw) >= 0){ tr.style.display=''; shown += 1; }
      else tr.style.display='none';
    });

    if(cntEl){
      cntEl.textContent = (kw ? (shown + ' / ' + total + '건 표시') : (total + '건'));
    }
  }catch(e){}
}
// ===== State =====
  // tx types: SALE, PURCHASE, EXPENSE, RECEIPT, PAYMENT, OFFSET
  // allocations: {id, sourceId, targetId, amount, role:'AR'|'AP', memo, createdAt}
  const state = {
    meta:{ ver: APP_VER, updatedAt: new Date().toISOString(), autoMatchOnSave: false },
    masters:{
      parties:[{id:uid(), name:"주연테크"},{id:uid(), name:"잘만테크"}],
      projects:[{id:uid(), name:"기본(미지정)"}],
      items:[{id:uid(), name:"파워"},{id:uid(), name:"쿨러"}],
      accounts:[
        {id:uid(), type:"BANK", name:"기업은행", opening:0},
        {id:uid(), type:"BANK", name:"현금", opening:0},
        {id:uid(), type:"LOAN", name:"운영자금대출", opening:0}
      ]
    },
    tx:[],
    allocations:[]
  };

  function save(msg="로컬 자동저장 완료"){
    state.meta.updatedAt = new Date().toISOString();

    // IndexedDB에 저장(장기운영)
    try{
      idbSet("state", JSON.parse(JSON.stringify(state)))
        .then(()=>{ try{ localStorage.setItem(LS+"_meta", JSON.stringify({ idb:true, updatedAt: state.meta.updatedAt, ver: APP_VER })); }catch(_){ } })
        .catch(()=>{
          // IDB 실패 시 최후 폴백: localStorage(용량 한계 있음)
          try{ localStorage.setItem(LS, JSON.stringify(state)); }catch(_){}
        });
    }catch(e){
      try{ localStorage.setItem(LS, JSON.stringify(state)); }catch(_){}
    }

    scheduleAutoBackup();
    $("saveStatus").textContent = msg + " · " + new Date().toLocaleString("ko-KR");
  }

  function safeParse(raw){
    try{ return JSON.parse(raw); }catch(e){ return null; }
  }

  function migrateIfNeeded(data){
    if(data && data.masters && Array.isArray(data.tx) && Array.isArray(data.allocations)) return data;
    if(data && data.masters && Array.isArray(data.tx) && !data.allocations){
      data.allocations = [];
      return data;
    }
    return data;
  }

  async function load(){
    // 1) IndexedDB 우선 로드
    try{
      const rec = await idbGet("state");
      const data0 = rec ? (rec.v || rec) : null;
      const data = migrateIfNeeded(data0);
      if(data && data.masters && Array.isArray(data.tx)){
        state.meta = data.meta || state.meta;
        state.masters = data.masters || state.masters;
        state.tx = data.tx || [];
        state.allocations = data.allocations || [];
        return;
      }
    }catch(e){
      // IDB 미지원/권한 문제 등 → localStorage로 폴백
    }

    // 2) localStorage 폴백 + IDB로 마이그레이션
    try{
      const raw = localStorage.getItem(LS);
      if(!raw) return;
      const data0 = safeParse(raw);
      const data = migrateIfNeeded(data0);
      if(!data || !data.masters || !Array.isArray(data.tx)) return;

      state.meta = data.meta || state.meta;
      state.masters = data.masters || state.masters;
      state.tx = data.tx || [];
      state.allocations = data.allocations || [];

      // IDB로 자동 이관(한 번만)
      try{ await idbSet("state", JSON.parse(JSON.stringify(state))); }catch(_){}
      try{ localStorage.setItem(LS+"_meta", JSON.stringify({ idb:true, migratedAt: Date.now() })); }catch(_){}
    }catch(e){
      return;
    }
  }

  // ===== Master helpers =====
  function normMasterName(s){
    return (s||"").toString().toLowerCase().replace(/\s+/g,"").replace(/[()㈜\[\]\-_.·,]/g,"").trim();
  }

  function findOrCreate(list, name){
    const nm = (name||"").trim();
    if(!nm) return "";
    const k = normMasterName(nm);
    const hit = (list||[]).find(x => normMasterName((x?.name||"").trim()) === k);
    if(hit) return hit.id;
    const id = uid();
    list.push({id, name:nm});
    return id;
  }
  function getName(list, id){
    if(!id) return "";
    const hit = list.find(x=>x.id===id);
    return hit ? hit.name : "";
  }

  function typeLabel(t){
    return ({
      SALE:"매출", PURCHASE:"매입", EXPENSE:"경비", RECEIPT:"수금", PAYMENT:"지급", OFFSET:"상계(수동)"
    }[t] || t);
  }
  function badgeType(t){
    const cls = t==="SALE" ? "b-pri"
      : t==="PURCHASE" ? "b-warn"
      : t==="EXPENSE" ? "b-danger"
      : t==="RECEIPT" ? "b-ok"
      : t==="PAYMENT" ? "b-warn"
      : "b-danger";
    return `<span class="badge ${cls}">${esc(typeLabel(t))}</span>`;
  }

  function calcVat(amount, vatMode){
    const a = toNum(amount);
    if(vatMode==="ZERO") return { total:a, vat:0 };
    if(vatMode==="EXCLUDED"){
      const total = Math.round(a*1.1);
      return { total, vat: total-a };
    }
    const total = a;
    const supplyApprox = Math.round(total/1.1);
    return { total, vat: total - supplyApprox };
  }

  // ===== Allocation math =====
  function isInvoice(t){ return t.type==="SALE" || t.type==="PURCHASE" || t.type==="EXPENSE"; }
  function invoiceRole(t){
    if(t.type==="SALE") return "AR";
    if(t.type==="PURCHASE" || t.type==="EXPENSE") return "AP";
    return "";
  }
  function allocSumByTarget(targetId, role){
    return state.allocations.filter(a=>a.targetId===targetId && a.role===role)
      .reduce((acc,a)=>acc + toNum(a.amount),0);
  }
  function allocSumBySource(sourceId, role){
    return state.allocations.filter(a=>a.sourceId===sourceId && a.role===role)
      .reduce((acc,a)=>acc + toNum(a.amount),0);
  }
  function invoiceSettled(t){
    const role = invoiceRole(t);
    if(!role) return {settled:0, open:0};
    const settled = allocSumByTarget(t.id, role);
    const open = Math.max(0, toNum(t.total) - settled);
    return {settled, open};
  }
  function sourceRemaining(t, role){
    const used = allocSumBySource(t.id, role);
    const rem = Math.max(0, toNum(t.total) - used);
    return {used, rem};
  }
  function partyAROpen(partyId){
    const inv = state.tx.filter(t=>t.partyId===partyId && t.type==="SALE" && toNum(t.total)>0);
    return inv.reduce((acc,t)=> acc + invoiceSettled(t).open, 0);
  }
  function partyAPOpen(partyId){
    const inv = state.tx.filter(t=>t.partyId===partyId && (t.type==="PURCHASE"||t.type==="EXPENSE") && toNum(t.total)>0);
    return inv.reduce((acc,t)=> acc + invoiceSettled(t).open, 0);
  }
  function totalAROpenAll(){
    const inv = state.tx.filter(t=>t.type==="SALE" && toNum(t.total)>0);
    return inv.reduce((acc,t)=> acc + invoiceSettled(t).open, 0);
  }
  function totalAPOpenAll(){
    const inv = state.tx.filter(t=>(t.type==="PURCHASE"||t.type==="EXPENSE") && toNum(t.total)>0);
    return inv.reduce((acc,t)=> acc + invoiceSettled(t).open, 0);
  }

  // ===== Excel input grid =====
  let excelRows = [];
  function newEmptyRow(){
    return {
      _rid: uid(),
      date: today(),
      type: "SALE",
      partyName: "",
      projectName: "",
      itemName: "",
      unitPrice: "",
      qty: 1,
      amount: "",
      vatMode: "INCLUDED",
      invoiceIssued: false,
      invoiceNo: "",
      memo: ""
    };
  }
  function ensureExcelRows(n=20){
    while(excelRows.length < n) excelRows.push(newEmptyRow());
  }

  
  function smartFillDown(){
    // Fill empty cells in later rows using the nearest previous non-empty value.
    const keys = ["partyName","projectName","itemName","vatMode","type"];
    const last = {partyName:"", projectName:"", itemName:"", vatMode:"", type:""};
    excelRows.forEach(r=>{
      keys.forEach(k=>{
        const val = (r[k] ?? "").toString().trim();
        if(val){
          last[k] = r[k];
        }else{
          // do not fill date/amount/qty/invoiceNo/memo automatically
          if(last[k]) r[k] = last[k];
        }
      });
    });
    renderExcelGrid();
    toast("스마트 채우기 완료");
  }

  
  // ===== Autocomplete (Master-driven) =====
  function normKey(s){
    return (s||"").toString()
      .toLowerCase()
      .replace(/\s+/g,"")
      .replace(/[()㈜\[\]\-_.·,]/g,"")
      .trim();
  }

  function setDatalistOptions(id, arr){
    const dl = $(id);
    if(!dl) return;
    const uniq = new Set();
    const opts = [];
    (arr||[]).forEach(x=>{
      const name = (typeof x==="string") ? x : (x?.name || x?.title || "");
      const v = (name||"").toString().trim();
      if(!v) return;
      const k = normKey(v);
      if(uniq.has(k)) return;
      uniq.add(k);
      opts.push(`<option value="${esc(v)}"></option>`);
    });
    dl.innerHTML = opts.join("");
  }

  function getMastersForAutocomplete(){
    const parties = state?.masters?.parties || state?.master?.parties || state?.parties || [];
    const items   = state?.masters?.items   || state?.master?.items   || state?.items   || [];
    const projects= state?.masters?.projects|| state?.master?.projects|| state?.projects|| [];
    return { parties, items, projects };
  }

  function renderAutoCompleteLists(){
    const {parties, items, projects} = getMastersForAutocomplete();
    setDatalistOptions("dlParties", parties);
    setDatalistOptions("dlItems", items);
    setDatalistOptions("dlProjects", projects);
  }

  function canonicalizeIfMatch(value, list){
    const v = (value||"").toString().trim();
    if(!v) return v;
    const nk = normKey(v);
    if(!nk) return v;
    let best = null;
    (list||[]).forEach(x=>{
      const name = (typeof x==="string") ? x : (x?.name || x?.title || "");
      const t = (name||"").toString().trim();
      if(!t) return;
      if(normKey(t) === nk) best = t;
    });
    return best || v;
  }

  

  // ===== Ensure datalists are always populated (fix intermittent missing suggestions) =====
  function mfAutoListFocusinInit(){
    try{
      if(window._mfAutoListFocusinBound) return;
      window._mfAutoListFocusinBound = true;
      document.addEventListener("focusin", function(ev){
        const t = ev && ev.target;
        if(!t || t.tagName!=="INPUT") return;
        const listId = t.getAttribute("list");
        if(listId!=="dlParties" && listId!=="dlItems" && listId!=="dlProjects") return;
        const dl = document.getElementById(listId);
        if(dl && dl.children && dl.children.length>0) return;
        try{
          if(typeof renderAutoCompleteLists==="function") renderAutoCompleteLists();
        }catch(e){}
      }, true);
    }catch(e){}
  }
  try{ mfAutoListFocusinInit(); }catch(e){}
function attachExcelAutoFix(){
    const {parties, items, projects} = getMastersForAutocomplete();

    $all('#excelBody input[data-k="partyName"]').forEach(inp=>{
      inp.addEventListener("blur", ()=>{
        const fixed = canonicalizeIfMatch(inp.value, parties);
        if(fixed !== inp.value){
          inp.value = fixed;
          inp.dispatchEvent(new Event("input",{bubbles:true}));
        }
      });
    });

    $all('#excelBody input[data-k="itemName"]').forEach(inp=>{
      inp.addEventListener("blur", ()=>{
        const fixed = canonicalizeIfMatch(inp.value, items);
        if(fixed !== inp.value){
          inp.value = fixed;
          inp.dispatchEvent(new Event("input",{bubbles:true}));
        }
      });
    });

    $all('#excelBody input[data-k="projectName"]').forEach(inp=>{
      inp.addEventListener("blur", ()=>{
        const fixed = canonicalizeIfMatch(inp.value, projects);
        if(fixed !== inp.value){
          inp.value = fixed;
          inp.dispatchEvent(new Event("input",{bubbles:true}));
        }
      });
    });
  }

  function renderExcelGrid(){
    ensureExcelRows(20);
    const tb = $("excelBody");
    if(!tb) return;
    function recalcExcelRow(i, triggerK){
      try{
        const r = excelRows[i] || {};
        // NOTE: 엑셀입력 그리드는 input[type=number] 기반이므로 콤마 포맷을 넣지 않습니다(브라우저가 값을 비워버림).
        const q  = toNum(r.qty);
        const up = toNum(r.unitPrice);
        const am = toNum(r.amount);

        const rowEl = tb.querySelector(`[data-i="${i}"][data-k="qty"]`)?.closest("tr");
        const setVal = (k, v)=>{
          r[k] = v;
          if(rowEl){
            const inp = rowEl.querySelector(`[data-k="${k}"][data-i="${i}"]`);
            if(inp) inp.value = v;
          }
        };
        const round2 = (x)=>{
          const n = Number(x);
          if(!Number.isFinite(n)) return 0;
          return Math.round(n*100)/100;
        };

        // 수량/단가 변경 -> 합계 자동
        if(triggerK==="qty" || triggerK==="unitPrice"){
          if(q>0 && up>=0){
            setVal("amount", fmt(round2(q*up)));
          }
        }
        // 합계 수정 -> 단가 역산
        if(triggerK==="amount"){
          if(q>0 && am>=0){
            setVal("unitPrice", fmt(round2(am/q)));
          }
        }
      }catch(e){}
    }

    tb.innerHTML = "";

    excelRows.forEach((r, idx)=>{
      const tr = document.createElement("tr");
      try{ tr.dataset.id = t.id; }catch(e){}
      tr.innerHTML = `
        <td><input class="cell" data-k="date" data-i="${idx}" type="date" value="${esc(r.date)}"></td>
        <td>
          <select class="cell" data-k="type" data-i="${idx}">
            ${opt("SALE",typeLabel("SALE"),r.type)}${opt("PURCHASE",typeLabel("PURCHASE"),r.type)}${opt("EXPENSE",typeLabel("EXPENSE"),r.type)}${opt("RECEIPT",typeLabel("RECEIPT"),r.type)}${opt("PAYMENT",typeLabel("PAYMENT"),r.type)}
          </select>
        </td>
        <td><input class="cell" data-k="partyName" data-i="${idx}" placeholder="거래처명" value="${esc(r.partyName)}" list="dlParties"></td>
        <td><input class="cell" data-k="projectName" data-i="${idx}" placeholder="프로젝트명" value="${esc(r.projectName)}" list="dlProjects"></td>
        <td><input class="cell" data-k="itemName" data-i="${idx}" placeholder="품목명" value="${esc(r.itemName)}" list="dlItems"></td>
        <td class="right"><input class="cell right mono" data-k="qty" data-i="${idx}" type="number" value="${esc(r.qty)}"></td>
        <td class="right"><div class="miniActBtnRow"><input class="cell right mono" data-k="unitPrice" data-i="${idx}" type="text" inputmode="decimal" pattern="[0-9,.\-]*" placeholder="단가" value="${esc(r.unitPrice||"")}"><button type="button" class="btn miniActBtn" data-act="mul110" data-i="${idx}" title="별도→포함(×1.1)">×1.1</button><button type="button" class="btn miniActBtn" data-act="div110" data-i="${idx}" title="포함→별도(÷1.1)">÷1.1</button></div></td>
        <td class="right"><input class="cell right mono" data-k="amount" data-i="${idx}" type="text" inputmode="decimal" pattern="[0-9,.\-]*" placeholder="합계" value="${esc(r.amount)}"></td>
        <td>
          <select class="cell" data-k="vatMode" data-i="${idx}">
            ${opt("INCLUDED","총액(포함)",r.vatMode)}${opt("EXCLUDED","공급가(별도)",r.vatMode)}${opt("ZERO","면세",r.vatMode)}
          </select>
        </td>
        <td style="white-space:nowrap;">
          <label class="tiny"><input class="chk" data-k="invoiceIssued" data-i="${idx}" type="checkbox" ${r.invoiceIssued?"checked":""}> 발행</label>
        </td>
        <td><input class="cell" data-k="invoiceNo" data-i="${idx}" placeholder="번호(선택)" value="${esc(r.invoiceNo||"")}"></td>
        <td><input class="cell" data-k="memo" data-i="${idx}" placeholder="메모" value="${esc(r.memo)}"></td>
        <td class="right"><button class="btn danger tiny" data-delrow="${idx}">삭제</button></td>
      `;
      tb.appendChild(tr);

    // refresh autocomplete lists
    try{ renderAutoCompleteLists(); }catch(e){}
    try{ attachExcelAutoFix(); }catch(e){}
  });

    tb.querySelectorAll("[data-k]").forEach(elm=>{
      const k = elm.getAttribute("data-k");
      const i = Number(elm.getAttribute("data-i"));
      if(elm.type === "checkbox"){
        elm.addEventListener("change", ()=> excelRows[i][k] = elm.checked);
      }else{
        elm.addEventListener("input", ()=>{ excelRows[i][k] = elm.value; recalcExcelRow(i, k); });
        elm.addEventListener("change", ()=>{ excelRows[i][k] = elm.value; recalcExcelRow(i, k); });
      }
      elm.addEventListener("keydown", (e)=>{
        if(e.key==="Enter"){
          e.preventDefault();
          focusNextCell(elm);
        }
      });
    });

    
    // VAT quick convert buttons (unitPrice ×1.1 / ÷1.1)
    tb.querySelectorAll('[data-act="mul110"],[data-act="div110"]').forEach(btn=>{
      btn.addEventListener("click", (ev)=>{
        ev.preventDefault(); ev.stopPropagation();
        const act = btn.getAttribute("data-act");
        const i = Number(btn.getAttribute("data-i"));
        const r = excelRows[i]; if(!r) return;
        const q = toNum(r.qty);
        let up = toNum(r.unitPrice);
        if(!up){ toast("단가가 비어있습니다."); return; }
        if(act==="mul110"){
          up = Math.round(up*1.1);
          r.vatMode = "INCLUDED";
        }else{
          up = Math.round(up/1.1);
          r.vatMode = "EXCLUDED";
        }
        r.unitPrice = String(up);
        if(q>0){
          r.amount = String(Math.round(q*up));
        }
        try{ saveExcelDraftDebounced("단가변환"); }catch(e){}
        renderExcelGrid();
      });
    });

    tb.querySelectorAll("[data-delrow]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = Number(btn.getAttribute("data-delrow"));
        excelRows.splice(i,1);
        excelRows.push(newEmptyRow());
        renderExcelGrid();
      });
    });
  
    try{ renderExcelMonthDetail(); }catch(e){}
  }

  function focusNextCell(cur){
    const cells = Array.from($("excelBody").querySelectorAll(".cell, .chk"));
    const idx = cells.indexOf(cur);
    if(idx>=0 && idx < cells.length-1){
      cells[idx+1].focus();
    }
  }

  function sortTx(){
    state.tx.sort((a,b)=> (b.date+b.id).localeCompare(a.date+a.id));
  }


  function normalizeTxType(v){
    v = String(v||'').trim();
    if(!v) return 'SALE';
    const u = v.toUpperCase();
    if(u==='SALE' || v==='매출') return 'SALE';
    if(u==='PURCHASE' || v==='매입') return 'PURCHASE';
    if(u==='EXPENSE' || v==='경비') return 'EXPENSE';
    if(u==='RECEIPT' || v==='수금') return 'RECEIPT';
    if(u==='PAYMENT' || v==='지급') return 'PAYMENT';
    if(u==='OFFSET' || v==='상계') return 'OFFSET';
    return u; // fallback
  }

  function saveExcelRows(){
    try{ const ae=document.activeElement; if(ae && typeof ae.blur==='function') ae.blur(); }catch(e){}
    let savedCount = 0;
    const savedCash = [];

    excelRows.forEach(r=>{
      const hasAny =
        (r.partyName||"").trim() ||
        (r.projectName||"").trim() ||
        (r.itemName||"").trim() ||
        String(r.amount||"").trim() ||
        (r.memo||"").trim();

      if(!hasAny) return;

      const date = r.date || today();
      const type = normalizeTxType(r.type || 'SALE');
      const qty = toNum(r.qty);
      const amount = toNum(r.amount);
      const vatMode = (r.vatMode || "INCLUDED").toUpperCase();

      const partyId = findOrCreate(state.masters.parties, r.partyName || "");
      const projName = (r.projectName||"").trim();
      // Do NOT auto-create "(미지정)" projects. Keep empty projectId when blank.
      const projectId = projName ? findOrCreate(state.masters.projects, projName) : "";
      const itemId = findOrCreate(state.masters.items, r.itemName || "");

      const { total, vat } = calcVat(amount, vatMode);
      const defaultBank = state.masters.accounts.find(a=>a.type==="BANK")?.id || "";
      const accountId = defaultBank;

      const newId = uid();

      state.tx.push({
        id: newId,
        date, type,
        partyId, projectId, itemId,
        qty: (type==="RECEIPT" || type==="PAYMENT" || type==="OFFSET") ? 0 : qty,
        amount, vatMode, vat, total,
        invoiceIssued: !!r.invoiceIssued,
        invoiceNo: (r.invoiceNo||"").trim(),
        memo: (r.memo||"").trim(),
        accountId
      });
      if(type==="RECEIPT" || type==="PAYMENT"){
        savedCash.push({id:newId, type, partyId});
      }
      savedCount++;

      // Auto-match on save (optional)
      if(state.meta.autoMatchOnSave && (type==="RECEIPT" || type==="PAYMENT")){
        try{
          const srcTx = state.tx[state.tx.length-1];
          autoAllocateForSource(srcTx);
        }catch(e){}
      }

    });

    sortTx();
    excelRows = [];
    renderExcelGrid();
    hydrateSelects();
  try{ ensureLedPartyOptions(); }catch(e){}
    renderAll();
    save(savedCount ? `입력행 저장 완료(${savedCount}건)` : "저장할 입력이 없습니다");

    // Quick jump to settlement after saving cash (safe: only when 1 party and user confirms)
    try{
      if(savedCash.length){
        const uniq = Array.from(new Set(savedCash.map(x=>x.partyId).filter(Boolean)));
        const last = savedCash[savedCash.length-1];
        if(uniq.length===1 && last && last.id){
          const pid = uniq[0];
          const pname = getName(state.masters.parties, pid) || '';
          const mode = (last.type==='RECEIPT') ? 'AR' : 'AP';
          const msg = `방금 입력한 ${mode==='AR'?'수금':'지급'}을 정산하시겠습니까?
거래처: ${pname}`;
          if(confirm(msg)){
            window.__mf_focus_source_id = last.id;
            if($("sParty")) $("sParty").value = pid;
            if($("sMode")) $("sMode").value = mode;
            setView('settle');
            try{ renderSettle(); }catch(e){}
            setTimeout(()=>{ try{ document.getElementById('sPayBody')?.scrollIntoView({behavior:'smooth', block:'start'}); }catch(e){} }, 30);
          }
        }
      }
    }catch(e){}

  }
  // ===== Selects =====
  function fillSelect(sel, arr, ph){
    sel.innerHTML = "";
    const o0 = document.createElement("option");
    o0.value=""; o0.textContent = ph;
    sel.appendChild(o0);
    arr.forEach(x=>{
      const o=document.createElement("option");
      o.value=x.id; o.textContent=x.name;
      sel.appendChild(o);
    });
  }

  function hydrateSelects(){
    fillSelect($("qParty"), state.masters.parties, "거래처(전체)");
    fillSelect($("qProject"), state.masters.projects, "프로젝트(전체)");
    if($("qItem")) fillSelect($("qItem"), state.masters.items, "품목(전체)");

    fillSelect($("eParty"), state.masters.parties, "거래처 선택");
    fillSelect($("eProject"), state.masters.projects, "프로젝트 선택");
    fillSelect($("eItem"), state.masters.items, "품목 선택");

    fillSelect($("pmProject"), state.masters.projects, "프로젝트 선택");
    fillSelect($("sParty"), state.masters.parties, "거래처 선택");
    if($("ledParty")) fillSelect($("ledParty"), state.masters.parties, "거래처(전체)");
  }

  // ===== Dashboard =====
  let dashFilter = "ALL"; // ALL or UNINV
  function currentMonthTx(){
    const m = thisMonth();
    return state.tx.filter(t => (t.date||"").startsWith(m));
  }

  
  // ===== Dashboard AR/AP (by Party, always visible) =====
  function renderDashARAP(){
    if(!$("dashARTotal")) return;
    $("dashARTotal").textContent = fmt(totalAROpenAll());
    $("dashAPTotal").textContent = fmt(totalAPOpenAll());

    const q = ($("dashARAPText")?.value || "").trim().toLowerCase();
    const rows = state.masters.parties.map(p=>{
      const ar = partyAROpen(p.id);
      const ap = partyAPOpen(p.id);
      return {id:p.id, name:p.name, ar, ap, net: ar-ap};
    }).filter(r=> (r.ar!==0 || r.ap!==0) )
      .filter(r=> !q || (r.name||"").toLowerCase().includes(q))
      .sort((a,b)=> (Math.abs(b.ar)+Math.abs(b.ap)) - (Math.abs(a.ar)+Math.abs(a.ap)) );

    const tb = $("dashARAPBody");
    tb.innerHTML = "";
    const max = 1000;

    rows.slice(0, max).forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(r.name)}</td>
        <td class="right mono">${fmt(r.ar)}</td>
        <td class="right mono">${fmt(r.ap)}</td>
        <td class="right mono">${fmt(r.net)}</td>
      `;
      tb.appendChild(tr);
    });

    if(rows.length>max){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="4" class="note">...외 ${rows.length-max}개(검색으로 좁혀보세요)</td>`;
      tb.appendChild(tr);
    }

    if(rows.length===0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="4" class="note">표시할 잔액이 없습니다.</td>`;
      tb.appendChild(tr);
    }
  }


function renderDashboard(){
    const m = thisMonth();
    $("monthPill").textContent = "월: " + m;

    const allRows = currentMonthTx();

    // 기존 KPI(상단)
    const sales = sum(allRows, t=> t.type==="SALE" ? t.total : 0);
    const purch = sum(allRows, t=> t.type==="PURCHASE" ? t.total : 0);
    const exp = sum(allRows, t=> t.type==="EXPENSE" ? t.total : 0);
    const recv = sum(allRows, t=> t.type==="RECEIPT" ? t.total : 0);
    const pay = sum(allRows, t=> t.type==="PAYMENT" ? t.total : 0);

    $("kpiSales").textContent = fmt(sales);
    $("kpiPurch").textContent = fmt(purch);
    $("kpiExp").textContent = fmt(exp);
    $("kpiRecv").textContent = fmt(recv);
    $("kpiPay").textContent = fmt(pay);
    $("kpiProfit").textContent = fmt(sales - (purch + exp));

    // 미발행 합계(이번달)
    const uninvoicedSales = sum(allRows, t=> (t.type==="SALE" && !t.invoiceIssued) ? t.total : 0);
    const uninvoicedCost  = sum(allRows, t=> ((t.type==="PURCHASE"||t.type==="EXPENSE") && !t.invoiceIssued) ? t.total : 0);
    const uninvoicedSalesCnt = allRows.filter(t=> t.type==="SALE" && !t.invoiceIssued).length;
    const uninvoicedCostCnt  = allRows.filter(t=> (t.type==="PURCHASE"||t.type==="EXPENSE") && !t.invoiceIssued).length;

    if($("kpiUninvSales")) $("kpiUninvSales").textContent = fmt(uninvoicedSales);
    if($("kpiUninvPurch")) $("kpiUninvPurch").textContent = fmt(uninvoicedCost);

    // 미수/미지급(전체 잔액)
    const openAR = totalAROpenAll();
    const openAP = totalAPOpenAll();

    // 이번달 수금/지급 미배분
    const monthReceipts = allRows.filter(t=> t.type==="RECEIPT" && toNum(t.total)>0);
    const monthPayments = allRows.filter(t=> t.type==="PAYMENT" && toNum(t.total)>0);
    const allocRecv = monthReceipts.reduce((a,t)=> a + sourceRemaining(t,"AR").used, 0);
    const unallocRecv = monthReceipts.reduce((a,t)=> a + sourceRemaining(t,"AR").rem, 0);
    const allocPay = monthPayments.reduce((a,t)=> a + sourceRemaining(t,"AP").used, 0);
    const unallocPay = monthPayments.reduce((a,t)=> a + sourceRemaining(t,"AP").rem, 0);

    // 대시보드 체크리스트 숫자
    if($("dashUninvSales")) $("dashUninvSales").textContent = fmt(uninvoicedSales);
    if($("dashUninvSalesCnt")) $("dashUninvSalesCnt").textContent = String(uninvoicedSalesCnt);
    if($("dashUninvCost")) $("dashUninvCost").textContent = fmt(uninvoicedCost);
    if($("dashUninvCostCnt")) $("dashUninvCostCnt").textContent = String(uninvoicedCostCnt);
    if($("dashOpenAR")) $("dashOpenAR").textContent = fmt(openAR);
    if($("dashOpenAP")) $("dashOpenAP").textContent = fmt(openAP);
    if($("dashAllocRecv")) $("dashAllocRecv").textContent = fmt(allocRecv);
    if($("dashUnallocRecv")) $("dashUnallocRecv").textContent = fmt(unallocRecv);
    if($("dashAllocPay")) $("dashAllocPay").textContent = fmt(allocPay);
    if($("dashUnallocPay")) $("dashUnallocPay").textContent = fmt(unallocPay);

    // Top AR/AP by party (전체)
    try{
      const parties = state.masters.parties || [];
      const arRows = parties.map(p=>({id:p.id, name:p.name, v: partyAROpen(p.id)}))
        .filter(x=>x.v>0).sort((a,b)=> b.v-a.v).slice(0,10);
      const apRows = parties.map(p=>({id:p.id, name:p.name, v: partyAPOpen(p.id)}))
        .filter(x=>x.v>0).sort((a,b)=> b.v-a.v).slice(0,10);

      const tbAR = $("dashTopARBody");
      if(tbAR){
        tbAR.innerHTML = arRows.length ? "" : `<tr><td colspan="2" class="muted">없음</td></tr>`;
        arRows.forEach(r=>{
          const tr=document.createElement("tr");
          tr.innerHTML = `<td>${esc(r.name)}</td><td class="right mono"><b>${fmt(r.v)}</b></td>`;
          tr.style.cursor="pointer";
          tr.addEventListener("click", ()=>{
            setView("search");
            $("qParty").value = r.id;
            quickSetTypes(["SALE"]);
            $("qSettle").value = "OPEN";
            $("qInvoice").value = "";
            renderSearch();
          });
          tbAR.appendChild(tr);
        });
      }

      const tbAP = $("dashTopAPBody");
      if(tbAP){
        tbAP.innerHTML = apRows.length ? "" : `<tr><td colspan="2" class="muted">없음</td></tr>`;
        apRows.forEach(r=>{
          const tr=document.createElement("tr");
          tr.innerHTML = `<td>${esc(r.name)}</td><td class="right mono"><b>${fmt(r.v)}</b></td>`;
          tr.style.cursor="pointer";
          tr.addEventListener("click", ()=>{
            setView("search");
            $("qParty").value = r.id;
            quickSetTypes(["PURCHASE","EXPENSE"]);
            $("qSettle").value = "OPEN";
            $("qInvoice").value = "";
            renderSearch();
          });
          tbAP.appendChild(tr);
        });
      }
    }catch(e){}

    // 장기 미수/미지급 Top 10 (60일+)
    try{
      const aged = [];
      (state.tx||[]).forEach(t=>{
        if(!(t.type==="SALE"||t.type==="PURCHASE"||t.type==="EXPENSE")) return;
        const open = invoiceSettled(t).open;
        if(open<=0) return;
        const age = (typeof ageDays==="function") ? ageDays(t.date) : 0;
        if(age < 60) return;
        const party = getName(state.masters.parties, t.partyId) || "(미상)";
        aged.push({t, age, open, party});
      });
      aged.sort((a,b)=> b.age-a.age || b.open-a.open);
      const tb = $("dashAgedBody");
      if(tb){
        tb.innerHTML = aged.length ? "" : `<tr><td colspan="4" class="muted">없음</td></tr>`;
        aged.slice(0,10).forEach(r=>{
          const tr=document.createElement("tr");
          tr.innerHTML = `<td class="mono"><b>${r.age}일</b></td><td>${r.t.type==="SALE"?"미수":"미지급"}</td><td>${esc(r.party)}</td><td class="right mono"><b>${fmt(r.open)}</b></td>`;
          tr.style.cursor="pointer";
          tr.addEventListener("click", ()=>{
            setView("search");
            $("qParty").value = r.t.partyId || "";
            $("qProject").value = r.t.projectId || "";
            if(r.t.type==="SALE") quickSetTypes(["SALE"]);
            else quickSetTypes(["PURCHASE","EXPENSE"]);
            $("qSettle").value="OPEN";
            renderSearch();
          });
          tb.appendChild(tr);
        });
      }
    }catch(e){}

    // 프로젝트 현황(이번달): 매출/비용/이익 Top10
    try{
      const projMap = new Map();
      allRows.forEach(t=>{
        if(!(t.type==="SALE"||t.type==="PURCHASE"||t.type==="EXPENSE")) return;
        const pid = t.projectId || "";
        const key = pid || "__NONE__";
        const cur = projMap.get(key) || {pid, name: pid? (getName(state.masters.projects,pid) || "(삭제됨)") : "(미지정)", sales:0, cost:0};
        if(t.type==="SALE") cur.sales += toNum(t.total);
        else cur.cost += toNum(t.total);
        projMap.set(key, cur);
      });
      const arr = Array.from(projMap.values())
        .filter(x=> (x.sales||0)!==0 || (x.cost||0)!==0)
        .map(x=> ({...x, profit: x.sales - x.cost}))
        .sort((a,b)=> b.profit - a.profit)
        .slice(0, 10);

      const tb = $("dashProjStatusBody");
      if(tb){
        tb.innerHTML = arr.length ? "" : `<tr><td colspan="4" class="muted">이번달 프로젝트 없음</td></tr>`;
        arr.forEach(r=>{
          const tr=document.createElement("tr");
          tr.innerHTML = `<td>${esc(r.name)}</td><td class="right mono">${fmt(r.sales)}</td><td class="right mono">${fmt(r.cost)}</td><td class="right mono"><b>${fmt(r.profit)}</b></td>`;
          tr.style.cursor="pointer";
          tr.addEventListener("click", ()=>{
            setView("proj");
            try{ if($("pmMonth")) $("pmMonth").value = m; }catch(e){}
            try{ if($("pmProject")) $("pmProject").value = r.pid || ""; }catch(e){}
            try{ runProjectMonth(); }catch(e){}
          });
          tb.appendChild(tr);
        });
      }
    }catch(e){}


    // 지급대기 프로젝트(수금완료 & 미지급 존재) Top10 (전체기간)
    try{
      const projMap2 = new Map();
      (state.tx||[]).forEach(t=>{
        if(!(t.type==="SALE"||t.type==="PURCHASE"||t.type==="EXPENSE")) return;
        const pid = t.projectId || "";
        if(!pid) return; // 프로젝트 없는 일반 거래는 제외
        let cur = projMap2.get(pid);
        if(!cur){
          cur = {pid, name: (getName(state.masters.projects,pid) || "(삭제됨)"), salesTotal:0, salesOpen:0, costTotal:0, costOpen:0, uninvCost:0};
          projMap2.set(pid, cur);
        }
        const open = invoiceSettled(t).open || 0;
        if(t.type==="SALE"){
          cur.salesTotal += toNum(t.total);
          cur.salesOpen  += open;
        }else{
          cur.costTotal += toNum(t.total);
          cur.costOpen  += open;
          if(!t.invoiceIssued) cur.uninvCost += toNum(t.total);
        }
      });

      const all = Array.from(projMap2.values())
        .filter(x=> x.salesTotal>0 && x.salesOpen<=0 && x.costOpen>0);

      const totalCnt = all.length;
      const totalAmt = all.reduce((a,x)=> a + (x.costOpen||0), 0);

      if($("dashPayDueCnt")) $("dashPayDueCnt").textContent = String(totalCnt);
      if($("dashPayDueAmt")) $("dashPayDueAmt").textContent = fmt(totalAmt);

      const pill = $("payDuePill");
      if(pill){
        if(totalCnt>0){
          pill.style.display = "";
          pill.innerHTML = `지급대기: <b>${totalCnt}</b>`;
          pill.title = `수금완료·지급대기 프로젝트 ${totalCnt}개 (미지급합 ${fmt(totalAmt)})`;
          pill.style.cursor = "pointer";
          pill.onclick = ()=>{ setView("dash"); window.scrollTo({top:0, behavior:"smooth"}); };
        }else{
          pill.style.display = "none";
          pill.onclick = null;
        }
      }

      const arr = all.sort((a,b)=> (b.costOpen||0)-(a.costOpen||0)).slice(0,10);
      const tb = $("dashPayDueBody");
      if(tb){
        tb.innerHTML = arr.length ? "" : `<tr><td colspan="4" class="muted">지급대기 프로젝트 없음</td></tr>`;
        arr.forEach(r=>{
          const tr=document.createElement("tr");
          tr.innerHTML = `<td>${esc(r.name)}</td>`+
                         `<td class="right mono"><b>${fmt(r.costOpen)}</b></td>`+
                         `<td class="right mono">${fmt(r.uninvCost)}</td>`+
                         `<td><button class="btn tiny" data-pid="${r.pid}">보기</button></td>`;
          tr.querySelector("button").addEventListener("click", (ev)=>{
            ev.stopPropagation();
            setView("search");
            $("qProject").value = r.pid;
            quickSetTypes(["PURCHASE","EXPENSE"]);
            $("qSettle").value = "OPEN";
            $("qInvoice").value = "";
            renderSearch();
          });
          tr.style.cursor="pointer";
          tr.addEventListener("click", ()=>{
            setView("proj");
            try{ if($("pmMonth")) $("pmMonth").value = thisMonth(); }catch(e){}
            try{ if($("pmProject")) $("pmProject").value = r.pid; }catch(e){}
            try{ runProjectMonth(); }catch(e){}
          });
          tb.appendChild(tr);
        });
      }
    }catch(e){}
  }

  function monthAdd(m, delta){
    // m: YYYY-MM
    const [y, mo] = (m||thisMonth()).split("-").map(x=>Number(x));
    const d = new Date(y, (mo-1)+delta, 1);
    const yy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    return yy + "-" + mm;
  }

  function splitVatFromTotal(total, vatMode){
    const t = toNum(total);
    if(vatMode==="ZERO") return {supply:t, vat:0, total:t};
    const supply = Math.round(t/1.1);
    const vat = t - supply;
    return {supply, vat, total:t};
  }

  function txMonth(t){ return (t.date||"").slice(0,7); }

  function monthFilters(){
    const types = Array.from(document.querySelectorAll(".mType")).filter(x=>x.checked).map(x=>x.value);
    const inv = $("mInvoiceFilter")?.value || "";
    const openf = $("mOpenFilter")?.value || "";
    const kw = ($("mKeyword")?.value || "").trim().toLowerCase();
    return {types, inv, openf, kw};
  }

  function renderMonthLedger(){
    const pick = $("monthPick");
    if(pick && !pick.value) pick.value = thisMonth();
    const m = pick ? (pick.value || thisMonth()) : thisMonth();
    // apply saved sort mode + show hint
    try{ setMonthSortMode(getMonthSortMode()); }catch(_){ }

    const {types, inv, openf, kw} = monthFilters();

    let rows = state.tx
      .filter(t=> txMonth(t)===m)
      .filter(t=> types.includes(t.type))
      .filter(t=>{
        if(inv==="") return true;
        if(!isInvoice(t)) return true; // 수금/지급/상계는 계산서 필터 제외
        return inv==="Y" ? !!t.invoiceIssued : !t.invoiceIssued;
      })
      .filter(t=>{
        if(openf==="") return true;
        if(!(t.type==="SALE" || t.type==="PURCHASE" || t.type==="EXPENSE")) return true;
        const {open} = invoiceSettled(t);
        return openf==="OPEN" ? open>0 : open===0;
      })
      .filter(t=>{
        if(!kw) return true;
        const party = getName(state.masters.parties, t.partyId);
        const item = getName(state.masters.items, t.itemId);
        const proj = getName(state.masters.projects, t.projectId);
        const memo = (t.memo||"");
        const invNo = (t.invoiceNo||"");
        return (party+" "+item+" "+proj+" "+memo+" "+invNo).toLowerCase().includes(kw);
      })

      ;
    const __flowFirst = buildFlowFirstKeyMap(rows);
    rows.sort((a,b)=>{
        const mode = getMonthSortMode();
        const da = (a.date||"");
        const db = (b.date||"");
        const oa = txOrderKey(a);
        const ob = txOrderKey(b);

        if(mode==="DATE_DESC_INPUT") return db.localeCompare(da) || (ob-oa);
        if(mode==="DATE_ASC_TYPE") return da.localeCompare(db) || typeLabel(a.type).localeCompare(typeLabel(b.type)) || (oa-ob);
        if(mode==="TYPE_DATE_ASC") return typeLabel(a.type).localeCompare(typeLabel(b.type)) || da.localeCompare(db) || (oa-ob);
        if(mode==="DATE_ASC_FLOW"){
          const ia = txItemSortKey(a);
          const ib = txItemSortKey(b);
          const ra = String(ia||"").startsWith("\uffff") ? 1 : 0;
          const rb = String(ib||"").startsWith("\uffff") ? 1 : 0;
          const ka = flowGroupKey(a);
          const kb = flowGroupKey(b);
          const fa = (__flowFirst.get(ka) ?? oa);
          const fb = (__flowFirst.get(kb) ?? ob);
          return da.localeCompare(db)
            || (ra-rb)
            || (fa-fb)
            || (typeFlowWeight(a.type)-typeFlowWeight(b.type))
            || (oa-ob);
        }
        // DATE_ASC_INPUT (default)
        return da.localeCompare(db) || (oa-ob);
      });


    // summary
    const sumSales = rows.filter(t=>t.type==="SALE").reduce((a,t)=>a+toNum(t.total),0);
    const sumPurch = rows.filter(t=>t.type==="PURCHASE").reduce((a,t)=>a+toNum(t.total),0);
    const sumExp   = rows.filter(t=>t.type==="EXPENSE").reduce((a,t)=>a+toNum(t.total),0);
    const sumRec   = rows.filter(t=>t.type==="RECEIPT").reduce((a,t)=>a+toNum(t.total),0);
    const sumPay   = rows.filter(t=>t.type==="PAYMENT").reduce((a,t)=>a+toNum(t.total),0);
    const profit   = sumSales - sumPurch - sumExp;
    const netCash  = sumRec - sumPay;
    const uninvSalesCnt = rows.filter(t=>t.type==="SALE" && !t.invoiceIssued).length;
    const uninvPurchCnt = rows.filter(t=>(t.type==="PURCHASE"||t.type==="EXPENSE") && !t.invoiceIssued).length;

    if($("mSumSales")) $("mSumSales").textContent = fmtMoney(sumSales);
    if($("mSumPurch")) $("mSumPurch").textContent = fmtMoney(sumPurch);
    if($("mSumExp")) $("mSumExp").textContent = fmtMoney(sumExp);
    if($("mSumRec")) $("mSumRec").textContent = fmtMoney(sumRec);
    if($("mSumPay")) $("mSumPay").textContent = fmtMoney(sumPay);
    if($("mSumProfit")) $("mSumProfit").textContent = fmtMoney(profit);
    if($("mNetCash")) $("mNetCash").textContent = fmtMoney(netCash);
    if($("mUninvSalesCnt")) $("mUninvSalesCnt").textContent = String(uninvSalesCnt);
    if($("mUninvPurchCnt")) $("mUninvPurchCnt").textContent = String(uninvPurchCnt);

    const tb = $("monthBody");
    if(!tb) return;

    tb.innerHTML = rows.map(t=>{
      const party = getName(state.masters.parties, t.partyId);
      const proj  = getName(state.masters.projects, t.projectId);
      const item  = getName(state.masters.items, t.itemId);
      const q = (t.qty!==undefined && t.qty!==null) ? toNum(t.qty) : 0;
      const up = (t.unitPrice!==undefined && t.unitPrice!==null) ? toNum(t.unitPrice) : 0;
      const total = toNum(t.total);
      const {supply, vat} = splitVatFromTotal(total, t.vatMode||"INCLUDED");
      const openObj = (t.type==="SALE" || t.type==="PURCHASE" || t.type==="EXPENSE") ? invoiceSettled(t) : {open:0};
      const open = openObj.open || 0;

      const invCell = isInvoice(t) ? `
        <label class="chklabel">
          <input type="checkbox" class="monthInvChk" data-id="${t.id}" ${t.invoiceIssued?"checked":""}>
          ${t.invoiceIssued?'<span class="badge b-ok">발행</span>':'<span class="badge b-danger">미발행</span>'}
        </label>` : "-";

      const invNoCell = isInvoice(t) ? `<input class="miniInput monthInvNo" data-id="${t.id}" placeholder="번호" value="${esc(t.invoiceNo||"")}">` : "-";

      const memoCell = `<input class="miniInput monthMemo" data-id="${t.id}" placeholder="메모" value="${esc(t.memo||"")}">`;
      return `
        <tr data-id="${t.id}">
          <td class="mono nowrap">${esc(t.date||"")}</td>
          <td>${badgeType(t.type)}</td>
          <td>${esc(party)}</td>
          <td class="muted">${esc(proj)}</td>
          <td>${esc(item)}</td>
          <td class="right">${q?fmtMoney(q):""}</td>
          <td class="right">${((up||0)>0)?fmtMoney(up):(q>0?fmtMoney(Math.round(total/q)):"")}</td>
          <td class="right">${(t.type==="SALE"||t.type==="PURCHASE"||t.type==="EXPENSE")?fmtMoney(supply):""}</td>
          <td class="right">${(t.type==="SALE"||t.type==="PURCHASE"||t.type==="EXPENSE")?fmtMoney(vat):""}</td>
          <td class="right">${fmtMoney(total)}</td>
          <td class="right">${isInvoice(t)?(()=>{ const invst=invoiceSettled(t); const last=lastSettleDateByInvoice(t); const base=(invst.open>0?('<span class="badge b-danger">'+fmtMoney(invst.open)+'</span>'):('<span class="badge b-ok">0</span>')); const settled=(invst.settled>0?(' <span class="muted">정산:'+fmtMoney(invst.settled)+'</span>'):''); const st=payBadge(t); const link=(invst.settled>0?(' <span class="linklike" data-act="openAllocDetail" data-id="'+t.id+'">내역</span>'):''); const dt=(last?(' <span class="muted">('+esc(last)+')</span>'):''); return base+settled+' '+st+link+dt; })():"-"}</td>
                    <td>${invCell}</td>
          <td>${invNoCell}</td>
          <td>${memoCell}</td>
        </tr>
      `;
    }).join("");

    // Handlers: invoice + memo quick updates
    tb.querySelectorAll(".monthInvChk").forEach(ch=>{
      ch.addEventListener("change", ()=>{
        const id = ch.getAttribute("data-id");
        const tx = state.tx.find(x=>x.id===id);
        if(tx && isInvoice(tx)){
          tx.invoiceIssued = ch.checked;
          save("세금계산서 상태 업데이트");
          renderMonthLedger();
          renderDashboard();
        }
      });
    });
    tb.querySelectorAll(".monthInvNo").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const id = inp.getAttribute("data-id");
        const tx = state.tx.find(x=>x.id===id);
        if(tx && isInvoice(tx)){
          tx.invoiceNo = inp.value;
          save("세금계산서 번호 업데이트");
        }
      });
    });
    tb.querySelectorAll(".monthMemo").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const id = inp.getAttribute("data-id");
        const tx = state.tx.find(x=>x.id===id);
        if(tx){
          tx.memo = inp.value;
          save("메모 업데이트");
        }
      });
    });


    // Quick cash buttons (safe draft; NO auto-match)
    tb.querySelectorAll("[data-act='qcCash']").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        e.stopPropagation();
        const srcId = btn.getAttribute("data-src");
        const kind = btn.getAttribute("data-kind");
        qcOpenDraftCash(srcId, kind);
      });
    });

    tb.querySelectorAll("tr[data-id]").forEach(tr=>{
      tr.addEventListener("click", (e)=>{
        // ignore clicks on inline inputs/controls
        if(e.target && (e.target.closest("input")||e.target.closest("select")||e.target.closest("textarea")||e.target.closest("button")||e.target.closest("label")||e.target.closest("a"))) return;
        const id = tr.getAttribute("data-id");
        if(!id) return;
        // simple row highlight only (no popup edit)
        document.querySelectorAll("#monthBody tr.sel").forEach(x=>x.classList.remove("sel"));
        tr.classList.add("sel");
      });
      tr.addEventListener("dblclick", ()=>{
        // search view for editing
        setView("search");
        $("qFrom").value = m + "-01";
        $("qTo").value = m + "-31";
        renderSearch();
        try{
          const id = tr.getAttribute("data-id");
          // optional highlight via keyword
          const tx = state.tx.find(x=>x.id===id);
          if(tx){
            const party = getName(state.masters.parties, tx.partyId);
            $("qKeyword").value = party || "";
            renderSearch();
          }
        }catch(e){}
      });
    });
  }

  function renderExcelMonthDetail(){
    const pick = $("excelMonthPick");
    if(pick && !pick.value) pick.value = thisMonth();
    const m = pick ? (pick.value || thisMonth()) : thisMonth();
    const tb = $("excelMonthBody");
    if(!tb) return;

    const rows = state.tx.filter(t=>txMonth(t)===m)
      .sort((a,b)=> (a.date||"").localeCompare(b.date||""));

    tb.innerHTML = rows.slice(0,300).map(t=>{
      const party = getName(state.masters.parties, t.partyId);
      const proj  = getName(state.masters.projects, t.projectId);
      const item  = getName(state.masters.items, t.itemId);
      const open = isInvoice(t) ? (invoiceSettled(t).open||0) : 0;
      const inv = isInvoice(t) ? (t.invoiceIssued?'<span class="badge b-ok">발행</span>':'<span class="badge b-danger">미발행</span>') : "-";
      return `
        <tr data-id="${t.id}">
          <td class="mono nowrap">${esc(t.date||"")}</td>
          <td>${badgeType(t.type)}</td>
          <td>${esc(party)}</td>
          <td class="muted">${esc(proj)}</td>
          <td>${esc(item)}</td>
          <td class="right">${t.qty?fmtMoney(toNum(t.qty)):""}</td>
          <td class="right">${t.unitPrice?fmtMoney(toNum(t.unitPrice)):""}</td>
          <td class="right">${fmtMoney(toNum(t.total))}</td>
          <td class="right">${isInvoice(t)?(open>0?('<span class="badge b-danger">'+fmtMoney(open)+'</span>'):'<span class="badge b-ok">0</span>'):"-"}</td>
          <td>${inv}</td>
          <td class="muted">${esc(t.memo||"")}</td>
        </tr>
      `;
    }).join("");
  }


  // ===== 검색 =====
  let __qSelectedIds = new Set();

  let __editAmountTouched = false;

  let selectedTxId = null;
  let lastSearchRows = [];

  function renderSearch(){
    const from = $("qFrom").value || "";
    const to = $("qTo").value || "";
    const partyId = $("qParty").value || "";
    const proj = $("qProject").value || "";
    const itemId = ($("qItem")?.value) || "";
    const inv = $("qInvoice").value || "";
    const settle = $("qSettle").value || "";
    const text = ($("qText").value||"").trim().toLowerCase();
    const min = toNum($("qMin").value||0);
    const max = toNum($("qMax").value||0);

    const typeChecks = Array.from(document.querySelectorAll(".qType")).filter(x=>x.checked).map(x=>x.value);

    const rows = state.tx.filter(t=>{
      if(from && t.date < from) return false;
      if(to && t.date > to) return false;
      if(partyId && t.partyId !== partyId) return false;
      if(proj && t.projectId !== proj) return false;
      if(itemId && t.itemId !== itemId) return false;
      if(typeChecks.length && !typeChecks.includes(t.type)) return false;

      if(inv){
        if(!isInvoice(t)) return false;
        if(inv==="Y" && !t.invoiceIssued) return false;
        if(inv==="N" && t.invoiceIssued) return false;
      }

      if(settle){
        if(!(t.type==="SALE"||t.type==="PURCHASE"||t.type==="EXPENSE")) return false;
        const {open} = invoiceSettled(t);
        if(settle==="OPEN" && !(open>0)) return false;
        if(settle==="CLOSED" && !(open===0)) return false;
      }

      if(min && toNum(t.total) < min) return false;
      if(max && toNum(t.total) > max) return false;

      if(text){
        const p = getName(state.masters.parties, t.partyId);
        const pr = getName(state.masters.projects, t.projectId);
        const it = getName(state.masters.items, t.itemId);
        const blob = `${t.memo||""} ${t.invoiceNo||""} ${p} ${pr} ${it}`.toLowerCase();
        if(!blob.includes(text)) return false;
      }
      return true;
    });

    // 정렬(검색/조합): 드롭다운(qSort) 기준 적용
    const sortMode = ($('qSort') && $('qSort').value) ? String($('qSort').value) : 'DATE_DESC_FLOW';
    const __flowFirst = buildFlowFirstKeyMap(rows);
    rows.sort((a,b)=>{
      const da = (a.date||'');
      const db = (b.date||'');
      const oa = txOrderKey(a);
      const ob = txOrderKey(b);

      const asc = sortMode.indexOf('ASC')>=0;
      const flow = sortMode.indexOf('FLOW')>=0;

      if(da!==db){
        return asc ? da.localeCompare(db) : db.localeCompare(da);
      }

      if(!flow){
        // 입력순(같은날): 원본 입력 순서
        return oa - ob;
      }

      // 흐름(같은날): 매입→경비→매출→수금→지급 (+ 같은 흐름은 첫 등장 입력순 유지)
      const ia = txItemSortKey(a);
      const ib = txItemSortKey(b);
      const ra = String(ia||'').startsWith('\uffff') ? 1 : 0;
      const rb = String(ib||'').startsWith('\uffff') ? 1 : 0;
      const ka = flowGroupKey(a);
      const kb = flowGroupKey(b);
      const fa = (__flowFirst.get(ka) ?? oa);
      const fb = (__flowFirst.get(kb) ?? ob);

      return (ra-rb)
        || (fa-fb)
        || (typeFlowWeight(a.type)-typeFlowWeight(b.type))
        || (oa-ob);
    });

    $("qCount").textContent = `${rows.length.toLocaleString("ko-KR")}건`;
    const tb = $("qBody");
    tb.innerHTML = "";
    selectedTxId = null;
    $("btnDeleteOne").disabled = true;

    rows.forEach(t=>{
      const invst = isInvoice(t) ? invoiceSettled(t) : {settled:0, open:0};
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="white-space:nowrap;"><input type="checkbox" class="qSelChk" data-id="${t.id}" ${__qSelectedIds.has(t.id)?"checked":""}></td>
        <td class="mono nowrap">${esc(t.date)}</td>
        <td>${badgeType(t.type)}</td>
        <td>${esc(getName(state.masters.parties, t.partyId))}</td>
        <td>${esc(getName(state.masters.projects, t.projectId))}</td>
        <td>${esc(getName(state.masters.items, t.itemId))}</td>
        <td class="right mono">${t.qty ? fmt(t.qty) : ""}</td>
        <td class="right mono">${(t.qty && (t.type==="SALE"||t.type==="PURCHASE"||t.type==="EXPENSE")) ? fmt(Math.round(toNum(t.total)/toNum(t.qty))) : ""}</td>
        <td class="right mono"><b>${fmt(t.total)}</b></td>
        <td class="right mono">${isInvoice(t)? fmt(invst.settled): "-"}</td>
        <td class="right mono">${isInvoice(t)? `<b>${fmt(invst.open)}</b>`: "-"}</td>
        <td>${isInvoice(t) ? (t.invoiceIssued ? `<span class="badge b-ok">발행</span>` : `<span class="badge b-danger">미발행</span>`) : "-"}</td>
        <td class="mono">${esc(t.invoiceNo||"")}</td>
        <td class="muted">${esc(t.memo||"")}</td>
      `;
      tr.addEventListener("click", (ev)=>{
        loadEdit(t.id);
        try{ tb.querySelectorAll("tr.qActive").forEach(x=>x.classList.remove("qActive")); }catch(e){}
        try{ tr.classList.add("qActive"); }catch(e){}
      });
      tb.appendChild(tr);
    });

    
    // ----- Multi-select sum (quick check) -----
    // ----- Multi-select sums (선택 합계) -----
    function updateQSelUI(){
      try{
        let cnt=0;
        let sales=0, cost=0, recv=0, pay=0, openSum=0;
        rows.forEach(t=>{
          if(!__qSelectedIds.has(t.id)) return;
          cnt += 1;
          const tot = toNum(t.total);
          if(t.type==="SALE") sales += tot;
          else if(t.type==="PURCHASE" || t.type==="EXPENSE") cost += tot;
          else if(t.type==="RECEIPT") recv += tot;
          else if(t.type==="PAYMENT") pay += tot;
          if(isInvoice(t)) openSum += invoiceSettled(t).open;
        });
        const netCash = recv - pay;
        if($("qSelCnt")) $("qSelCnt").textContent = String(cnt);
        if($("qSelSales")) $("qSelSales").textContent = fmt(sales);
        if($("qSelCost")) $("qSelCost").textContent = fmt(cost);
        if($("qSelRecv")) $("qSelRecv").textContent = fmt(recv);
        if($("qSelPay")) $("qSelPay").textContent = fmt(pay);
        if($("qSelOpen")) $("qSelOpen").textContent = fmt(openSum);
        if($("qSelNetCash")) $("qSelNetCash").textContent = fmt(netCash);
        // backward compat
        if($("qSelSum")) $("qSelSum").textContent = fmt(sales+cost+recv+pay);

        const all = $("qSelAll");
        if(all){
          all.checked = (rows.length>0 && rows.every(t=> __qSelectedIds.has(t.id)));
        }
      }catch(e){}
    }

    tb.querySelectorAll(".qSelChk").forEach(ch=>{
      ch.addEventListener("change", ()=>{
        const id = ch.getAttribute("data-id");
        if(!id) return;
        if(ch.checked) __qSelectedIds.add(id);
        else __qSelectedIds.delete(id);
        updateQSelUI();
      });
    });

    const selAll = $("qSelAll");
    if(selAll){
      selAll.onchange = ()=>{
        if(selAll.checked) rows.forEach(t=> __qSelectedIds.add(t.id));
        else rows.forEach(t=> __qSelectedIds.delete(t.id));
        renderSearch();
      };
    }

    if($("qSelClear")){
      $("qSelClear").onclick = ()=>{
        __qSelectedIds.clear();
        renderSearch();
      };
    }

    // 선택 원장(거래처 단일 선택일 때만)
    if($("btnGoLedgerFromSel")){
      $("btnGoLedgerFromSel").onclick = ()=>{
        try{
          const sel = rows.filter(t=>__qSelectedIds.has(t.id));
          if(!sel.length){ alert("선택된 행이 없습니다."); return; }
          const parties = Array.from(new Set(sel.map(t=>t.partyId||""))).filter(Boolean);
          if(parties.length!==1){ alert("선택 원장은 거래처가 1개로 선택되어야 합니다."); return; }
          const partyId = parties[0];
          // 기간은 검색기간이 있으면 그대로, 없으면 이번달
          const from = $("qFrom")?.value || (thisMonth()+"-01");
          const to = $("qTo")?.value || (thisMonth()+"-31");
          if($("ledParty")) $("ledParty").value = partyId;
          if($("ledFrom")) $("ledFrom").value = from;
          if($("ledTo")) $("ledTo").value = to;
          setView("ledger");
          try{ renderLedger(); }catch(e){}
        }catch(e){ alert("선택 원장 이동 실패: " + (e?.message||e)); }
      };
    }

    updateQSelUI();

    lastSearchRows = rows;
  }

  function loadEdit(id){
    const t = state.tx.find(x=>x.id===id);
    if(!t) return;
    selectedTxId = id;
    $("btnDeleteOne").disabled = false;

    $("eDate").value = t.date;
    $("eType").value = t.type;
    $("eParty").value = t.partyId || "";
    $("eProject").value = t.projectId || "";
    $("eItem").value = t.itemId || "";
    $("eQty").value = t.qty || 0;
    $("eAmount").value = t.amount || 0;
    __editAmountTouched = false;
    try{
      const q = toNum(t.qty||0);
      const vm = (t.vatMode||"INCLUDED");
      const baseAmt = (vm==="EXCLUDED") ? toNum(t.amount||0) : toNum(t.total||t.amount||0);
      const u = (q>0) ? Math.round(baseAmt/q) : 0;
      if($("eUnit")) $("eUnit").value = u || "";
    }catch(e){}
    $("eVat").value = t.vatMode || "INCLUDED";
    $("eInv").value = t.invoiceIssued ? "Y" : "N";
    $("eInvNo").value = t.invoiceNo || "";
    $("eMemo").value = t.memo || "";
  }

  function saveEdit(){
    if(!selectedTxId){ alert("수정할 거래를 선택하세요."); return; }
    const t = state.tx.find(x=>x.id===selectedTxId);
    if(!t) return;

    const date = $("eDate").value || today();
    const type = $("eType").value;
    const partyId = $("eParty").value || "";
    const projectId = $("eProject").value || "";
    const itemId = $("eItem").value || "";
    const oldQty = toNum(t.qty||0);
    const oldAmount = toNum(t.amount||0);
    const qty = toNum($("eQty").value||0);
    let amount = toNum($("eAmount").value||0);
    /* AUTO_SCALE_BY_QTY */
    if((type==="SALE"||type==="PURCHASE"||type==="EXPENSE") && oldQty>0 && qty>0 && qty!==oldQty){
      // If user changed qty but left amount unchanged, scale amount automatically
      if(amount===oldAmount){
        amount = Math.round((oldAmount/oldQty) * qty);
      }
    }
    const vatMode = $("eVat").value;
    const { total, vat } = calcVat(amount, vatMode);
    const invoiceIssued = $("eInv").value === "Y";
    const invoiceNo = ($("eInvNo").value||"").trim();
    const memo = ($("eMemo").value||"").trim();
    /* SAFE_EDIT_GUARD */
    const oldType = (t.type||"").toString().toUpperCase();
    const newType = (type||"").toString().toUpperCase();
    const oldIsInv = (oldType==="SALE"||oldType==="PURCHASE"||oldType==="EXPENSE");
    const newIsInv = (newType==="SALE"||newType==="PURCHASE"||newType==="EXPENSE");
    const oldIsCash = (oldType==="RECEIPT"||oldType==="PAYMENT");
    const newIsCash = (newType==="RECEIPT"||newType==="PAYMENT");

    // Prevent converting invoice ↔ cash in-place (it makes original purchase/sale "disappear")
    if(oldIsInv && newIsCash){
      const msg = "이 거래는 계산서(원거래)입니다.\n구분을 수금/지급으로 바꾸면 매입/매출이 '사라진 것처럼' 보입니다.\n\n[권장] 계산서는 유지하고, 별도의 수금/지급 거래를 새로 추가할까요?";
      if(confirm(msg)){
        const cashTx = {
          id: uid(),
          date,
          type: newType,
          partyId, projectId,
          itemId: "", qty: 0,
          amount: amount, vatMode: "ZERO", vat: 0, total: amount,
          invoiceIssued: false, invoiceNo: "", memo: memo || ("자동생성: " + typeLabel(oldType) + " 결제"),
          accountId: t.accountId || (state.masters.accounts.find(a=>a.type==="BANK")?.id || "")
        };
        state.tx.push(cashTx);
        sortTx();
        save("수금/지급 거래를 별도 추가했습니다(계산서는 유지)");
        renderAll();
        return;
      }else{
        alert("계산서 구분은 변경하지 않습니다.\n수금/지급은 새 행으로 입력하세요.");
        $("eType").value = oldType;
        return;
      }
    }
    if(oldIsCash && newIsInv){
      const msg = "이 거래는 수금/지급(현금) 거래입니다.\n구분을 매출/매입으로 바꾸면 거래 성격이 뒤틀립니다.\n\n[권장] 현금 거래는 유지하고, 별도의 계산서(매출/매입/경비)를 새로 추가할까요?";
      if(confirm(msg)){
        const invTx = {
          id: uid(),
          date,
          type: newType,
          partyId, projectId, itemId,
          qty: (newType==="RECEIPT"||newType==="PAYMENT"||newType==="OFFSET") ? 0 : qty,
          amount: amount, vatMode: _vatMode, vat: _vat, total: _total,
          invoiceIssued, invoiceNo, memo,
          accountId: t.accountId || (state.masters.accounts.find(a=>a.type==="BANK")?.id || "")
        };
        state.tx.push(invTx);
        sortTx();
        save("계산서 거래를 별도 추가했습니다(현금거래는 유지)");
        renderAll();
        return;
      }else{
        alert("현금 거래 구분은 변경하지 않습니다.");
        $("eType").value = oldType;
        return;
      }
    }

    // Force receipt/payment to be VAT-free totals
    let _total = total, _vat = vat, _vatMode = vatMode;
    if(newType==="RECEIPT" || newType==="PAYMENT"){
      _total = amount; _vat = 0; _vatMode = "ZERO";
    }


    
    /* ALLOCS_CHANGE_GUARD */
    const relAlloc = state.allocations.filter(a=>a.sourceId===selectedTxId || a.targetId===selectedTxId);
    const changedMaster = (partyId !== (t.partyId||"")) || (projectId !== (t.projectId||"")) || (itemId !== (t.itemId||""));
    const oldRole = (oldType==="SALE") ? "AR" : ((oldType==="PURCHASE"||oldType==="EXPENSE") ? "AP" : "");
    const newRole = (newType==="SALE") ? "AR" : ((newType==="PURCHASE"||newType==="EXPENSE") ? "AP" : "");
    const roleChanged = (oldRole && newRole && oldRole!==newRole);

    if(relAlloc.length && (changedMaster || roleChanged)){
      const msg = "이 거래는 정산(배분) 내역이 연결되어 있습니다.\n거래처/프로젝트/품목 변경 또는 역할(매출↔매입) 변경 시 정산이 꼬일 수 있습니다.\n\n연결된 정산 내역을 삭제하고 계속할까요?";
      if(!confirm(msg)){
        toast("수정을 취소했습니다.");
        return;
      }
      state.allocations = state.allocations.filter(a=>a.sourceId!==selectedTxId && a.targetId!==selectedTxId);
    }

    Object.assign(t, {
      date, type, partyId, projectId, itemId,
      qty: (type==="RECEIPT"||type==="PAYMENT"||type==="OFFSET") ? 0 : qty,
      amount, vatMode, vat, total,
      invoiceIssued, invoiceNo, memo
    });

    sortTx();
    save("수정 저장 완료");
    renderAll();
  }

  function deleteOne(){
    if(!selectedTxId) return;
    const relAlloc = state.allocations.filter(a=>a.sourceId===selectedTxId || a.targetId===selectedTxId);
    const msg = relAlloc.length
      ? `선택 거래는 정산(배분) ${relAlloc.length}건과 연결되어 있습니다.\\n삭제하면 연결된 정산도 같이 삭제됩니다.\\n계속할까요?`
      : "선택 1건을 삭제할까요?";
    if(!confirm(msg)) return;

    state.allocations = state.allocations.filter(a=>a.sourceId!==selectedTxId && a.targetId!==selectedTxId);
    state.tx = state.tx.filter(x=>x.id!==selectedTxId);
    selectedTxId = null;
    $("btnDeleteOne").disabled = true;
    save("삭제 완료");
    renderAll();
  }

  // ===== Export/Import =====
  function exportBackup(){
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `MakeFreeERP_Ultimate_Backup_${today()}.json`;
    document.body.appendChild(a);
    a.click(); a.remove();
    save("백업 JSON 다운로드 완료");
  }

  function importBackup(file){
    const fr = new FileReader();
    fr.onload = ()=>{
      try{
        const data0 = safeParse(fr.result);
        const data = migrateIfNeeded(data0);
        if(!data || !data.masters || !Array.isArray(data.tx)) throw new Error("invalid");
        state.meta = data.meta || state.meta;
        state.masters = data.masters || state.masters;
        state.tx = data.tx || [];
        state.allocations = data.allocations || [];
        sortTx();
        hydrateSelects();
        renderAll();
        save("JSON 불러오기 완료");
      }catch(e){
        alert("JSON 형식이 올바르지 않습니다.");
      }
    };
    fr.readAsText(file, "utf-8");
  }

  function csvEsc(v){
    const s = String(v ?? "");
    if(/[",\\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }

  
  function downloadCsv(filename, rows, header){
    const escCsv = (v)=>{
      const s = String(v ?? "");
      if(/[",\n\r]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
      return s;
    };
    const lines = [];
    lines.push("sep=,");
    lines.push(header.map(escCsv).join(","));
    rows.forEach(r=> lines.push(r.map(escCsv).join(",")));
    const bom = "\ufeff";
    const blob = new Blob([bom + lines.join("\r\n")], {type:"text/csv;charset=utf-8"});
    const a=document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click(); a.remove();
  }
  function downloadTsv(filename, rows, header){
    const escTsv = (v)=> String(v ?? "").replace(/\t/g," ").replace(/\r?\n/g," ");
    const lines = [];
    lines.push(header.map(escTsv).join("\t"));
    rows.forEach(r=> lines.push(r.map(escTsv).join("\t")));
    const bom = "\ufeff";
    const blob = new Blob([bom + lines.join("\r\n")], {type:"text/tab-separated-values;charset=utf-8"});
    const a=document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click(); a.remove();
  }


  function exportSelectedCsv(rows){
    try{
      const picked = rows.filter(t=> __qSelectedIds.has(t.id));
      if(!picked.length){ alert("선택된 항목이 없습니다."); return; }
      const out = picked.map(t=>{
        const invst = isInvoice(t)? invoiceSettled(t) : {settled:"", open:""};
        const unit = (t.qty && (t.type==="SALE"||t.type==="PURCHASE"||t.type==="EXPENSE")) ? Math.round(toNum(t.total)/toNum(t.qty)) : "";
        return ({
          date:t.date,
          type:typeLabel(t.type),
          party:getName(state.masters.parties,t.partyId),
          project:getName(state.masters.projects,t.projectId)||"",
          item:getName(state.masters.items,t.itemId),
          qty:t.qty,
          unit:unit,
          total:t.total,
          settled: isInvoice(t)? invst.settled : "",
          open: isInvoice(t)? invst.open : "",
          invoice: (isInvoice(t) ? (t.invoiceIssued?"Y":"N") : ""),
          invoiceNo:t.invoiceNo||"",
          memo:(t.memo||"").replace(/\n/g," ")
        });
      });
      const header = Object.keys(out[0]).join(",");
      const body = out.map(r=>Object.values(r).map(csvEsc).join(",")).join("\n");
      const csv = header + "\n" + body;
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `MakeFreeERP_Selected_${today()}.csv`;
      document.body.appendChild(a);
      a.click(); a.remove();
    }catch(e){ alert("선택 CSV 내보내기 실패: "+(e?.message||e)); }
  }
function exportSearchCsv(){
    const rows = lastSearchRows.length ? lastSearchRows : state.tx;
    if(!rows.length){ alert("내보낼 데이터가 없습니다."); return; }

    const out = rows.map(t=>{
      const invst = isInvoice(t)? invoiceSettled(t) : {settled:"", open:""};
      return ({
        date:t.date,
        type:typeLabel(t.type),
        party:getName(state.masters.parties,t.partyId),
        project:getName(state.masters.projects,t.projectId),
        item:getName(state.masters.items,t.itemId),
        qty:t.qty,
        unit: (t.qty && (t.type==="SALE"||t.type==="PURCHASE"||t.type==="EXPENSE")) ? Math.round(toNum(t.total)/toNum(t.qty)) : "",
        total:t.total,
        settled: isInvoice(t)? invst.settled : "",
        open: isInvoice(t)? invst.open : "",
        invoice:(isInvoice(t) ? (t.invoiceIssued?"Y":"N") : ""),
        invoiceNo:t.invoiceNo||"",
        memo:(t.memo||"").replace(/\\n/g," ")
      });
    });

    const header = Object.keys(out[0]).join(",");
    const body = out.map(r=>Object.values(r).map(csvEsc).join(",")).join("\\n");
    const csv = header + "\\n" + body;

    const bom="\ufeff";
    const csv2="sep=,\n"+csv;
    const blob = new Blob([bom+csv2], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `MakeFreeERP_Search_${today()}.csv`;
    document.body.appendChild(a);
    a.click(); a.remove();
    save("CSV 내보내기 완료");
  }

  // ===== AR/AP =====
  let arapSelectedPartyId = "";
  
  function renderAgedList(){
    const tb = $("agedBody");
    if(!tb) return;
    const days = toNum($("agedDaysArAp")?.value||60);
    const showAR = !!$("agedShowAR")?.checked;
    const showAP = !!$("agedShowAP")?.checked;

    const list = [];
    (state.tx||[]).forEach(t=>{
      if(!(t.type==="SALE"||t.type==="PURCHASE"||t.type==="EXPENSE")) return;
      if(t.type==="SALE" && !showAR) return;
      if((t.type==="PURCHASE"||t.type==="EXPENSE") && !showAP) return;
      const open = invoiceSettled(t).open;
      if(open<=0) return;
      const age = ageDays(t.date);
      if(age < days) return;

      const party = getName(state.masters.parties, t.partyId) || "(미상)";
      const proj = getName(state.masters.projects, t.projectId) || (t.projectId? "(삭제됨)":"(미지정)");
      const item = getName(state.masters.items, t.itemId) || "";

      list.push({t, open, age, party, proj, item});
    });

    list.sort((a,b)=> b.age - a.age || b.open - a.open);
    tb.innerHTML = "";
    if(!list.length){
      tb.innerHTML = `<tr><td colspan="10" class="muted">표시할 장기 미수/미지급이 없습니다.</td></tr>`;
      return;
    }

    list.slice(0,200).forEach(r=>{
      const t = r.t;
      const tr = document.createElement("tr");
      tr.style.cursor="pointer";
      tr.innerHTML = `
        <td class="mono"><b>${r.age}일</b></td>
        <td>${esc(t.date||"")}</td>
        <td>${badgeType(t.type)}</td>
        <td><b>${esc(r.party)}</b></td>
        <td class="muted">${esc(r.proj)}</td>
        <td>${esc(r.item)}</td>
        <td class="right mono"><b>${fmt(r.open)}</b></td>
        <td>${t.invoiceIssued ? '<span class="badge b-ok">발행</span>' : '<span class="badge b-danger">미발행</span>'}</td>
        <td class="mono">${esc(t.invoiceNo||"")}</td>
        <td class="muted">${esc(t.memo||"")}</td>
      `;
      tr.addEventListener("click", ()=>{
        setView("search");
        if($("qParty")) $("qParty").value = t.partyId || "";
        if($("qProject")) $("qProject").value = t.projectId || "";
        if($("qItem")) $("qItem").value = t.itemId || "";
        if(t.type==="SALE") quickSetTypes(["SALE"]);
        else quickSetTypes(["PURCHASE","EXPENSE"]);
        if($("qSettle")) $("qSettle").value = "OPEN";
        renderSearch();
      });
      tb.appendChild(tr);
    });
  }

function renderARAP(){
    try{ renderArapPeriod(); }catch(e){}
    $("kpiAR").textContent = fmt(totalAROpenAll());
    $("kpiAP").textContent = fmt(totalAPOpenAll());

    const q = ($("arapText").value||"").trim().toLowerCase();
    const rows = state.masters.parties.map(p=>{
      const ar = partyAROpen(p.id);
      const ap = partyAPOpen(p.id);
      return {id:p.id, name:p.name, ar, ap, net: ar-ap};
    
    try{ renderAgedList(); }catch(e){}
  }).filter(r=> !q || (r.name||"").toLowerCase().includes(q))
      .sort((a,b)=> (Math.abs(b.ar)+Math.abs(b.ap)) - (Math.abs(a.ar)+Math.abs(a.ap)));

    const tb = $("arapBody");
    tb.innerHTML = "";
    arapSelectedPartyId = "";

    rows.forEach(r=>{
      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.innerHTML = `
        <td><b>${esc(r.name)}</b></td>
        <td class="right mono"><span class="linklike arapOpen" data-party="${r.id}" data-role="AR"><b>${fmt(r.ar)}</b></span></td>
        <td class="right mono"><span class="linklike arapOpen" data-party="${r.id}" data-role="AP"><b>${fmt(r.ap)}</b></span></td>
        <td class="right mono muted">${fmt(r.net)}</td>
      `;
      tr.querySelectorAll(".arapOpen").forEach(el=>{
        el.addEventListener("click",(ev)=>{
          ev.preventDefault();
          ev.stopPropagation();
          const partyId = el.getAttribute("data-party");
          const role = el.getAttribute("data-role");
          // Ctrl/Meta 키를 누르면 기존처럼 검색 화면으로 이동
          if(ev.ctrlKey || ev.metaKey){
            setView("search");
            $("qParty").value = partyId;
            if(role==="AR") quickSetTypes(["SALE"]);
            else quickSetTypes(["PURCHASE","EXPENSE"]);
            $("qSettle").value = "OPEN";
            $("qInvoice").value = "";
            renderSearch();
          }else{
            openArapDetail(partyId, role);
          }
        });
      });
tr.addEventListener("click", ()=>{
        arapSelectedPartyId = r.id;
        Array.from(tb.querySelectorAll("tr")).forEach(x=>x.style.background="");
        tr.style.background = "rgba(37,99,235,.07)";
      });
      tb.appendChild(tr);
    });
  }

  // ===== Settlement =====
  let settleSelectedSourceId = "";
  let settleSelectedTargetId = "";

  function addAllocation(sourceId, targetId, amount, role, memo){
    state.allocations.push({
      id: uid(),
      sourceId,
      targetId,
      amount: Math.round(toNum(amount)),
      role,
      memo: memo || "",
      createdAt: new Date().toISOString()
    });
  }

  function autoAllocateOffset(offsetSourceId, partyId, amount){
    const rule = $("sAutoRule").value || "FIFO";
    const key = (x)=> x.date + x.id;

    let arTargets = state.tx.filter(t=>t.partyId===partyId && t.type==="SALE" && toNum(t.total)>0).filter(t=>invoiceSettled(t).open>0);
    let apTargets = state.tx.filter(t=>t.partyId===partyId && (t.type==="PURCHASE"||t.type==="EXPENSE") && toNum(t.total)>0).filter(t=>invoiceSettled(t).open>0);

    arTargets.sort((a,b)=> rule==="FIFO" ? key(a).localeCompare(key(b)) : key(b).localeCompare(key(a)));
    apTargets.sort((a,b)=> rule==="FIFO" ? key(a).localeCompare(key(b)) : key(b).localeCompare(key(a)));

    let remAR = amount;
    for(const t of arTargets){
      const open = invoiceSettled(t).open;
      const use = Math.min(remAR, open);
      if(use>0){ addAllocation(offsetSourceId, t.id, use, "AR", "상계(AR)"); remAR -= use; }
      if(remAR<=0) break;
    }

    let remAP = amount;
    for(const t of apTargets){
      const open = invoiceSettled(t).open;
      const use = Math.min(remAP, open);
      if(use>0){ addAllocation(offsetSourceId, t.id, use, "AP", "상계(AP)"); remAP -= use; }
      if(remAP<=0) break;
    }
  }

  function renderSettle(){
    const partyId = $("sParty").value || "";
    const mode = $("sMode").value || "AR";

    try{ if(partyId){ mfRecentPartyAdd(partyId); mfRenderRecentPartyBtns(); } }catch(e){}
    try{ mfRenderPinnedPartyBtns(); mfEnsureSettleTargetFilterUI(); }catch(e){}

    $("sPayTitle").textContent = (mode==="AR") ? "수금(미배분)" : (mode==="AP") ? "지급(미배분)" : "OFFSET(상계) 생성";
    $("sInvTitle").textContent = (mode==="AR") ? "매출(미정산)" : (mode==="AP") ? "매입/경비(미정산)" : "AR/AP 대상(동시)";

    $("sArOpen").textContent = fmt(partyId ? partyAROpen(partyId) : 0);
    $("sApOpen").textContent = fmt(partyId ? partyAPOpen(partyId) : 0);

    settleSelectedSourceId = "";
    settleSelectedTargetId = "";

    renderSettleSourceList(partyId, mode);
    renderSettleTargetList(partyId, mode);
    renderAllocLog(partyId, mode);
  }

  function renderSettleSourceList(partyId, mode){
    const tb = $("sPayBody");
    tb.innerHTML = "";

    if(!partyId){
      tb.innerHTML = `<tr><td colspan="6" class="muted">거래처를 선택하세요.</td></tr>`;
      return;
    }

    let sources = [];
    if(mode==="AR"){
      sources = state.tx.filter(t=>t.partyId===partyId && t.type==="RECEIPT" && toNum(t.total)>0)
        .filter(s=> sourceRemaining(s,"AR").rem > 0);
    }else if(mode==="AP"){
      sources = state.tx.filter(t=>t.partyId===partyId && t.type==="PAYMENT" && toNum(t.total)>0)
        .filter(s=> sourceRemaining(s,"AP").rem > 0);
    }else{
      tb.innerHTML = `<tr><td colspan="6" class="muted">OFFSET 모드: 금액을 입력하고 실행하면 상계(OFFSET) 원천이 자동 생성됩니다.</td></tr>`;
      return;
    }

    sources.sort((a,b)=> (a.date+a.id).localeCompare(b.date+b.id));

    if(!sources.length){
      tb.innerHTML = `<tr><td colspan="6" class="muted">미배분 원천이 없습니다.</td></tr>`;
      return;
    }

    sources.forEach(s=>{
      const role = (mode==="AR") ? "AR" : "AP";
      const {used, rem} = sourceRemaining(s, role);
      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.innerHTML = `
        <td>${esc(s.date)}</td>
        <td>${badgeType(s.type)}</td>
        <td class="right mono"><b>${fmt(s.total)}</b></td>
        <td class="right mono">${fmt(used)}</td>
        <td class="right mono"><b>${fmt(rem)}</b></td>
        <td class="muted">${esc(s.memo||"")}</td>
      `;
      try{
        if(window.__mf_focus_source_id && window.__mf_focus_source_id===s.id){
          settleSelectedSourceId = s.id;
          tr.style.background = "rgba(5,150,105,.08)";
          window.__mf_focus_source_id = "";
        }
      }catch(e){}
      tr.addEventListener("click", ()=>{
        settleSelectedSourceId = s.id;
        Array.from(tb.querySelectorAll("tr")).forEach(x=>x.style.background="");
        tr.style.background = "rgba(5,150,105,.08)";
      });
      tb.appendChild(tr);
    });
  }

  function renderSettleTargetList(partyId, mode){
    const tb = $("sInvBody");
    tb.innerHTML = "";

    if(!partyId){
      tb.innerHTML = `<tr><td colspan="8" class="muted">거래처를 선택하세요.</td></tr>`;
      return;
    }

    let targets = [];
    if(mode==="AR"){
      targets = state.tx.filter(t=>t.partyId===partyId && t.type==="SALE" && toNum(t.total)>0)
        .filter(t=> invoiceSettled(t).open > 0);
    }else if(mode==="AP"){
      targets = state.tx.filter(t=>t.partyId===partyId && (t.type==="PURCHASE"||t.type==="EXPENSE") && toNum(t.total)>0)
        .filter(t=> invoiceSettled(t).open > 0);
    }else{
      const arTargets = state.tx.filter(t=>t.partyId===partyId && t.type==="SALE" && toNum(t.total)>0).filter(t=>invoiceSettled(t).open>0);
      const apTargets = state.tx.filter(t=>t.partyId===partyId && (t.type==="PURCHASE"||t.type==="EXPENSE") && toNum(t.total)>0).filter(t=>invoiceSettled(t).open>0);
      targets = arTargets.concat(apTargets);
    }

    const rule = $("sAutoRule").value || "FIFO";
    targets.sort((a,b)=>{
      const ka = a.date+a.id, kb=b.date+b.id;
      return rule==="FIFO" ? ka.localeCompare(kb) : kb.localeCompare(ka);
    });

    if(!targets.length){
      tb.innerHTML = `<tr><td colspan="8" class="muted">미정산 대상이 없습니다.</td></tr>`;
      return;
    }

    targets.forEach(t=>{
      const invst = invoiceSettled(t);
      const __projN = getName(state.masters.projects, t.projectId) || "";
      const __itemN = getName(state.masters.items, t.itemId) || "";
      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.innerHTML = `
        <td class="mono nowrap">${esc(t.date)}</td>
        <td>${badgeType(t.type)}</td>
        <td class="right mono"><b>${fmt(t.total)}</b></td>
        <td class="right mono">${fmt(invst.settled)}</td>
        <td class="right mono"><b>${fmt(invst.open)}</b></td>
        <td class="mono">${esc(t.invoiceNo||"")}</td>
        <td class="muted">${esc(t.memo||"")}</td>
        <td class="right"><span class="badge">${t.type==="SALE"?"AR":"AP"}</span></td>
      `;
      tr.dataset.search = `${t.date||""} ${t.invoiceNo||""} ${t.memo||""} ${__projN} ${__itemN}`;
      tr.addEventListener("click", ()=>{
        settleSelectedTargetId = t.id;
        Array.from(tb.querySelectorAll("tr")).forEach(x=>x.style.background="");
        tr.style.background = "rgba(217,119,6,.10)";
      });
      tb.appendChild(tr);
    });

    try{ mfApplySettleTargetFilter(); }catch(e){}
  }

  function renderAllocLog(partyId, mode){
    const tb = $("sAllocBody");
    tb.innerHTML = "";

    if(!partyId){
      tb.innerHTML = `<tr><td colspan="6" class="muted">거래처를 선택하세요.</td></tr>`;
      return;
    }

    const allocs = state.allocations
      .filter(a=>{
        const s = state.tx.find(t=>t.id===a.sourceId);
        const t = state.tx.find(t=>t.id===a.targetId);
        if(!s || !t) return false;
        if(s.partyId !== partyId || t.partyId !== partyId) return false;
        if(mode==="AR") return a.role==="AR";
        if(mode==="AP") return a.role==="AP";
        return true;
      })
      .sort((a,b)=> (a.createdAt||"").localeCompare(b.createdAt||""));

    if(!allocs.length){
      tb.innerHTML = `<tr><td colspan="6" class="muted">정산 내역이 없습니다.</td></tr>`;
      return;
    }

    allocs.forEach(a=>{
      const s = state.tx.find(t=>t.id===a.sourceId);
      const t = state.tx.find(t=>t.id===a.targetId);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc((a.createdAt||"").slice(0,10))}</td>
        <td>${badgeType(s?.type||"")}&nbsp;${esc(s?.date||"")}&nbsp;<span class="muted mono">${esc(s?.memo||"")}</span></td>
        <td>${badgeType(t?.type||"")}&nbsp;${esc(t?.date||"")}&nbsp;<span class="muted mono">${esc(t?.invoiceNo||"")}</span></td>
        <td class="right mono"><b>${fmt(a.amount)}</b></td>
        <td class="muted">${esc(a.role)} ${esc(a.memo||"")}</td>
        <td class="right"><button class="btn danger tiny" data-delalloc="${a.id}">삭제</button></td>
      `;
      tb.appendChild(tr);
    });

    tb.querySelectorAll("[data-delalloc]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-delalloc");
        if(!confirm("이 정산(배분) 1건을 삭제할까요?")) return;
        state.allocations = state.allocations.filter(x=>x.id!==id);
        save("정산 내역 삭제");
        renderAll();
        setView("settle");
      });
    });
  }

  function autoSettle(){
    const partyId = $("sParty").value || "";
    const mode = $("sMode").value || "AR";
    const rule = $("sAutoRule").value || "FIFO";
    if(!partyId){ alert("거래처를 선택하세요."); return; }
    if(mode==="OFFSET"){
      alert("OFFSET(상계)은 금액 입력 후 실행하세요.");
      return;
    }

    let sources = [];
    let targets = [];

    if(mode==="AR"){
      sources = state.tx.filter(t=>t.partyId===partyId && t.type==="RECEIPT" && toNum(t.total)>0)
        .filter(s=> sourceRemaining(s,"AR").rem > 0);
      targets = state.tx.filter(t=>t.partyId===partyId && t.type==="SALE" && toNum(t.total)>0)
        .filter(t=> invoiceSettled(t).open > 0);
    }else{
      sources = state.tx.filter(t=>t.partyId===partyId && t.type==="PAYMENT" && toNum(t.total)>0)
        .filter(s=> sourceRemaining(s,"AP").rem > 0);
      targets = state.tx.filter(t=>t.partyId===partyId && (t.type==="PURCHASE"||t.type==="EXPENSE") && toNum(t.total)>0)
        .filter(t=> invoiceSettled(t).open > 0);
    }

    const key = (x)=> x.date + x.id;
    sources.sort((a,b)=> rule==="FIFO" ? key(a).localeCompare(key(b)) : key(b).localeCompare(key(a)));
    targets.sort((a,b)=> rule==="FIFO" ? key(a).localeCompare(key(b)) : key(b).localeCompare(key(a)));

    let count = 0;
    for(const s of sources){
      let rem = sourceRemaining(s, mode==="AR"?"AR":"AP").rem;
      if(rem<=0) continue;

      for(const t of targets){
        const open = invoiceSettled(t).open;
        if(open<=0) continue;
        const use = Math.min(rem, open);
        if(use<=0) continue;

        addAllocation(s.id, t.id, use, mode==="AR"?"AR":"AP", "자동정산");
        count++;
        rem -= use;
        if(rem<=0) break;
      }
    }

    save(count ? `자동 정산 완료(${count}건 배분)` : "자동 정산할 대상이 없습니다");
    renderAll();
    setView("settle");
  }

  function manualAllocate(){
    const partyId = $("sParty").value || "";
    const mode = $("sMode").value || "AR";
    const amt = toNum($("sManualAmt").value||0);
    if(!partyId){ alert("거래처를 선택하세요."); return; }
    if(amt<=0){ alert("금액을 입력하세요."); return; }

    if(mode==="OFFSET"){
      const arOpen = partyAROpen(partyId);
      const apOpen = partyAPOpen(partyId);
      const maxAmt = Math.min(arOpen, apOpen);
      if(maxAmt<=0){ alert("상계할 AR/AP 잔액이 없습니다."); return; }
      const useAmt = Math.min(amt, maxAmt);

      const offsetTx = {
        id: uid(),
        date: today(),
        type: "OFFSET",
        partyId,
        projectId: "",
        itemId: "",
        qty: 0,
        amount: useAmt,
        vatMode: "ZERO",
        vat: 0,
        total: useAmt,
        invoiceIssued: false,
        invoiceNo: "",
        memo: `수동상계 ${fmt(useAmt)}`,
        accountId: state.masters.accounts.find(a=>a.type==="BANK")?.id || ""
      };
      state.tx.push(offsetTx);
      sortTx();
      autoAllocateOffset(offsetTx.id, partyId, useAmt);

      $("sManualAmt").value = "";
      save("수동 상계 + 배분 완료");
      renderAll();
      setView("settle");
      return;
    }

    if(!settleSelectedSourceId || !settleSelectedTargetId){
      alert("원천 1건 + 대상 1건을 선택하세요.");
      return;
    }

    const source = state.tx.find(t=>t.id===settleSelectedSourceId);
    const target = state.tx.find(t=>t.id===settleSelectedTargetId);
    if(!source || !target){ alert("선택된 건을 찾을 수 없습니다."); return; }

    if(mode==="AR"){
      if(source.type!=="RECEIPT"){ alert("AR 정산 원천은 수금(RECEIPT)만 가능합니다."); return; }
      if(target.type!=="SALE"){ alert("AR 정산 대상은 매출(SALE)만 가능합니다."); return; }
      const srem = sourceRemaining(source,"AR").rem;
      const open = invoiceSettled(target).open;
      const useAmt = Math.min(amt, srem, open);
      if(useAmt<=0){ alert("배분 가능한 잔액이 없습니다."); return; }
      addAllocation(source.id, target.id, useAmt, "AR", "수동배분");
    }else{
      if(source.type!=="PAYMENT"){ alert("AP 정산 원천은 지급(PAYMENT)만 가능합니다."); return; }
      if(!(target.type==="PURCHASE"||target.type==="EXPENSE")){ alert("AP 정산 대상은 매입/경비만 가능합니다."); return; }
      const srem = sourceRemaining(source,"AP").rem;
      const open = invoiceSettled(target).open;
      const useAmt = Math.min(amt, srem, open);
      if(useAmt<=0){ alert("배분 가능한 잔액이 없습니다."); return; }
      addAllocation(source.id, target.id, useAmt, "AP", "수동배분");
    }

    $("sManualAmt").value = "";
    save("수동 배분 완료");
    renderAll();
    setView("settle");
  }

  function unallocateAllForParty(){
    const partyId = $("sParty").value || "";
    if(!partyId){ alert("거래처를 선택하세요."); return; }
    if(!confirm("이 거래처의 정산(배분) 내역을 전부 삭제할까요?")) return;

    state.allocations = state.allocations.filter(a=>{
      const s = state.tx.find(t=>t.id===a.sourceId);
      const t = state.tx.find(t=>t.id===a.targetId);
      if(!s || !t) return false;
      return !(s.partyId===partyId && t.partyId===partyId);
    });

    save("정산 전체 해제 완료");
    renderAll();
    setView("settle");
  }

  // ===== Project report =====
  function renderProjectInit(){
    $("pmMonth").value = thisMonth();
    $("pyYear").value = new Date().getFullYear();
    $("pmProject").value = ""; // default: 전체(프로젝트 미선택)
    runProjectMonth();
    runProjectYear();
  }

  function runProjectMonth(){
    const mth = $("pmMonth")?.value || thisMonth();
    const pid = $("pmProject")?.value || ""; // '' means 전체/프로젝트 미선택

    // 1) 월 전체(또는 선택 프로젝트) 손익 KPI
    const baseRows = state.tx.filter(t => (t.date||"").startsWith(mth) && (!pid || t.projectId===pid) && (t.type==="SALE"||t.type==="PURCHASE"||t.type==="EXPENSE"));
    const sales = sum(baseRows, t=> t.type==="SALE" ? t.total : 0);
    const cost  = sum(baseRows, t=> (t.type==="PURCHASE"||t.type==="EXPENSE") ? t.total : 0);
    const profit = sales - cost;
    if($("pmSales")) $("pmSales").textContent = fmt(sales);
    if($("pmCost"))  $("pmCost").textContent  = fmt(cost);
    if($("pmProfit"))$("pmProfit").textContent= fmt(profit);
    if($("pmMargin")) $("pmMargin").textContent = (sales>0 ? ((profit/sales)*100).toFixed(1) : "0.0") + "%";


    // 1-1) 프로젝트/미지정/전체 손익 요약(이달)
    try{
      const mRows = state.tx.filter(t=> (t.date||"").startsWith(mth) && (t.type==="SALE"||t.type==="PURCHASE"||t.type==="EXPENSE"));
      const projRows = mRows.filter(t=> (t.projectId||"").toString().trim());
      const nonRows  = mRows.filter(t=> !(t.projectId||"").toString().trim());

      const calc = (arr)=>{
        const s = sum(arr, t=> t.type==="SALE" ? t.total : 0);
        const c = sum(arr, t=> (t.type==="PURCHASE"||t.type==="EXPENSE") ? t.total : 0);
        return {sales:s, cost:c, profit:(s-c)};
      };
      const P = calc(projRows);
      const N = calc(nonRows);
      const T = calc(mRows);

      if($("pmPSales")) $("pmPSales").textContent = fmt(P.sales);
      if($("pmPCost"))  $("pmPCost").textContent  = fmt(P.cost);
      if($("pmPProfit"))$("pmPProfit").textContent= fmt(P.profit);

      if($("pmNSales")) $("pmNSales").textContent = fmt(N.sales);
      if($("pmNCost"))  $("pmNCost").textContent  = fmt(N.cost);
      if($("pmNProfit"))$("pmNProfit").textContent= fmt(N.profit);

      if($("pmTSales")) $("pmTSales").textContent = fmt(T.sales);
      if($("pmTCost"))  $("pmTCost").textContent  = fmt(T.cost);
      if($("pmTProfit"))$("pmTProfit").textContent= fmt(T.profit);

      if($("pmSplitCard")) $("pmSplitCard").style.display = "";
    }catch(e){}


    // 2) 프로젝트 요약(프로젝트 미선택일 때만 표시)
    const allCard = $("pmAllCard");
    const allBody = $("pmAllBody");
    if(allCard) allCard.style.display = pid ? "none" : "";
    if(allBody){
      allBody.innerHTML = "";
      if(!pid){
        const map = new Map();
        state.tx.filter(t => (t.date||"").startsWith(mth) && (t.type==="SALE"||t.type==="PURCHASE"||t.type==="EXPENSE")).forEach(t=>{
          const p = t.projectId || "";
          const cur = map.get(p) || {sales:0, cost:0};
          if(t.type==="SALE") cur.sales += toNum(t.total);
          else cur.cost += toNum(t.total);
          map.set(p, cur);
        });
        const items = Array.from(map.entries()).map(([p,v])=>{
          const pr = v.sales - v.cost;
          return {pid:p, sales:v.sales, cost:v.cost, profit:pr};
        }).sort((a,b)=> b.profit - a.profit);

        if(items.length===0){
          allBody.innerHTML = `<tr><td colspan="5" class="muted">해당 월에 프로젝트 거래가 없습니다.</td></tr>`;
        }else{
          items.forEach(x=>{
            const name = x.pid ? (getName(state.masters.projects, x.pid) || "(삭제됨)") : "기본(미지정)";
            const margin = x.sales>0 ? ((x.profit/x.sales)*100).toFixed(1)+"%" : "0.0%";
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><span class="linklike" data-act="pmPick" data-pid="${x.pid}">${esc(name)}</span></td>
              <td class="right mono">${fmt(x.sales)}</td>
              <td class="right mono">${fmt(x.cost)}</td>
              <td class="right mono"><b>${fmt(x.profit)}</b></td>
              <td class="right mono">${margin}</td>
            `;
            allBody.appendChild(tr);
          });

          // click handler: go to search/조합 with month + project
          allBody.querySelectorAll('[data-act="pmPick"]').forEach(el=>{
            el.addEventListener('click', ()=>{
              const pid2 = el.getAttribute('data-pid') || "";
              // set search range to this month
              try{
                $("qFrom").value = mth + "-01";
                $("qTo").value = mth + "-31";
                $("qProject").value = pid2;
                // types: sale/purchase/expense
                quickSetTypes(["SALE","PURCHASE","EXPENSE"]);
                $("qInvoice").value = "";
                $("qSettle").value = "";
              }catch(e){}
              setView('search');
              try{ renderSearch(); }catch(e){}
            });
          });
        }
      }
    }

    // 3) 상세 거래내역(선택 프로젝트일 때만, 토글 상태에 따라)
    const wrap = $("pmDetailWrap");
    const tb = $("pmBody");
    const showDetail = !!pid && wrap && wrap.style.display!=="none";
    if(tb){
      tb.innerHTML = "";
      if(showDetail){
        baseRows.sort((a,b)=> (a.date+a.id).localeCompare(b.date+b.id)).forEach(t=>{
          const open = isInvoice(t) ? invoiceSettled(t).open : 0;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${esc(t.date||"")}</td>
            <td>${badgeType(t.type)}</td>
            <td>${esc(getName(state.masters.parties, t.partyId))}</td>
            <td class="muted">${esc(getName(state.masters.projects, t.projectId) || (t.projectId?"(삭제됨)":"기본(미지정)"))}</td>
            <td>${esc(getName(state.masters.items, t.itemId))}</td>
            <td class="right mono"><b>${fmt(t.total)}</b></td>
            <td class="right mono">${isInvoice(t)? `<b>${fmt(open)}</b>` : "-"}</td>
            <td>${isInvoice(t) ? (t.invoiceIssued ? `<span class="badge b-ok">발행</span>` : `<span class="badge b-danger">미발행</span>`) : "-"}</td>
            <td class="muted">${esc(t.memo||"")}</td>
          `;
          tb.appendChild(tr);
        });
      }else if(pid && wrap){
        // when project selected but detail hidden, show a hint row
        tb.innerHTML = `<tr><td colspan="9" class="muted">상세가 숨김 상태입니다. 위의 “상세” 버튼을 눌러 펼칠 수 있습니다.</td></tr>`;
      }
    }
  }

  function runProjectYear(){
    const y = String($("pyYear").value || new Date().getFullYear());
    const pid = $("pmProject").value || "";
    const tb = $("pyBody");
    tb.innerHTML = "";
    for(let mm=1; mm<=12; mm++){
      const m = y + "-" + String(mm).padStart(2,"0");
      const rows = state.tx.filter(t => (t.date||"").startsWith(m) && (!pid || t.projectId===pid) && (t.type==="SALE"||t.type==="PURCHASE"||t.type==="EXPENSE"));
      const sales = sum(rows, t=> t.type==="SALE" ? t.total : 0);
      const cost = sum(rows, t=> (t.type==="PURCHASE"||t.type==="EXPENSE") ? t.total : 0);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${m}</td>
        <td class="right mono">${fmt(sales)}</td>
        <td class="right mono">${fmt(cost)}</td>
        <td class="right mono"><b>${fmt(sales-cost)}</b></td>
      `;
      tb.appendChild(tr);
    }
  }

  // ===== Accounts =====
  function cashFlow(){
    const recv = sum(state.tx, t=> t.type==="RECEIPT" ? t.total : 0);
    const pay  = sum(state.tx, t=> t.type==="PAYMENT" ? t.total : 0);
    return { recv, pay, net: recv - pay };
  }

  function renderBase(){
    const AR = totalAROpenAll();
    const AP = totalAPOpenAll();
    const flow = cashFlow();
    const bankOpen = state.masters.accounts.filter(a=>a.type==="BANK").reduce((acc,a)=>acc+toNum(a.opening),0);
    const loanOpen = state.masters.accounts.filter(a=>a.type==="LOAN").reduce((acc,a)=>acc+toNum(a.opening),0);
    const bankNow = bankOpen + flow.net;
    const netWorth = bankNow - loanOpen + AR - AP;

    $("bankSum").textContent = fmt(bankNow);
    $("loanSum").textContent = fmt(loanOpen);
    $("netWorth").textContent = fmt(netWorth);

    const tb = $("accBody");
    tb.innerHTML = "";
    state.masters.accounts.forEach(a=>{
      const cur = a.type==="BANK" ? (toNum(a.opening) + flow.net) : toNum(a.opening);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(a.type)}</td>
        <td>${esc(a.name)}</td>
        <td class="right mono">${fmt(a.opening)}</td>
        <td class="right mono"><b>${fmt(cur)}</b></td>
        <td class="right"><button class="btn danger tiny" data-delacc="${a.id}">삭제</button></td>
      `;
      tb.appendChild(tr);
    });

    tb.querySelectorAll("[data-delacc]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-delacc");
        if(!confirm("계정을 삭제할까요?")) return;
        state.masters.accounts = state.masters.accounts.filter(x=>x.id!==id);
        save("계정 삭제 완료");
        renderBase();
      });
    });
  }

  function addAccount(){
    const type = $("aType").value;
    const name = ($("aName").value||"").trim();
    const opening = toNum($("aOpen").value||0);
    if(!name){ alert("계정명을 입력하세요."); return; }
    state.masters.accounts.push({id:uid(), type, name, opening});
    $("aName").value=""; $("aOpen").value="";
    save("계정 추가 완료");
    renderBase();
  }

  // ===== Masters =====
  function renderMasters(){
    const ptb=$("partyBody"); ptb.innerHTML="";
    state.masters.parties.forEach(p=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${esc(p.name)}</td><td class="right"><button class="btn danger tiny" data-delparty="${p.id}">삭제</button></td>`;
      ptb.appendChild(tr);
    });
    ptb.querySelectorAll("[data-delparty]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id=btn.getAttribute("data-delparty");
        if(!confirm("삭제할까요?")) return;
        state.masters.parties = state.masters.parties.filter(x=>x.id!==id);
        save("거래처 삭제");
        hydrateSelects();
        renderAll();
      });
    });

    const projTb=$("projBody"); projTb.innerHTML="";
    state.masters.projects.forEach(p=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${esc(p.name)}</td><td class="right"><button class="btn danger tiny" data-delproj="${p.id}">삭제</button></td>`;
      projTb.appendChild(tr);
    });
    projTb.querySelectorAll("[data-delproj]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id=btn.getAttribute("data-delproj");
        if(!confirm("삭제할까요?")) return;
        state.masters.projects = state.masters.projects.filter(x=>x.id!==id);
        save("프로젝트 삭제");
        hydrateSelects();
        renderAll();
      });
    });

    const itemTb=$("itemBody"); itemTb.innerHTML="";
    state.masters.items.forEach(i=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${esc(i.name)}</td><td class="right"><button class="btn danger tiny" data-delitem="${i.id}">삭제</button></td>`;
      itemTb.appendChild(tr);
    });
    itemTb.querySelectorAll("[data-delitem]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id=btn.getAttribute("data-delitem");
        if(!confirm("삭제할까요?")) return;
        state.masters.items = state.masters.items.filter(x=>x.id!==id);
        save("품목 삭제");
        hydrateSelects();
        renderAll();
      });
    });
  }

  function addMaster(kind){
    if(kind==="party"){
      const name = ($("mParty").value||"").trim();
      if(!name) return;
      
      const k = normMasterName(name);
      const exists = state.masters.parties.some(x=> normMasterName((x?.name||"")) === k);
      if(exists){ alert("이미 등록된 거래처입니다: " + name); return; }
findOrCreate(state.masters.parties, name);
      $("mParty").value="";
      save("거래처 추가");
    }
    if(kind==="proj"){
      const name = ($("mProj").value||"").trim();
      if(!name) return;
      
      const k = normMasterName(name);
      const exists = state.masters.projects.some(x=> normMasterName((x?.name||"")) === k);
      if(exists){ alert("이미 등록된 프로젝트입니다: " + name); return; }
findOrCreate(state.masters.projects, name);
      $("mProj").value="";
      save("프로젝트 추가");
    }
    if(kind==="item"){
      const name = ($("mItem").value||"").trim();
      if(!name) return;
      
      const k = normMasterName(name);
      const exists = state.masters.items.some(x=> normMasterName((x?.name||"")) === k);
      if(exists){ alert("이미 등록된 품목입니다: " + name); return; }
findOrCreate(state.masters.items, name);
      $("mItem").value="";
      save("품목 추가");
    }
    hydrateSelects();
    renderMasters();
    renderDashboard();
  }

  // ===== Navigation =====
  
  function ledMonthDefault(){
    const r = monthStartEnd(thisMonth());
    if($("ledFrom") && !$("ledFrom").value) $("ledFrom").value = r.from;
    if($("ledTo") && !$("ledTo").value) $("ledTo").value = r.to;
  }

  function autoSettleForParty(partyId, mode, rule="FIFO"){
    // mode: "AR" or "AP"
    const key = (x)=> x.date + x.id;
    let sources=[], targets=[];
    if(mode==="AR"){
      sources = state.tx.filter(t=>t.partyId===partyId && t.type==="RECEIPT" && toNum(t.total)>0)
        .filter(s=> sourceRemaining(s,"AR").rem > 0);
      targets = state.tx.filter(t=>t.partyId===partyId && t.type==="SALE" && toNum(t.total)>0)
        .filter(t=> invoiceSettled(t).open > 0);
    }else{
      sources = state.tx.filter(t=>t.partyId===partyId && t.type==="PAYMENT" && toNum(t.total)>0)
        .filter(s=> sourceRemaining(s,"AP").rem > 0);
      targets = state.tx.filter(t=>t.partyId===partyId && (t.type==="PURCHASE"||t.type==="EXPENSE") && toNum(t.total)>0)
        .filter(t=> invoiceSettled(t).open > 0);
    }
    sources.sort((a,b)=> rule==="FIFO" ? key(a).localeCompare(key(b)) : key(b).localeCompare(key(a)));
    targets.sort((a,b)=> rule==="FIFO" ? key(a).localeCompare(key(b)) : key(b).localeCompare(key(a)));

    let count = 0;
    for(const s of sources){
      let rem = sourceRemaining(s, mode==="AR"?"AR":"AP").rem;
      if(rem<=0) continue;
      for(const t of targets){
        const open = invoiceSettled(t).open;
        if(open<=0) continue;
        const use = Math.min(rem, open);
        if(use<=0) continue;
        addAllocation(s.id, t.id, use, mode==="AR"?"AR":"AP", "원장출력 자동정산");
        count++;
        rem -= use;
        if(rem<=0) break;
      }
    }
    return count;
  }

  let __ledRows = [];
  
  function ensureLedPartyOptions(){
    try{
      const sel = $("ledParty");
      if(!sel) return;
      // If only placeholder or empty, rebuild options
      if(!sel.options || sel.options.length<=1){
        fillSelect(sel, state.masters.parties, "거래처(전체)");
      }
      // If still empty, warn
      if(sel.options && sel.options.length<=1){
        // No parties loaded
        // Keep placeholder, but notify once
        if(!window.__mf_warn_no_parties){
          window.__mf_warn_no_parties = true;
          try{ toast("거래처 목록이 비어있습니다. JSON 불러오기/마스터를 확인하세요."); }catch(e){}
        }
      }
    }catch(e){}
  }


  // ===== Ledger month helpers =====
  function setLedgerMonth(ymStr){
    try{
      const ymv = (ymStr || thisMonth());
      if($("ledMonth")) $("ledMonth").value = ymv;
      const r = monthStartEnd(ymv);
      if($("ledFrom")) $("ledFrom").value = r.from;
      if($("ledTo")) $("ledTo").value = r.to;
    }catch(e){}
  }
  function getLedgerMonth(){
    const v = $("ledMonth")?.value;
    return v || thisMonth();
  }
  function renderLedgerYear(){
    try{
      const partyId = $("ledParty")?.value || "";
      const year = Number($("ledYear")?.value || new Date().getFullYear());
      const pad = (n)=>String(n).padStart(2,"0");
      let ySales=0, yCost=0, yProfit=0;
      const tb = $("ledYearBody");
      if(!tb) return;
      tb.innerHTML = "";
      for(let m=1; m<=12; m++){
        const ymv = `${year}-${pad(m)}`;
        const r = monthStartEnd(ymv);
        const rows = state.tx.filter(t=> (!partyId || t.partyId===partyId) && inRange(t.date, r.from, r.to));
        const sales = rows.filter(t=>t.type==="SALE").reduce((a,t)=>a+toNum(t.total),0);
        const cost = rows.filter(t=>(t.type==="PURCHASE"||t.type==="EXPENSE")).reduce((a,t)=>a+toNum(t.total),0);
        const recv = rows.filter(t=>t.type==="RECEIPT").reduce((a,t)=>a+toNum(t.total),0);
        const pay  = rows.filter(t=>t.type==="PAYMENT").reduce((a,t)=>a+toNum(t.total),0);
        const profit = sales - cost;
        const netCash = recv - pay;
        ySales += sales; yCost += cost; yProfit += profit;

        const tr = document.createElement("tr");
        tr.style.cursor = "pointer";
        tr.innerHTML = `
          <td>${ymv}</td>
          <td class="right mono">${fmt(sales)}</td>
          <td class="right mono">${fmt(cost)}</td>
          <td class="right mono"><b>${fmt(profit)}</b></td>
          <td class="right mono">${fmt(recv)}</td>
          <td class="right mono">${fmt(pay)}</td>
          <td class="right mono"><b>${fmt(netCash)}</b></td>
        `;
        tr.addEventListener("click", ()=>{
          setLedgerMonth(ymv);
          setView("ledger");
          renderLedger();
        });
        tb.appendChild(tr);
      }
      if($("ledYearSales")) $("ledYearSales").textContent = fmt(ySales);
      if($("ledYearCost")) $("ledYearCost").textContent = fmt(yCost);
      if($("ledYearProfit")) $("ledYearProfit").textContent = fmt(yProfit);
    }catch(e){}
  }


  function ageDays(dateStr){
    try{
      const d = new Date((dateStr||"").slice(0,10));
      if(String(d)==="Invalid Date") return 0;
      const now = new Date();
      return Math.floor((now - d) / (1000*60*60*24));
    }catch(e){ return 0; }
  }

function renderLedger(){
    ensureLedPartyOptions();
    setLedgerMonth(getLedgerMonth());
    const partyId = $("ledParty")?.value || "";
    const from = $("ledFrom")?.value || "";
    const to = $("ledTo")?.value || "";
    const mode = $("ledMode")?.value || "SALES";
    const q = ($("ledQ")?.value || "").trim().toLowerCase();

    const want = (t)=>{
      if(mode==="SALES") return (t.type==="SALE" || t.type==="RECEIPT");
      if(mode==="PURCHASE") return (t.type==="PURCHASE" || t.type==="EXPENSE" || t.type==="PAYMENT");
      return true;
    };

    const rows = state.tx
      .filter(t=> !partyId ? true : t.partyId===partyId)
      .filter(t=> inRange(t.date, from, to))
      .filter(t=> want(t))
      .filter(t=>{
        if(!q) return true;
        const party = getName(state.masters.parties, t.partyId);
      const proj = getName(state.masters.projects, t.projectId);
        const item = getName(state.masters.items, t.itemId);
      const qtyVal = isInvoice(t) ? toNum(t.qty) : 0;
      const totalAmt = toNum(t.total);
      const sv = isInvoice(t) ? splitVatFromTotal(totalAmt, (t.vatMode||"INCLUDED")) : {supply:0, vat:0, total: totalAmt};
      const unitVal = (isInvoice(t) && qtyVal>0) ? Math.round(totalAmt/qtyVal) : 0;

        const blob = `${proj} ${item} ${(t.invoiceNo||"")} ${(t.memo||"")}`.toLowerCase();
        return blob.includes(q);
      })
      .filter(t=>{
        const onlyUninv = $("ledOnlyUninvoiced")?.classList.contains("ok");
        const onlyOpen = $("ledOnlyOpen")?.classList.contains("ok");
        const aged = toNum($("ledAged")?.value||0);
        if(onlyUninv && isInvoice(t) && t.invoiceIssued) return false;
        if(onlyOpen && isInvoice(t) && invoiceSettled(t).open<=0) return false;
        if(aged && isInvoice(t) && ageDays(t.date) < aged) return false;
        if(aged && !isInvoice(t)) return false;
        return true;
      })
      .sort((a,b)=> (a.date+a.id).localeCompare(b.date+b.id));

    __ledRows = rows;

    const sales = rows.filter(t=>t.type==="SALE").reduce((a,t)=>a+toNum(t.total),0);
    const recv = rows.filter(t=>t.type==="RECEIPT").reduce((a,t)=>a+toNum(t.total),0);
    const cost = rows.filter(t=>(t.type==="PURCHASE"||t.type==="EXPENSE")).reduce((a,t)=>a+toNum(t.total),0);
    const pay = rows.filter(t=>t.type==="PAYMENT").reduce((a,t)=>a+toNum(t.total),0);

    $("ledSales").textContent = fmt(sales);
    $("ledRecv").textContent = fmt(recv);
    $("ledARFlow").textContent = fmt(Math.max(0, sales - recv));

    $("ledCost").textContent = fmt(cost);
    $("ledPay").textContent = fmt(pay);
    $("ledAPFlow").textContent = fmt(Math.max(0, cost - pay));

    const tb = $("ledBody");
    tb.innerHTML = "";
    if(!rows.length){
      tb.innerHTML = `<tr><td colspan="13" class="muted">결과가 없습니다.</td></tr>`;
      return;
    }

    rows.forEach(t=>{
      const qtyVal = (isInvoice(t) && t.qty!==undefined) ? toNum(t.qty) : 0;
      const totalAmt = toNum(t.total);
      const sv = isInvoice(t) ? splitVatFromTotal(totalAmt, (t.vatMode||"INCLUDED")) : {supply:0, vat:0, total: totalAmt};
      const unitVal = (isInvoice(t) && qtyVal>0) ? Math.round(totalAmt/qtyVal) : 0;

      const party = getName(state.masters.parties, t.partyId);
      const proj = getName(state.masters.projects, t.projectId);
      const item = getName(state.masters.items, t.itemId);
      const inv = isInvoice(t) ? invoiceSettled(t) : {settled:"", open:""};
      const last = isInvoice(t) ? lastSettleDateByInvoice(t) : "";
      const status = isInvoice(t) ? payBadge(t) : "-";
      const issued = isInvoice(t) ? (t.invoiceIssued?`<span class="badge b-ok">발행</span>`:`<span class="badge b-danger">미발행</span>`) : "-";
      const settledCell = (isInvoice(t) && inv.settled>0) ? `<span class="linklike" data-act="openAllocDetail" data-id="${t.id}">${fmt(inv.settled)}</span>` : (isInvoice(t)?fmt(inv.settled):"-");
      const tr = document.createElement("tr");
      try{ tr.setAttribute("data-id", t.id); }catch(e){}
      tr.innerHTML = `
        <td class="mono nowrap">${esc(t.date||"")}</td>
        <td>${badgeType(t.type)}</td>
        <td><b>${esc(party)}</b></td>
        <td class="muted">${esc(proj)}</td>
        <td>${esc(item)}</td>
        <td class="right mono">${isInvoice(t)&&qtyVal?fmt(qtyVal):""}</td>
        <td class="right mono">${isInvoice(t)&&qtyVal?fmt(unitVal):""}</td>
        <td class="right mono">${isInvoice(t)?fmt(sv.supply):""}</td>
        <td class="right mono">${isInvoice(t)?fmt(sv.vat):""}</td>
        <td class="right mono"><b>${fmt(totalAmt)}</b></td>
        <td class="right mono">${settledCell}</td>
        <td class="right mono">${isInvoice(t)? `<b>${fmt(inv.open)}</b>`:"-"}</td>
        <td>${status}${(isInvoice(t) && invoiceSettled(t).open>0 && ageDays(t.date)>=30)?(` <span class="badge b-warn">`+ageDays(t.date)+`d+</span>`):""}</td>
        <td class="muted">${last?esc(last):"-"}</td>
        <td>${issued}</td>
        <td class="mono">${esc(t.invoiceNo||"")}</td>
        <td class="muted">${esc(t.memo||"")}</td>
      `;
      tb.appendChild(tr);
    });
  }

function setView(v){
    document.querySelectorAll("section.panel").forEach(s=>s.style.display="none");
    const target = $("view-"+v);
    if(target) target.style.display="";
    document.querySelectorAll(".navbtn").forEach(b=> b.classList.toggle("active", b.getAttribute("data-view")===v));

    if(v==="dash") renderDashboard();
    if(v==="month") renderMonthLedger();
    if(v==="excel"){ renderExcelGrid(); try{ if(typeof renderAutoCompleteLists==="function") renderAutoCompleteLists(); }catch(e){} }
    if(v==="search"){
      // 기본: 이번달(비어있을 때만)
      try{
        const qf = $("qFrom"), qt = $("qTo");
        if(qf && qt && !(qf.value||"").trim() && !(qt.value||"").trim()){
          const m = thisMonth();
          qf.value = `${m}-01`;
          qt.value = `${m}-31`;
        }
      }catch(e){}
      renderSearch();
    }
    if(v==="settle") renderSettle();
    if(v==="arap") renderARAP();
    if(v==="proj") { runProjectMonth(); runProjectYear(); }
    if(v==="base") renderBase();
    if(v==="master") renderMasters();
    if(v==="ledger"){ hydrateSelects(); renderLedger(); }
    // UI fix: always jump to top when switching views
    const goTop = ()=>{
      try{ document.documentElement.scrollTop = 0; }catch(e){}
      try{ document.body.scrollTop = 0; }catch(e){}
      try{ window.scrollTo(0,0); }catch(e){}
    };
    try{ requestAnimationFrame(goTop); }catch(e){ goTop(); }
    try{ setTimeout(goTop, 0); }catch(e){}
  }

  function renderAll(){
    renderDashboard();
    renderSearch();
    renderARAP();
    runProjectMonth();
    runProjectYear();
    renderBase();
    renderMasters();
  }

  // ===== Quick filters =====
  function quickSetTypes(only){
    document.querySelectorAll(".qType").forEach(ch=>{
      ch.checked = only.includes(ch.value);
    });
  }

  // ===== Demo data =====
  function seedDemo(){
    const p1 = findOrCreate(state.masters.parties, "주연테크");
    const p2 = findOrCreate(state.masters.parties, "잘만테크");
    const pr = findOrCreate(state.masters.projects, thisMonth()+" 주연 납품");
    const it = findOrCreate(state.masters.items, "파워");

    // clear
    state.tx = [];
    state.allocations = [];

    // SALE
    state.tx.push({id:uid(), date:thisMonth()+"-05", type:"SALE", partyId:p1, projectId:pr, itemId:it, qty:10, amount:1100000, vatMode:"INCLUDED", vat:0, total:1100000, invoiceIssued:false, invoiceNo:"", memo:"12월 납품", accountId:""});
    // PURCHASE
    const {total:pt} = calcVat(900000,"EXCLUDED");
    state.tx.push({id:uid(), date:thisMonth()+"-03", type:"PURCHASE", partyId:p2, projectId:pr, itemId:it, qty:10, amount:900000, vatMode:"EXCLUDED", vat:0, total:pt, invoiceIssued:false, invoiceNo:"", memo:"매입", accountId:""});
    // RECEIPT
    state.tx.push({id:uid(), date:thisMonth()+"-20", type:"RECEIPT", partyId:p1, projectId:"", itemId:"", qty:0, amount:700000, vatMode:"INCLUDED", vat:0, total:700000, invoiceIssued:false, invoiceNo:"", memo:"부분 수금", accountId:""});
    // PAYMENT
    state.tx.push({id:uid(), date:thisMonth()+"-18", type:"PAYMENT", partyId:p2, projectId:"", itemId:"", qty:0, amount:500000, vatMode:"INCLUDED", vat:0, total:500000, invoiceIssued:false, invoiceNo:"", memo:"부분 지급", accountId:""});

    sortTx();
    hydrateSelects();
    renderAll();
    save("데모데이터 생성 완료");
  }

  // ===== Events =====
  
  // ===== Compact UI =====
  function setCompactUI(){
    const on = !!(state?.meta?.compactTables);
    document.body.classList.toggle("compactTables", on);
    const pill = $("compactPill");
    const btn = $("btnCompactToggle");
    if(pill) pill.textContent = "표: " + (on ? "줄임" : "원본");
    if(btn) btn.textContent = "표: " + (on ? "줄임" : "원본");
  }

  // ===== Payment status helpers =====
  function lastSettleDateByInvoice(t){
    try{
      const role = invoiceRole(t);
      if(!role) return "";
      const allocs = state.allocations.filter(a=>a.targetId===t.id && a.role===role);
      if(!allocs.length) return "";
      let last = "";
      allocs.forEach(a=>{
        const s = state.tx.find(x=>x.id===a.sourceId);
        const d = (s && s.date) ? String(s.date).slice(0,10) : String(a.createdAt||"").slice(0,10);
        if(d && d > last) last = d;
      });
      return last;
    }catch(e){ return ""; }
  }
  function payStatusByInvoice(t){
    if(!isInvoice(t)) return {label:"-", cls:""};
    const inv = invoiceSettled(t);
    if(inv.open<=0 && inv.settled>0) return {label:"결제완료", cls:"b-ok"};
    if(inv.settled>0 && inv.open>0) return {label:"부분결제", cls:"b-warn"};
    return {label:"미정산", cls:"b-danger"};
  }
  function payBadge(t){
    const st = payStatusByInvoice(t);
    if(st.label==="-") return "-";
    return `<span class="badge ${st.cls}">${st.label}</span>`;
  }

  // ===== Allocation modal =====
  function openAllocModal(targetId){
    const t = state.tx.find(x=>x.id===targetId);
    if(!t || !isInvoice(t)) return;
    const role = invoiceRole(t);
    const inv = invoiceSettled(t);
    const party = getName(state.masters.parties, t.partyId);
    const invNo = (t.invoiceNo||"").trim();
    $("allocModalTitle").textContent = "정산내역: " + (party||"");
    $("allocModalSummary").innerHTML =
      `대상 ${esc(t.date||"")} / ${esc(party||"")} ${invNo?`/ 번호 <b>${esc(invNo)}</b>`:""} · 총액 <b>${fmt(t.total)}</b> · 정산 <b>${fmt(inv.settled)}</b> · 잔액 <b>${fmt(inv.open)}</b>`;
    const allocs = state.allocations.filter(a=>a.targetId===t.id && a.role===role).slice().sort((a,b)=> (a.createdAt||"").localeCompare(b.createdAt||""));
    const tb = $("allocModalBody");
    tb.innerHTML = "";
    if(!allocs.length){
      tb.innerHTML = `<tr><td colspan="4" class="muted">정산 내역이 없습니다.</td></tr>`;
    }else{
      allocs.forEach(a=>{
        const s = state.tx.find(x=>x.id===a.sourceId);
        const d = s?.date || (a.createdAt||"").slice(0,10);
        const typ = s ? typeLabel(s.type) : "?";
        const memo = s?.memo || "";
        const tr=document.createElement("tr");
        tr.innerHTML = `<td>${esc(d||"")}</td><td>${esc(typ)}</td><td class="muted">${esc(memo)}</td><td class="right mono"><b>${fmt(a.amount)}</b></td>`;
        tb.appendChild(tr);
      });
    }
    $("btnAllocGoSettle").onclick = ()=>{
      $("sParty").value = t.partyId || "";
      $("sMode").value = (role==="AR") ? "AR" : "AP";
      $("allocModal").classList.add("hidden");
      setView("settle");
    };
    $("allocModal").classList.remove("hidden");
  }
  function closeAllocModal(){ $("allocModal").classList.add("hidden"); }

  // ===== AR/AP period + detail modal =====
  function ymd(d){ return (d||"").toString().slice(0,10); }
  function monthStartEnd(ym){
    const [y,m] = (ym||thisMonth()).split("-").map(Number);
    const d1 = new Date(y, m-1, 1);
    const d2 = new Date(y, m, 0);
    const pad=(n)=>String(n).padStart(2,"0");
    return {from:`${d1.getFullYear()}-${pad(d1.getMonth()+1)}-01`, to:`${d2.getFullYear()}-${pad(d2.getMonth()+1)}-${pad(d2.getDate())}`};
  }
  function shiftMonth(ym, delta){
    const [y,m] = (ym||thisMonth()).split("-").map(Number);
    const d = new Date(y, (m-1)+delta, 1);
    const yy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    return `${yy}-${mm}`;
  }
  function inRange(date, from, to){
    const x = ymd(date);
    if(from && x < from) return false;
    if(to && x > to) return false;
    return true;
  }
  function ensureArapDates(){
    if(!$("arapFrom") || !$("arapTo")) return;
    if(!$("arapFrom").value || !$("arapTo").value){
      const r = monthStartEnd(thisMonth());
      $("arapFrom").value = r.from;
      $("arapTo").value = r.to;
    }
  }
  function calcPeriodARAP(from, to, basis){
    const parties = state.masters.parties || [];
    const map = new Map();
    parties.forEach(p=> map.set(p.id, {ar:0, ap:0}));
    if(basis==="FLOW"){
      parties.forEach(p=>{
        const sales = state.tx.filter(t=>t.partyId===p.id && t.type==="SALE" && inRange(t.date, from, to)).reduce((a,t)=>a+toNum(t.total),0);
        const rec = state.tx.filter(t=>t.partyId===p.id && t.type==="RECEIPT" && inRange(t.date, from, to)).reduce((a,t)=>a+toNum(t.total),0);
        const pur = state.tx.filter(t=>t.partyId===p.id && (t.type==="PURCHASE"||t.type==="EXPENSE") && inRange(t.date, from, to)).reduce((a,t)=>a+toNum(t.total),0);
        const pay = state.tx.filter(t=>t.partyId===p.id && t.type==="PAYMENT" && inRange(t.date, from, to)).reduce((a,t)=>a+toNum(t.total),0);
        map.get(p.id).ar = Math.max(0, sales - rec);
        map.get(p.id).ap = Math.max(0, pur - pay);
      });
    }else{
      parties.forEach(p=>{
        const ar = state.tx.filter(t=>t.partyId===p.id && t.type==="SALE" && inRange(t.date, from, to) && toNum(t.total)>0).reduce((a,t)=>a+invoiceSettled(t).open,0);
        const ap = state.tx.filter(t=>t.partyId===p.id && (t.type==="PURCHASE"||t.type==="EXPENSE") && inRange(t.date, from, to) && toNum(t.total)>0).reduce((a,t)=>a+invoiceSettled(t).open,0);
        map.get(p.id).ar = ar;
        map.get(p.id).ap = ap;
      });
    }
    const arSum = Array.from(map.values()).reduce((a,x)=>a+toNum(x.ar),0);
    const apSum = Array.from(map.values()).reduce((a,x)=>a+toNum(x.ap),0);
    return {ar:arSum, ap:apSum, map};
  }
  function renderArapPeriod(){
    ensureArapDates();
    const from = $("arapFrom").value || "";
    const to = $("arapTo").value || "";
    const basis = ($("arapBasis")?.value) || "ASOF";
    const res = calcPeriodARAP(from, to, basis);
    if($("arapPeriodAR")) $("arapPeriodAR").textContent = fmt(res.ar);
    if($("arapPeriodAP")) $("arapPeriodAP").textContent = fmt(res.ap);
    return res;
  }
  function openArapDetail(partyId, role){
    ensureArapDates();
    const from = $("arapFrom").value || "";
    const to = $("arapTo").value || "";
    const party = getName(state.masters.parties, partyId);
    $("arapDetailTitle").textContent = `상세: ${party} · ${role==="AR"?"미수":"미지급"}`;
    let invRows = [];
    // 상세는 "잔액>0" 전체기간 기준으로 보여줌 (기간 필터로 비어보이는 문제 방지)
    if(role==="AR"){
      invRows = state.tx
        .filter(t=>t.partyId===partyId && t.type==="SALE" && toNum(t.total)>0)
        .filter(t=> invoiceSettled(t).open>0);
    }else{
      invRows = state.tx
        .filter(t=>t.partyId===partyId && (t.type==="PURCHASE"||t.type==="EXPENSE") && toNum(t.total)>0)
        .filter(t=> invoiceSettled(t).open>0);
    }
    invRows.sort((a,b)=>(a.date+a.id).localeCompare(b.date+b.id));
    const body = $("arapDetailBody");
    body.innerHTML = "";
    if(!invRows.length){
      body.innerHTML = `<tr><td colspan="12" class="muted">해당 기간 내 계산서 내역이 없습니다.</td></tr>`;
    }else{
      invRows.forEach(t=>{
        const proj = getName(state.masters.projects, t.projectId);
        const item = getName(state.masters.items, t.itemId);
        const inv = invoiceSettled(t);
        const last = lastSettleDateByInvoice(t);
        const issued = t.invoiceIssued ? `<span class="badge b-ok">발행</span>` : `<span class="badge b-danger">미발행</span>`;
        const settledCell = inv.settled>0 ? `<span class="linklike" data-act="openAllocDetail" data-id="${t.id}">${fmt(inv.settled)}</span>` : fmt(inv.settled);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(t.date||"")}</td><td>${badgeType(t.type)}</td>
          <td class="muted">${esc(proj)}</td><td>${esc(item)}</td>
          <td class="right mono"><b>${fmt(t.total)}</b></td>
          <td class="right mono">${settledCell}</td>
          <td class="right mono"><b>${fmt(inv.open)}</b></td>
          <td>${payBadge(t)}</td>
          <td class="muted">${last?esc(last):"-"}</td>
          <td>${issued}</td>
          <td class="mono">${esc(t.invoiceNo||"")}</td>
          <td class="muted">${esc(t.memo||"")}</td>
        `;
        body.appendChild(tr);
      });
    }
    const sumTotal = invRows.reduce((a,t)=>a+toNum(t.total),0);
    const sumSettled = invRows.reduce((a,t)=>a+invoiceSettled(t).settled,0);
    const sumOpen = invRows.reduce((a,t)=>a+invoiceSettled(t).open,0);
    $("arapDetailSummary").textContent = `잔액>0 전체기간 표시 (상단기간: ${from} ~ ${to}) · 총액 ${fmt(sumTotal)} · 정산 ${fmt(sumSettled)} · 잔액 ${fmt(sumOpen)}`;
    // 상세에서 바로 이동/작업
    try{
      const goSearchBtn = $("btnArapDetailGoSearch");
      if(goSearchBtn){
        goSearchBtn.onclick = ()=>{
          setView("search");
          $("qParty").value = partyId;
          if(role==="AR") quickSetTypes(["SALE"]); else quickSetTypes(["PURCHASE","EXPENSE"]);
          $("qSettle").value = "OPEN";
          $("qInvoice").value = "";
          // 잔액은 오래된 것도 많아서, 넓게 잡아줌(사용자가 다시 조정 가능)
          if($("qFrom")) $("qFrom").value = "2000-01-01";
          if($("qTo")) $("qTo").value = "2099-12-31";
          renderSearch();
          try{ closeModal("arapDetailModal"); }catch(e){ $("arapDetailModal").classList.add("hidden"); }
        };
      }
      const toExcelBtn = $("btnArapDetailToExcel");
      if(toExcelBtn){
        toExcelBtn.onclick = ()=>{
          const amt = Math.round(sumOpen||0);
          if(!(amt>0)){ alert("잔액이 0입니다."); return; }
          setView("excel");
          try{ ensureExcelRows(20); }catch(e){}
          const today = new Date().toISOString().slice(0,10);
          let idx = -1;
          try{
            idx = (window.excelRows||[]).findIndex(r=>{
              const hasAny = (r.partyName||"").trim() || (r.itemName||"").trim() || (r.projectName||"").trim() ||
                (r.qty||"").toString().trim() || (r.unitPrice||"").toString().trim() || (r.amount||"").toString().trim() || (r.memo||"").trim();
              return !hasAny;
            });
          }catch(e){}
          const i = (idx>=0) ? idx : 0;
          if(!window.excelRows) window.excelRows = [];
          if(!window.excelRows[i]) window.excelRows[i] = (typeof newEmptyRow==="function") ? newEmptyRow() : {};
          const r = window.excelRows[i];
          r.date = today;
          r.type = (role==="AR") ? "RECEIPT" : "PAYMENT";
          r.partyName = party;
          r.projectName = "";
          r.itemName = "";
          r.qty = "";
          r.unitPrice = "";
          r.amount = String(amt);
          r.vatMode = "ZERO";
          r.invoiceIssued = false;
          r.invoiceNo = "";
          r.memo = (role==="AR" ? "수금" : "지급") + "(미수/미지급 정산)";
          try{ renderExcelGrid(); }catch(e){}
          try{ toast("엑셀입력에 자동 채움 완료(저장은 직접)."); }catch(e){}
          try{ closeModal("arapDetailModal"); }catch(e){ $("arapDetailModal").classList.add("hidden"); }
        };
      }
    }catch(e){}
    $("btnArapDetailGoSettle").onclick = ()=>{
      $("sParty").value = partyId;
      $("sMode").value = (role==="AR") ? "AR" : "AP";
      $("arapDetailModal").classList.add("hidden");
      setView("settle");
    };
    $("arapDetailModal").classList.remove("hidden");
  }
  function closeArapDetail(){ $("arapDetailModal").classList.add("hidden"); }

  // Aged modal
  function openAgedModal(){
    try{ renderAgedList(); }catch(e){}
    const m = $("agedModal");
    if(m) m.classList.remove("hidden");
  }
  function closeAgedModal(){
    const m = $("agedModal");
    if(m) m.classList.add("hidden");
  }


    function listDupes(arr){
    const map=new Map();
    (arr||[]).forEach(x=>{ const name=(x?.name||"").toString().trim(); if(!name) return; const k=normMasterName(name); const cur=map.get(k)||[]; cur.push(name); map.set(k,cur); });
    const out=[]; map.forEach((names,k)=>{ const uniq=Array.from(new Set(names)); if(uniq.length>1) out.push({k,names:uniq}); });
    return out;
  }

function bind(){
    document.querySelectorAll(".navbtn").forEach(b=>{
      b.addEventListener("click", ()=> setView(b.getAttribute("data-view")));
    
    if($("btnClearDraft")) $("btnClearDraft").addEventListener("click", clearExcelDraft);
  
    // Dashboard quick buttons (search)
    function dashSetMonthRange(){
      const m = thisMonth();
      $("qFrom").value = m + "-01";
      $("qTo").value = m + "-31";
        if($("btnExportSelCsv")) $("btnExportSelCsv").addEventListener("click", exportSelectedCsv);
  }
    if($("btnDashUninvSales")) $("btnDashUninvSales").addEventListener("click", ()=>{
      dashSetMonthRange(); setView("search"); quickSetTypes(["SALE"]);
      $("qInvoice").value = "N"; $("qSettle").value = ""; renderSearch();
    });
    if($("btnDashUninvCost")) $("btnDashUninvCost").addEventListener("click", ()=>{
      dashSetMonthRange(); setView("search"); quickSetTypes(["PURCHASE","EXPENSE"]);
      $("qInvoice").value = "N"; $("qSettle").value = ""; renderSearch();
    });
    if($("btnDashOpenAR")) $("btnDashOpenAR").addEventListener("click", ()=>{
      dashSetMonthRange(); setView("search"); quickSetTypes(["SALE"]);
      $("qInvoice").value = ""; $("qSettle").value = "OPEN"; renderSearch();
    });
    if($("btnDashOpenAP")) $("btnDashOpenAP").addEventListener("click", ()=>{
      dashSetMonthRange(); setView("search"); quickSetTypes(["PURCHASE","EXPENSE"]);
      $("qInvoice").value = ""; $("qSettle").value = "OPEN"; renderSearch();
    });
    if($("btnDashUnallocRecv")) $("btnDashUnallocRecv").addEventListener("click", ()=>{
      dashSetMonthRange(); setView("search"); quickSetTypes(["RECEIPT"]);
      renderSearch();
    });
    if($("btnDashUnallocPay")) $("btnDashUnallocPay").addEventListener("click", ()=>{
      dashSetMonthRange(); setView("search"); quickSetTypes(["PAYMENT"]);
      renderSearch();
    });
    if($("btnDashAgedMore")) $("btnDashAgedMore").addEventListener("click", openAgedModal);
    if($("btnGoProj2")) $("btnGoProj2").addEventListener("click", ()=> setView("proj"));

  });

    if($("btnGoExcel")) $("btnGoExcel").addEventListener("click", ()=> setView("excel"));
    
    if($("btnAutoMatchToggle")) $("btnAutoMatchToggle").addEventListener("click", ()=>{
      state.meta.autoMatchOnSave = !state.meta.autoMatchOnSave;
      save("자동정산 설정 변경");
      setAutoMatchUI();
    });

    if($("btnCompactToggle")) $("btnCompactToggle").addEventListener("click", ()=>{
      state.meta.compactTables = !state.meta.compactTables;
      save("표 표시 설정 변경");
      setCompactUI();
    });
if($("btnGoSettle")) $("btnGoSettle").addEventListener("click", ()=> setView("settle"));
    if($("btnGoProj")) $("btnGoProj").addEventListener("click", ()=> setView("proj"));

    if($("btnGoMonth")) $("btnGoMonth").addEventListener("click", ()=> setView("month"));

    if($("dashOnlyUninv")) $("dashOnlyUninv").addEventListener("click", ()=>{ dashFilter="UNINV"; renderDashboard(); });
    if($("dashResetFilter")) $("dashResetFilter").addEventListener("click", ()=>{ dashFilter="ALL"; renderDashboard(); });

    $("btnAddRows").addEventListener("click", ()=>{
      for(let i=0;i<10;i++) excelRows.push(newEmptyRow());
      renderExcelGrid();
    });

    if($("btnFillDown")) $("btnFillDown").addEventListener("click", smartFillDown);
    if($("btnSaveRows")) $("btnSaveRows").addEventListener("click", saveExcelRows);

    // Excel extras toggle
    if($("btnExcelExtrasToggle")) $("btnExcelExtrasToggle").addEventListener("click", ()=>{
      const box = $("excelExtras");
      if(!box) return;
      const on = box.style.display !== "none";
      box.style.display = on ? "none" : "";
      $("btnExcelExtrasToggle").textContent = on ? "하단 패널 펼치기" : "하단 패널 접기";
    });

    // search filters
    ["qFrom","qTo","qParty","qProject","qItem","qInvoice","qSettle","qText","qMin","qMax","qSort"].forEach(id=>{
      $(id).addEventListener("input", renderSearch);
      $(id).addEventListener("change", renderSearch);
    });
    document.querySelectorAll(".qType").forEach(ch=> ch.addEventListener("change", renderSearch));

    $("quickUninvoicedSales").addEventListener("click", ()=>{
      quickSetTypes(["SALE","PURCHASE","EXPENSE"]);
      $("qInvoice").value = "N";
      $("qSettle").value = "";
      renderSearch();
    });
    $("quickOpenSales").addEventListener("click", ()=>{
      quickSetTypes(["SALE"]);
      $("qInvoice").value = "";
      $("qSettle").value = "OPEN";
      renderSearch();
    });
    $("quickOpenPurch").addEventListener("click", ()=>{
      quickSetTypes(["PURCHASE","EXPENSE"]);
      $("qInvoice").value = "";
      $("qSettle").value = "OPEN";
      renderSearch();
    });
    if($("quickSalesOnly")) $("quickSalesOnly").addEventListener("click", ()=>{ quickSetTypes(["SALE"]); $("qInvoice").value=""; $("qSettle").value=""; renderSearch(); });
    if($("quickPurchOnly")) $("quickPurchOnly").addEventListener("click", ()=>{ quickSetTypes(["PURCHASE"]); $("qInvoice").value=""; $("qSettle").value=""; renderSearch(); });
    if($("quickReceiptsOnly")) $("quickReceiptsOnly").addEventListener("click", ()=>{ quickSetTypes(["RECEIPT"]); $("qInvoice").value=""; $("qSettle").value=""; renderSearch(); });
    if($("quickPaymentsOnly")) $("quickPaymentsOnly").addEventListener("click", ()=>{ quickSetTypes(["PAYMENT"]); $("qInvoice").value=""; $("qSettle").value=""; renderSearch(); });

    if($("btnSaveEdit")) $("btnSaveEdit").addEventListener("click", saveEdit);


    // Edit form: auto-calc amount from qty*unit, and VAT quick convert (×1.1 / ÷1.1)
    if($("eAmount")) $("eAmount").addEventListener("input", ()=>{ __editAmountTouched = true; });
    if($("eUnit")) $("eUnit").addEventListener("input", ()=>{
      __editAmountTouched = false;
      const q = toNum($("eQty")?.value||0);
      const u = toNum($("eUnit")?.value||0);
      if(q>0 && u>0 && $("eAmount")) $("eAmount").value = Math.round(q*u);
    });
    if($("eQty")) $("eQty").addEventListener("input", ()=>{
      const q = toNum($("eQty")?.value||0);
      const u = toNum($("eUnit")?.value||0);
      if(q>0 && u>0 && !$("__dummy")){
        if(!$("eAmount")) return;
        if(!__editAmountTouched){
          $("eAmount").value = Math.round(q*u);
        }
      }
    });
    if($("btnEUnitMul")) $("btnEUnitMul").addEventListener("click", (ev)=>{
      ev.preventDefault();
      const u = toNum($("eUnit")?.value||0); if(!u) return;
      const u2 = Math.round(u*1.1);
      $("eUnit").value = u2;
      if($("eVat")) $("eVat").value = "INCLUDED";
      __editAmountTouched = false;
      const q = toNum($("eQty")?.value||0);
      if(q>0 && $("eAmount")) $("eAmount").value = Math.round(q*u2);
    });
    if($("btnEUnitDiv")) $("btnEUnitDiv").addEventListener("click", (ev)=>{
      ev.preventDefault();
      const u = toNum($("eUnit")?.value||0); if(!u) return;
      const u2 = Math.round(u/1.1);
      $("eUnit").value = u2;
      if($("eVat")) $("eVat").value = "EXCLUDED";
      __editAmountTouched = false;
      const q = toNum($("eQty")?.value||0);
      if(q>0 && $("eAmount")) $("eAmount").value = Math.round(q*u2);
    });

    if($("btnDeleteOne")) $("btnDeleteOne").addEventListener("click", deleteOne);
    if($("btnDeleteEdit")) $("btnDeleteEdit").addEventListener("click", deleteOne);
    if($("btnExportCsv")) $("btnExportCsv").addEventListener("click", exportSearchCsv);

    if($("btnRunPm")) $("btnRunPm").addEventListener("click", runProjectMonth);
    if($("pmMonth")) $("pmMonth").addEventListener("change", runProjectMonth);
    if($("pmProject")) $("pmProject").addEventListener("change", ()=>{ runProjectMonth(); runProjectYear(); renderDashboard(); });
    if($("btnRunPy")) $("btnRunPy").addEventListener("click", runProjectYear);
    if($("pyYear")) $("pyYear").addEventListener("change", runProjectYear);

    if($("arapText")) $("arapText").addEventListener("input", renderARAP);

    // Ledger bindings
    if($("ledThisMonth")) $("ledThisMonth").addEventListener("click", ()=>{ const r=monthStartEnd(thisMonth()); $("ledFrom").value=r.from; $("ledTo").value=r.to; renderLedger(); });
    if($("ledLastMonth")) $("ledLastMonth").addEventListener("click", ()=>{ const r=monthStartEnd(shiftMonth(thisMonth(),-1)); $("ledFrom").value=r.from; $("ledTo").value=r.to; renderLedger(); });

    ["ledParty","ledFrom","ledTo","ledMode","ledQ"].forEach(id=>{
      $(id)?.addEventListener("input", renderLedger);
      $(id)?.addEventListener("change", renderLedger);
    });

    if($("btnLedAutoSettle")) $("btnLedAutoSettle").addEventListener("click", ()=>{
      const partyId = $("ledParty").value || "";
      if(!partyId){ alert("거래처를 선택하세요."); return; }
      if(!confirm("이 거래처에 대해 자동정산을 실행한 뒤 출력할까요?\\n(AR/AP 잔액이 현실화됩니다)")) return;
      const c1 = autoSettleForParty(partyId, "AR", "FIFO");
      const c2 = autoSettleForParty(partyId, "AP", "FIFO");
      save(`원장출력 자동정산 완료(AR ${c1}건, AP ${c2}건)`);
      renderAll();
      renderLedger();
      toast("정산 후 출력 준비 완료");
    });

    if($("btnLedCsv")) $("btnLedCsv").addEventListener("click", ()=>{
      const partySel = getName(state.masters.parties, $("ledParty").value || "");
      const rows = (__ledRows||[]).map(t=>{
        const proj = getName(state.masters.projects, t.projectId);
        const item = getName(state.masters.items, t.itemId);
        const inv = isInvoice(t)? invoiceSettled(t) : {settled:"", open:""};
        const st = isInvoice(t)? payStatusByInvoice(t).label : "";
        const last = isInvoice(t)? (lastSettleDateByInvoice(t)||"") : "";
        const issued = isInvoice(t)? (t.invoiceIssued?"Y":"N") : "";
        const party = getName(state.masters.parties, t.partyId) || partySel;
        return [t.date, typeLabel(t.type), party, proj, item, t.total, (isInvoice(t)?inv.settled:""), (isInvoice(t)?inv.open:""), st, last, issued, (t.invoiceNo||""), (t.memo||"")];
      });
      downloadCsv(`MakeFreeERP_Ledger_${(party||"ALL")}_${getLedgerMonth()}_${($("ledMode")?.value||"")}.csv`, rows, ["일자","구분","거래처","프로젝트","품목","총액","정산누적","잔액","결제상태","최근결제일","발행(Y/N)","번호","메모"]);
    });

    if($("btnLedTsv")) $("btnLedTsv").addEventListener("click", ()=>{
      const partySel = getName(state.masters.parties, $("ledParty").value || "");
      const rows = (__ledRows||[]).map(t=>{
        const proj = getName(state.masters.projects, t.projectId);
        const item = getName(state.masters.items, t.itemId);
        const inv = isInvoice(t)? invoiceSettled(t) : {settled:"", open:""};
        const st = isInvoice(t)? payStatusByInvoice(t).label : "";
        const last = isInvoice(t)? (lastSettleDateByInvoice(t)||"") : "";
        const issued = isInvoice(t)? (t.invoiceIssued?"Y":"N") : "";
        return [t.date, typeLabel(t.type), party, proj, item, t.total, (isInvoice(t)?inv.settled:""), (isInvoice(t)?inv.open:""), st, last, issued, (t.invoiceNo||""), (t.memo||"")];
      });
      downloadTsv(`MakeFreeERP_Ledger_${(party||"ALL")}_${getLedgerMonth()}_${($("ledMode")?.value||"")}.tsv`, rows, ["일자","구분","거래처","프로젝트","품목","총액","정산누적","잔액","결제상태","최근결제일","발행(Y/N)","번호","메모"]);
    });


    // AR/AP period controls
    if($("arapThisMonth")) $("arapThisMonth").addEventListener("click", ()=>{ const r=monthStartEnd(thisMonth()); $("arapFrom").value=r.from; $("arapTo").value=r.to; renderARAP(); });
    if($("arapLastMonth")) $("arapLastMonth").addEventListener("click", ()=>{ const r=monthStartEnd(shiftMonth(thisMonth(),-1)); $("arapFrom").value=r.from; $("arapTo").value=r.to; renderARAP(); });
    if($("arapThisYear")) $("arapThisYear").addEventListener("click", ()=>{ const y=new Date().getFullYear(); $("arapFrom").value=`${y}-01-01`; $("arapTo").value=`${y}-12-31`; renderARAP(); });
    ["arapFrom","arapTo","arapBasis"].forEach(id=>{ $(id)?.addEventListener("change", renderARAP); $(id)?.addEventListener("input", renderARAP); });

    // Modal closes
    document.addEventListener("click",(e)=>{
      if(e.target.closest('[data-act="closeAllocModal"]')) closeAllocModal();
      if(e.target.closest('[data-act="closeArapDetail"]')) closeArapDetail();
      if(e.target.closest('[data-act="closeAgedModal"]')) closeAgedModal();
      const a = e.target.closest('[data-act="openAllocDetail"]');
      if(a){ const id=a.getAttribute("data-id"); if(id) openAllocModal(id); }
    });

    $("btnGoSettle2").addEventListener("click", ()=>{
      if(!arapSelectedPartyId){ alert("미수/미지급 표에서 거래처를 먼저 선택하세요."); return; }
      $("sParty").value = arapSelectedPartyId;
      $("sMode").value = "AR";
      setView("settle");
    });

    // settle
    if($("sParty")) $("sParty").addEventListener("change", renderSettle);
    if($("sMode")) $("sMode").addEventListener("change", renderSettle);
    if($("sAutoRule")) $("sAutoRule").addEventListener("change", renderSettle);
    if($("btnAutoSettle")) $("btnAutoSettle").addEventListener("click", autoSettle);
    if($("btnManualAllocate")) $("btnManualAllocate").addEventListener("click", manualAllocate);
    if($("btnUnallocateAll")) $("btnUnallocateAll").addEventListener("click", unallocateAllForParty);

    if($("btnAddAcc")) $("btnAddAcc").addEventListener("click", addAccount);
    if($("btnAddParty")) $("btnAddParty").addEventListener("click", ()=> addMaster("party"));
    if($("btnAddProj")) $("btnAddProj").addEventListener("click", ()=> addMaster("proj"));
    if($("btnAddItem")) $("btnAddItem").addEventListener("click", ()=> addMaster("item"));

    // Dedup bindings
    if($("btnDedupParties")) $("btnDedupParties").addEventListener("click", ()=>{
      const d=listDupes(state.masters.parties);
      $("dedupResult").value = d.length ? d.map(x=>`[${x.k}] => `+x.names.join(" | ")).join("\n") : "거래처 중복 없음";
    });
    if($("btnDedupProjects")) $("btnDedupProjects").addEventListener("click", ()=>{
      const d=listDupes(state.masters.projects);
      $("dedupResult").value = d.length ? d.map(x=>`[${x.k}] => `+x.names.join(" | ")).join("\n") : "프로젝트 중복 없음";
    });
    if($("btnDedupItems")) $("btnDedupItems").addEventListener("click", ()=>{
      const d=listDupes(state.masters.items);
      $("dedupResult").value = d.length ? d.map(x=>`[${x.k}] => `+x.names.join(" | ")).join("\n") : "품목 중복 없음";
    });

    
    if($("btnAutoBackupSetup")) $("btnAutoBackupSetup").addEventListener("click", setupAutoBackupFolder);
    if($("btnAutoBackupOff")) $("btnAutoBackupOff").addEventListener("click", disableAutoBackupFolder);


    if($("btnBackup")) $("btnBackup").addEventListener("click", exportBackup);
    $("importJson").addEventListener("change", (e)=>{
      const f = e.target.files && e.target.files[0];
      if(f) importBackup(f);
      e.target.value="";
    });

    $("btnResetDemo").addEventListener("click", ()=>{
      if(!confirm("현재 데이터가 데모데이터로 교체됩니다. 계속할까요?")) return;
      seedDemo();
    });

    $("btnClear").addEventListener("click", async ()=>{
      if(!confirm("정말 전체 초기화할까요?")) return;
      localStorage.removeItem(LS);
      try{ await idbDel("state"); }catch(e){}
      location.reload();
    });
    $("dashARAPText")?.addEventListener("input", renderDashARAP);

  

    // Month ledger controls
    if($("btnMonthGoExcel")) $("btnMonthGoExcel").addEventListener("click", ()=> setView("excel"));
    if($("btnMonthGoSearch")) $("btnMonthGoSearch").addEventListener("click", ()=> setView("search"));
    if($("btnMonthGoARAP")) $("btnMonthGoARAP").addEventListener("click", ()=> setView("arap"));

    if($("monthPick")){
      $("monthPick").value = $("monthPick").value || thisMonth();
      if($("monthPick")) $("monthPick").addEventListener("change", renderMonthLedger);
    }
    if($("btnMonthPrev")) $("btnMonthPrev").addEventListener("click", ()=>{ $("monthPick").value = monthAdd($("monthPick").value, -1); renderMonthLedger(); });
    if($("btnMonthNext")) $("btnMonthNext").addEventListener("click", ()=>{ $("monthPick").value = monthAdd($("monthPick").value, +1); renderMonthLedger(); });
    if($("btnMonthNow")) $("btnMonthNow").addEventListener("click", ()=>{ $("monthPick").value = thisMonth(); renderMonthLedger(); });
    if($("btnMonthRefresh")) $("btnMonthRefresh").addEventListener("click", renderMonthLedger);

    document.querySelectorAll(".mType").forEach(ch=> ch.addEventListener("change", renderMonthLedger));
    if($("mInvoiceFilter")) $("mInvoiceFilter").addEventListener("change", renderMonthLedger);
    if($("mOpenFilter")) $("mOpenFilter").addEventListener("change", renderMonthLedger);
    if($("mKeyword")) $("mKeyword").addEventListener("input", ()=>{ clearTimeout(window.__mkwT); window.__mkwT=setTimeout(renderMonthLedger, 250); });


    // Month sort mode (clarity)
    if($("mSort")){
      setMonthSortMode(getMonthSortMode());
      $("mSort").addEventListener("change", ()=>{
        setMonthSortMode($("mSort").value);
        renderMonthLedger();
      });
    }

    
    
    // Month quick cash toggle (default OFF)
    try{ setQuickCashOn(getQuickCashOn()); }catch(e){}
    if($("mQuickCash")){
      $("mQuickCash").addEventListener("change", ()=>{
        setQuickCashOn(!!$("mQuickCash").checked);
        renderMonthLedger();
      });
    }


    // Month quick edit (A: right slide panel)
    // bind quick edit ui
    if($("qeOverlay")) $("qeOverlay").addEventListener("click", qeClose);
    if($("qeClose")) $("qeClose").addEventListener("click", qeClose);
    if($("qeSave")) $("qeSave").addEventListener("click", qeSave);
    if($("qeGoSearch")) $("qeGoSearch").addEventListener("click", ()=>{
      const id = __qeId;
      const tx = state.tx.find(x=>x.id===id);
      qeClose();
      if(!tx) return;
      setView("search");
      $("qFrom").value = (tx.date||"").slice(0,7) + "-01";
      $("qTo").value = (tx.date||"").slice(0,7) + "-31";
      renderSearch();
      const party = getName(state.masters.parties, tx.partyId);
      $("qKeyword").value = party || "";
      renderSearch();
      try{
        const cb = document.querySelector('input.selTx[data-id="'+id+'"]');
        if(cb){ cb.checked=true; cb.dispatchEvent(new Event("change")); }
      }catch(_){}
    });
    ["qeDate","qeType","qeQty","qeUnitPrice","qeAmount","qeVatMode"].forEach(id=>{
      const el = $(id);
      if(el) el.addEventListener("input", qePreview);
      if(el) el.addEventListener("change", qePreview);
    });

    // Sync UI + validate for draft safety
    if($("qeType")){
      $("qeType").addEventListener("change", ()=>{
        qeSyncTypeUI();
        qePreview();
        qeValidate();
      });
    }
    ["qeDate","qeParty","qeAmount"].forEach(id=>{
      const el = $(id);
      if(el) el.addEventListener("input", qeValidate);
      if(el) el.addEventListener("change", qeValidate);
    });

    if($("qeOverlay")) $("qeOverlay").addEventListener("click", qeClose);
    if($("qeClose")) $("qeClose").addEventListener("click", qeClose);
    if($("qeSave")) $("qeSave").addEventListener("click", qeSave);
    if($("qeGoSearch")) $("qeGoSearch").addEventListener("click", ()=>{
      const id = window.__qeId;
      const tx = state.tx.find(x=>x.id===id);
      qeClose();
      if(!tx) return;
      setView("search");
      $("qFrom").value = (tx.date||"").slice(0,7) + "-01";
      $("qTo").value = (tx.date||"").slice(0,7) + "-31";
      renderSearch();
      const party = getName(state.masters.parties, tx.partyId);
      $("qKeyword").value = party || "";
      renderSearch();
      // auto-select the row for edit
      try{
        const cb = document.querySelector('input.selTx[data-id="'+id+'"]');
        if(cb){ cb.checked=true; cb.dispatchEvent(new Event("change")); }
      }catch(_){}
    });
    ["qeDate","qeType","qeQty","qeUnitPrice","qeAmount","qeVatMode"].forEach(id=>{
      const el = $(id);
      if(el) el.addEventListener("input", qePreview);
      if(el) el.addEventListener("change", qePreview);
    });


    // Excel-month panel controls
    if($("excelMonthPick")){
      $("excelMonthPick").value = $("excelMonthPick").value || thisMonth();
      if($("excelMonthPick")) $("excelMonthPick").addEventListener("change", renderExcelMonthDetail);
    }
    if($("btnExcelMonthNow")) $("btnExcelMonthNow").addEventListener("click", ()=>{ $("excelMonthPick").value = thisMonth(); renderExcelMonthDetail(); });
    if($("btnExcelMonthRefresh")) $("btnExcelMonthRefresh").addEventListener("click", renderExcelMonthDetail);
    if($("btnOpenMonthView")) $("btnOpenMonthView").addEventListener("click", ()=>{ 
      // sync month picker
      if($("monthPick") && $("excelMonthPick")) $("monthPick").value = $("excelMonthPick").value;
      setView("month"); 
    });



    // Ledger power bindings
    if($("ledOnlyUninvoiced")) $("ledOnlyUninvoiced").addEventListener("click", ()=>{
      $("ledOnlyUninvoiced").classList.toggle("ok");
      $("ledOnlyUninvoiced").textContent = $("ledOnlyUninvoiced").classList.contains("ok") ? "미발행만: ON" : "미발행만";
      renderLedger();
    });
    if($("ledOnlyOpen")) $("ledOnlyOpen").addEventListener("click", ()=>{
      $("ledOnlyOpen").classList.toggle("ok");
      $("ledOnlyOpen").textContent = $("ledOnlyOpen").classList.contains("ok") ? "미정산만: ON" : "미정산만";
      renderLedger();
    });
    if($("ledAged")) $("ledAged").addEventListener("change", renderLedger);

    // PM_DETAIL_TOGGLE_BIND
    if($("btnPmToggleDetail")) $("btnPmToggleDetail").addEventListener("click", ()=>{
      const wrap = $("pmDetailWrap");
      if(!wrap) return;
      const isHidden = (wrap.style.display==="none" || wrap.style.display==="");
      // If project selected, toggle; if not selected, keep hidden
      const pid = $("pmProject")?.value || "";
      if(!pid){ wrap.style.display = "none"; $("btnPmToggleDetail").textContent = "상세: 숨김"; return; }
      if(isHidden){
        wrap.style.display = "";
        $("btnPmToggleDetail").textContent = "상세: 표시";
      }else{
        wrap.style.display = "none";
        $("btnPmToggleDetail").textContent = "상세: 숨김";
      }
      runProjectMonth();
    });

    // Aged list bindings
    if($("agedDaysArAp")) $("agedDaysArAp").addEventListener("change", renderAgedList);
    if($("agedShowAR")) $("agedShowAR").addEventListener("change", renderAgedList);
    if($("agedShowAP")) $("agedShowAP").addEventListener("change", renderAgedList);

  }

  // ===== Init =====
  await load();
  removeAlwaysARAPCards();
  hydrateSelects();
  renderExcelGrid();
  renderProjectInit();
  renderAll();
  await initAutoBackupFromCache();
  setAutoMatchUI();
  setCompactUI();
  try{ ensureArapDates(); renderArapPeriod(); }catch(e){}
  bind();
  setAutoMatchUI();
  setCompactUI();
  save("로컬 자동저장 활성화됨");

})();

  // ===== SAFE ADDON: 마스터즉시등록 + 저장전점검 + 장기미수/미지급 경고 =====
  (function(){
    try{
      state.masters = state.masters || { parties:[], items:[], projects:[] };

      function nk(s){
        return (s||"").toString().toLowerCase().replace(/\s+/g,"").replace(/[()㈜\[\]\-_.·,]/g,"").trim();
      }
      function has(list, name){
        const k = nk(name);
        if(!k) return true;
        return (list||[]).some(x => nk(x?.name||x) === k);
      }
      function add(list, name){
        const v = (name||"").toString().trim();
        if(!v) return;
        if(has(list, v)) return;
        const obj = { id: uid(), name: v };
        list.push(obj);
        try{ save("마스터 자동추가: " + v); }catch(e){}
        try{ if(typeof renderAutoCompleteLists==="function") renderAutoCompleteLists(); }catch(e){}
      }

      // 마스터 즉시등록(거래처/품목): 칸 이동 시 1회 확인
      const excelBody = document.getElementById("excelBody");
      if(excelBody && !excelBody._mf_masterPromptBound){
        excelBody._mf_masterPromptBound = true;
        excelBody.addEventListener("focusout", (e)=>{
          const inp = e.target;
          if(!inp || inp.tagName!=="INPUT") return;
          const k = inp.getAttribute("data-k");
          if(k!=="partyName" && k!=="itemName") return;

          const val = (inp.value||"").trim();
          if(!val) return;

          const list = (k==="partyName") ? state.masters.parties : state.masters.items;
          if(has(list, val)) return;

          const key = "mf_prompted_"+k+"_"+nk(val);
          if(sessionStorage.getItem(key)) return;
          sessionStorage.setItem(key, "1");

          if(confirm(`마스터에 등록되지 않은 ${k==="partyName"?"거래처":"품목"}입니다.\n\n"${val}"\n\n지금 마스터에 추가할까요?`)){
            add(list, val);
          }
        });
      }

      // 저장전 점검 래핑
      if(typeof saveExcelRows==="function" && !saveExcelRows._mf_wrapped){
        const _commit = saveExcelRows;

        function toNum2(v){
          const s = (v??"").toString().replace(/,/g,"").trim();
          const n = Number(s);
          return isFinite(n) ? n : 0;
        }

        function preflight(){
          const errors = [];
          const warns = [];
          const newP = new Set();
          const newI = new Set();

          (excelRows||[]).forEach((r, idx)=>{
            const row = idx+1;
            const hasAny = (r.partyName||"").trim() || (r.itemName||"").trim() || (r.projectName||"").trim() ||
              (r.qty||"").toString().trim() || (r.unitPrice||"").toString().trim() || (r.amount||"").toString().trim() ||
              (r.memo||"").trim();
            if(!hasAny) return;

            const date = (r.date||"").trim();
            const type = normalizeTxType(r.type || 'SALE');
            const party = (r.partyName||"").trim();
            const item = (r.itemName||"").trim();
            const qty = toNum2(r.qty);
            const up  = toNum2(r.unitPrice);
            const amt = toNum2(r.amount);

            if(!date) errors.push(`${row}행: 일자`);
            if(!party) errors.push(`${row}행: 거래처`);

            const needsItem = (type==="SALE"||type==="PURCHASE"||type==="EXPENSE");
            if(needsItem && !item) errors.push(`${row}행: 품목`);
            if(needsItem && !(qty>0)) errors.push(`${row}행: 수량`);
            if(needsItem && !((up>0)||(amt>0))) errors.push(`${row}행: 단가/합계`);

            if(needsItem && qty>0 && up>0 && amt>0){
              const calc = qty*up;
              const diff = Math.abs(calc-amt);
              if(diff > Math.max(1, calc*0.01)){
                warns.push(`${row}행: 수량×단가(${fmtMoney(calc)}) ≠ 합계(${fmtMoney(amt)})`);
              }
            }

            if(party && !has(state.masters.parties, party)) newP.add(party);
            if(item && !has(state.masters.items, item)) newI.add(item);
          });

          return { errors, warns, newP:[...newP], newI:[...newI] };
        }

        function longOutstanding(days=60){
          const now = new Date();
          const list = [];
          const partyById = new Map((state.masters.parties||[]).map(p=>[p.id,p.name]));
          const tx = state.tx || [];
          tx.forEach(t=>{
            if(!(t.type==="SALE"||t.type==="PURCHASE"||t.type==="EXPENSE")) return;
            const open = invoiceSettled(t).open;
            if(open<=0) return;
            const d = new Date(t.date);
            if(String(d)==="Invalid Date") return;
            const age = Math.floor((now-d)/(1000*60*60*24));
            if(age<days) return;
            const kind = (t.type==="SALE") ? "미수" : "미지급";
            const name = partyById.get(t.partyId) || t.partyName || "(미상)";
            list.push({name, kind, open, age});
          });
          const agg = new Map();
          list.forEach(x=>{
            const k = x.name+"|"+x.kind;
            const prev = agg.get(k) || {name:x.name, kind:x.kind, open:0, age:0};
            prev.open += x.open;
            prev.age = Math.max(prev.age, x.age);
            agg.set(k, prev);
          });
          return Array.from(agg.values()).sort((a,b)=> b.age-a.age).slice(0,10);
        }

        window.saveExcelRows = function(){
          const pf = preflight();
          if(pf.errors.length){
            alert("저장 불가(필수값 누락):\n- " + pf.errors.slice(0,18).join("\n- ") + (pf.errors.length>18?`\n...외 ${pf.errors.length-18}건`: ""));
            return;
          }

          if(pf.newP.length || pf.newI.length){
            const msg = [
              "미등록 마스터 항목이 있습니다. 저장과 함께 마스터에 추가할까요?",
              pf.newP.length ? `거래처: ${pf.newP.slice(0,12).join(", ")}${pf.newP.length>12?" ...":""}` : "",
              pf.newI.length ? `품목: ${pf.newI.slice(0,12).join(", ")}${pf.newI.length>12?" ...":""}` : ""
            ].filter(Boolean).join("\n");
            if(confirm(msg)){
              pf.newP.forEach(x=> add(state.masters.parties, x));
              pf.newI.forEach(x=> add(state.masters.items, x));
            }
          }

          const aged = longOutstanding(60);
          let msg2 = "";
          if(pf.warns.length){
            msg2 += "경고(확인 권장):\n- " + pf.warns.slice(0,10).join("\n- ") + (pf.warns.length>10?`\n...외 ${pf.warns.length-10}건`: "") + "\n\n";
          }
          if(aged.length){
            msg2 += "장기 미수/미지급(60일+) 상위 10건:\n" + aged.map(x=>`- ${x.name} (${x.kind}) ${fmtMoney(x.open)} / ${x.age}일`).join("\n") + "\n\n";
          }
          if(msg2){
            if(!confirm(msg2 + "그래도 저장할까요?")) return;
          }

          _commit();
          try{ if(typeof clearExcelDraft==="function") clearExcelDraft(); }catch(e){}
        };
        window.saveExcelRows._mf_wrapped = true;
      }

      try{ toast("패치 적용: 한글표기/자동합계/마스터즉시등록/저장점검", 1400); }catch(e){}
    }catch(e){}
  })();

</script>



<script>
/* MF_A16_FIX3_START: Excel save -> auto QuickSettle + Cash Project Summary + SettleHold */
(function(){
  'use strict';
  try{
    // ---- Guard: core globals ----
    if(typeof state==='undefined' || !state || !state.tx || !state.allocations) return;
    if(typeof toNum!=='function' || typeof fmtMoney!=='function') return;

    // ---- Defaults ----
    state.meta = state.meta || {};
    if(typeof state.meta.autoQuickSettleOnExcelSave !== 'boolean'){
      state.meta.autoQuickSettleOnExcelSave = true;
      try{ save('설정 초기화: 퀵정산 자동열기 ON'); }catch(e){}
    }

    // ---- Helpers ----
    const $ = (id)=>document.getElementById(id);
    const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));
    const isCash = (t)=> t && (t.type==='RECEIPT' || t.type==='PAYMENT');
    const isInv  = (t)=> t && (t.type==='SALE' || t.type==='PURCHASE' || t.type==='EXPENSE');
    const cashRole = (t)=> (t && t.type==='RECEIPT') ? 'AR' : 'AP';

    function nk(s){
      return (s||'').toString().toLowerCase().replace(/\s+/g,'').replace(/[()㈜\[\]\-_.·,]/g,'').trim();
    }

    function getPartyName(partyId){
      try{ return getName(state.masters.parties, partyId) || ''; }catch(e){ return ''; }
    }
    function getProjName(projectId){
      try{ return getName(state.masters.projects, projectId) || ''; }catch(e){ return ''; }
    }
    function getItemName(itemId){
      try{ return getName(state.masters.items, itemId) || ''; }catch(e){ return ''; }
    }

    // ---- Settle Hold: UI + persistence ----
    function ensureHoldUI(){
      if($('eHold')) return;
      const invNo = $('eInvNo');
      if(!invNo) return;
      const form = invNo.closest('.form');
      if(!form) return;
      const wrap = document.createElement('div');
      wrap.className = 'f3';
      wrap.id = 'eHoldWrap';
      wrap.innerHTML = '<label>정산보류</label><label class="chklabel"><input type="checkbox" id="eHold" class="chk">자동정산 제외</label>';
      const ref = invNo.closest('.f3');
      if(ref && ref.parentElement) ref.parentElement.insertBefore(wrap, ref.nextSibling);
      else form.appendChild(wrap);
    }
    function syncHoldVisible(){
      const w = $('eHoldWrap');
      if(!w) return;
      const ty = $('eType')?.value || '';
      const show = (ty==='SALE'||ty==='PURCHASE'||ty==='EXPENSE');
      w.style.display = show ? '' : 'none';
    }

    // Hook loadEdit & saveEdit
    if(typeof loadEdit==='function' && !loadEdit.__mf_hold){
      const _load = loadEdit;
      loadEdit = function(id){
        _load(id);
        try{
          ensureHoldUI();
          syncHoldVisible();
          const t = state.tx.find(x=>x.id===id);
          if(t && $('eHold')) $('eHold').checked = !!t.settleHold;
        }catch(e){}
      };
      loadEdit.__mf_hold = true;
      $('eType')?.addEventListener('change', syncHoldVisible);
    }

    if(typeof saveEdit==='function' && !saveEdit.__mf_hold){
      const _saveEdit = saveEdit;
      saveEdit = function(){
        const id = (typeof selectedTxId!=='undefined') ? selectedTxId : '';
        const hold = !!$('eHold')?.checked;
        _saveEdit();
        try{
          if(!id) return;
          const t = state.tx.find(x=>x.id===id);
          if(t && isInv(t)){
            t.settleHold = hold;
            save('정산보류 업데이트');
          }
        }catch(e){}
      };
      saveEdit.__mf_hold = true;
    }

    // ---- Auto allocate: skip settleHold targets ----
    if(typeof autoAllocateForSource==='function' && !autoAllocateForSource.__mf_hold){
      const _auto = autoAllocateForSource;
      autoAllocateForSource = function(sourceTx){
        try{
          if(!sourceTx || !isCash(sourceTx) || !(toNum(sourceTx.total)>0) || !sourceTx.partyId) return 0;
          const role = cashRole(sourceTx);
          const rule = ($('sAutoRule')?.value) || 'FIFO';
          const key = (x)=> (x.date||'') + (x.id||'');
          let targets = [];
          if(role==='AR'){
            targets = state.tx.filter(t=>t.partyId===sourceTx.partyId && t.type==='SALE' && toNum(t.total)>0)
              .filter(t=> !t.settleHold)
              .filter(t=> invoiceSettled(t).open>0);
          }else{
            targets = state.tx.filter(t=>t.partyId===sourceTx.partyId && (t.type==='PURCHASE'||t.type==='EXPENSE') && toNum(t.total)>0)
              .filter(t=> !t.settleHold)
              .filter(t=> invoiceSettled(t).open>0);
          }
          targets.sort((a,b)=> rule==='FIFO' ? key(a).localeCompare(key(b)) : key(b).localeCompare(key(a)));
          let rem = sourceRemaining(sourceTx, role).rem;
          if(rem<=0) return 0;
          let cnt=0;
          for(const t of targets){
            const open = invoiceSettled(t).open;
            const use = Math.min(rem, open);
            if(use>0){ addAllocation(sourceTx.id, t.id, use, role, '저장시 자동정산(보류제외)'); rem -= use; cnt++; }
            if(rem<=0) break;
          }
          return cnt;
        }catch(e){ return _auto(sourceTx); }
      };
      autoAllocateForSource.__mf_hold = true;
    }

    // ---- QuickSettle Wizard ----
    let qsSourceId = '';
    let qsRole = 'AR';
    let qsTargets = [];
    const qsSel = new Map(); // targetId->amount

    function closeQs(){ $('qsModal')?.classList.add('hidden'); qsSel.clear(); qsSourceId=''; }

    document.addEventListener('click', (ev)=>{
      const act = ev?.target?.getAttribute?.('data-act');
      if(act==='closeQs') closeQs();
    }, true);

    function fillQsProject(){
      const sel = $('qsProject');
      if(!sel) return;
      const cur = sel.value || '';
      sel.innerHTML = '<option value="">프로젝트(전체)</option>';
      (state.masters.projects||[]).forEach(p=>{
        const o=document.createElement('option');
        o.value=p.id; o.textContent=p.name;
        if(p.id===cur) o.selected=true;
        sel.appendChild(o);
      });
      // project optional
      const o0=document.createElement('option');
      o0.value='__NONE__';
      o0.textContent='프로젝트 없음(일반)';
      sel.appendChild(o0);
    }

    function buildQsTargets(){
      const src = state.tx.find(t=>t.id===qsSourceId);
      if(!src) return [];
      const includeHold = !!$('qsIncludeHold')?.checked;
      const proj = $('qsProject')?.value || '';
      const kw = (($('qsFilter')?.value)||'').trim().toLowerCase();
      const rule = $('qsRule')?.value || 'FIFO';
      const key = (x)=> (x.date||'') + (x.id||'');

      let targets = [];
      if(qsRole==='AR'){
        targets = state.tx.filter(t=>t.partyId===src.partyId && t.type==='SALE' && toNum(t.total)>0)
          .filter(t=> includeHold ? true : !t.settleHold)
          .filter(t=> invoiceSettled(t).open>0);
      }else{
        targets = state.tx.filter(t=>t.partyId===src.partyId && (t.type==='PURCHASE'||t.type==='EXPENSE') && toNum(t.total)>0)
          .filter(t=> includeHold ? true : !t.settleHold)
          .filter(t=> invoiceSettled(t).open>0);
      }

      if(proj){
        if(proj==='__NONE__') targets = targets.filter(t=> !t.projectId);
        else targets = targets.filter(t=> (t.projectId||'')===proj);
      }

      if(kw){
        targets = targets.filter(t=>{
          const blob = `${getProjName(t.projectId)} ${getItemName(t.itemId)} ${t.invoiceNo||''} ${t.memo||''}`.toLowerCase();
          return blob.includes(kw);
        });
      }

      targets.sort((a,b)=> rule==='FIFO' ? key(a).localeCompare(key(b)) : key(b).localeCompare(key(a)));
      return targets;
    }

    function renderQs(){
      const src = state.tx.find(t=>t.id===qsSourceId);
      if(!src) return;
      const party = getPartyName(src.partyId) || '-';
      const total = toNum(src.total);
      const rem = sourceRemaining(src, qsRole).rem;

      $('qsTitle').textContent = (src.type==='RECEIPT' ? '퀵정산(수금)' : '퀵정산(지급)');
      $('qsParty').textContent = party;
      $('qsTotal').textContent = fmtMoney(total);
      $('qsRem').textContent = fmtMoney(rem);
      const mb = $('qsModeBadge');
      if(mb){
        mb.textContent = (qsRole==='AR') ? 'AR(수금→매출)' : 'AP(지급→매입/경비)';
        mb.className = 'badge ' + (qsRole==='AR' ? 'b-ok' : 'b-warn');
      }

      qsTargets = buildQsTargets();
      const tb = $('qsBody');
      if(!tb) return;
      tb.innerHTML='';
      if(!qsTargets.length){
        tb.innerHTML = '<tr><td colspan="8" class="muted">미정산 대상이 없습니다.</td></tr>';
        return;
      }

      qsTargets.forEach(t=>{
        const open = invoiceSettled(t).open;
        const proj = t.projectId ? (getProjName(t.projectId) || '(삭제됨)') : '프로젝트 없음(일반)';
        const item = getItemName(t.itemId) || '';
        const checked = qsSel.has(t.id);
        const amt = checked ? (qsSel.get(t.id)||0) : 0;

        const tr=document.createElement('tr');
        tr.setAttribute('data-id', t.id);
        tr.innerHTML = `
          <td><input type="checkbox" class="qsChk" data-id="${t.id}" ${checked?'checked':''}></td>
          <td class="mono nowrap">${(t.date||'')}</td>
          <td class="muted">${proj}${t.settleHold?` <span class="badge b-warn">보류</span>`:''}</td>
          <td>${item}</td>
          <td class="mono">${t.invoiceNo||''}</td>
          <td class="right mono"><b>${fmtMoney(open)}</b></td>
          <td class="right"><input class="miniInput qsAmt" data-id="${t.id}" type="number" min="0" value="${amt||''}" style="width:140px;"></td>
          <td class="muted">${t.memo||''}</td>
        `;
        tb.appendChild(tr);
      });

      $$('.qsChk', tb).forEach(ch=>{
        ch.addEventListener('change', ()=>{
          const id = ch.getAttribute('data-id');
          if(!id) return;
          if(ch.checked){ if(!qsSel.has(id)) qsSel.set(id, 0); }
          else qsSel.delete(id);
        });
      });
      $$('.qsAmt', tb).forEach(inp=>{
        inp.addEventListener('input', ()=>{
          const id = inp.getAttribute('data-id');
          if(!id) return;
          const v = Math.max(0, Math.round(toNum(inp.value||0)));
          qsSel.set(id, v);
          const cb = tb.querySelector(`.qsChk[data-id="${id}"]`);
          if(cb && !cb.checked) cb.checked = true;
        });
      });
    }

    function openQs(sourceId){
      const src = state.tx.find(t=>t.id===sourceId);
      if(!src || !isCash(src)) return;
      if(!src.partyId){ alert('거래처를 먼저 지정하세요.'); return; }
      qsSourceId = sourceId;
      qsRole = cashRole(src);
      qsSel.clear();
      fillQsProject();
      try{ $('qsRule').value = ($('sAutoRule')?.value) || 'FIFO'; }catch(e){}
      try{ $('qsFilter').value=''; }catch(e){}
      try{ $('qsIncludeHold').checked=false; }catch(e){}
      $('qsModal')?.classList.remove('hidden');
      renderQs();
    }

    function autoFillQs(){
      const src = state.tx.find(t=>t.id===qsSourceId);
      if(!src) return;
      let rem = sourceRemaining(src, qsRole).rem;
      if(rem<=0){ alert('배분 가능한 잔액이 없습니다.'); return; }
      const picked = qsTargets.filter(t=> qsSel.has(t.id));
      if(!picked.length){ alert('대상을 체크하세요.'); return; }
      picked.forEach(t=>{
        const open = invoiceSettled(t).open;
        const use = Math.min(rem, open);
        qsSel.set(t.id, use);
        rem -= use;
      });
      renderQs();
    }

    function issueSelected(){
      const ids = Array.from(qsSel.keys());
      if(!ids.length){ alert('선택된 대상이 없습니다.'); return; }
      let n=0;
      ids.forEach(id=>{
        const t = state.tx.find(x=>x.id===id);
        if(t && isInv(t)){ t.invoiceIssued=true; n++; }
      });
      if(n){ save(`선택 발행 처리(${n}건)`); renderAll(); }
    }

    function saveQs(){
      const src = state.tx.find(t=>t.id===qsSourceId);
      if(!src) return;
      let rem = sourceRemaining(src, qsRole).rem;
      if(rem<=0){ alert('배분 가능한 잔액이 없습니다.'); return; }
      const ids = Array.from(qsSel.keys());
      if(!ids.length){ alert('대상을 체크하세요.'); return; }
      let cnt=0;
      for(const id of ids){
        const tgt = state.tx.find(t=>t.id===id);
        if(!tgt) continue;
        const open = invoiceSettled(tgt).open;
        const want = Math.max(0, Math.round(toNum(qsSel.get(id)||0)));
        const use = Math.min(rem, open, want);
        if(use>0){ addAllocation(src.id, tgt.id, use, qsRole, '퀵정산'); rem -= use; cnt++; }
        if(rem<=0) break;
      }
      if(!cnt){ alert('저장할 배분 금액이 없습니다.'); return; }
      save(`퀵정산 저장(${cnt}건)`);
      try{ renderAll(); }catch(e){}
      try{ if(typeof renderMonthLedger==='function') renderMonthLedger(); }catch(e){}
      try{ if(typeof renderExcelMonthDetail==='function') renderExcelMonthDetail(); }catch(e){}
      try{ if(typeof renderLedger==='function') renderLedger(); }catch(e){}
      closeQs();
    }

    $('qsAutoFill')?.addEventListener('click', autoFillQs);
    $('qsIssue')?.addEventListener('click', issueSelected);
    $('qsSave')?.addEventListener('click', saveQs);
    $('qsRule')?.addEventListener('change', renderQs);
    $('qsIncludeHold')?.addEventListener('change', renderQs);
    $('qsProject')?.addEventListener('change', renderQs);
    $('qsFilter')?.addEventListener('input', ()=>{ clearTimeout(window.__qsT); window.__qsT=setTimeout(renderQs, 180); });

    // ---- Cash project summary (display only) ----
    function cashProjectSummary(tx){
      try{
        if(!tx || !isCash(tx)) return '';
        const role = cashRole(tx);
        const allocs = state.allocations.filter(a=>a.sourceId===tx.id && a.role===role);
        if(!allocs.length) return '';
        const m = new Map();
        for(const a of allocs){
          const tgt = state.tx.find(t=>t.id===a.targetId);
          const pname = tgt && tgt.projectId ? (getProjName(tgt.projectId) || '(삭제됨)') : '프로젝트 없음(일반)';
          m.set(pname, (m.get(pname)||0) + toNum(a.amount));
        }
        const arr = Array.from(m.entries()).sort((a,b)=>b[1]-a[1]);
        const top = arr.slice(0,2);
        const rest = arr.length - top.length;
        const s = top.map(([n,amt])=>`${n} ${fmtMoney(amt)}`).join(' / ');
        return rest>0 ? `${s} 외 ${rest}` : s;
      }catch(e){ return ''; }
    }

    function applyCashSummary(){
      try{
        // Search table
        const qb = $('qBody');
        if(qb){
          $$('#qBody tr').forEach(tr=>{
            const id = tr.querySelector('.qSelChk')?.getAttribute('data-id') || '';
            if(!id) return;
            const tx = state.tx.find(t=>t.id===id);
            if(!tx || !isCash(tx)) return;
            const sum = cashProjectSummary(tx);
            if(!sum) return;
            const td = tr.children[4];
            if(td){ td.textContent = sum; td.title = sum; td.classList.add('muted'); }
          });
        }
        // Month table
        const mb = $('monthBody');
        if(mb){
          $$('#monthBody tr[data-id]').forEach(tr=>{
            const id = tr.getAttribute('data-id');
            const tx = state.tx.find(t=>t.id===id);
            if(!tx || !isCash(tx)) return;
            const sum = cashProjectSummary(tx);
            if(!sum) return;
            const td = tr.children[3];
            if(td){ td.textContent = sum; td.title=sum; td.classList.add('muted'); }
          });
        }
        // Excel month detail
        const xb = $('excelMonthBody');
        if(xb){
          $$('#excelMonthBody tr[data-id]').forEach(tr=>{
            const id = tr.getAttribute('data-id');
            const tx = state.tx.find(t=>t.id===id);
            if(!tx || !isCash(tx)) return;
            const sum = cashProjectSummary(tx);
            if(!sum) return;
            const td = tr.children[3];
            if(td){ td.textContent = sum; td.title=sum; td.classList.add('muted'); }
          });
        }
        // Ledger
        const lb = $('ledBody');
        if(lb){
          $$('#ledBody tr[data-id]').forEach(tr=>{
            const id = tr.getAttribute('data-id');
            const tx = state.tx.find(t=>t.id===id);
            if(!tx || !isCash(tx)) return;
            const sum = cashProjectSummary(tx);
            if(!sum) return;
            const td = tr.children[3];
            if(td){ td.textContent = sum; td.title=sum; td.classList.add('muted'); }
          });
        }
      }catch(e){}
    }

    // Hook renderers to apply summaries
    function hook(fnName){
      const fn = window[fnName];
      if(typeof fn!=='function' || fn.__mf_hooked) return;
      window[fnName] = function(){
        const r = fn.apply(this, arguments);
        try{ applyCashSummary(); }catch(e){}
        return r;
      };
      window[fnName].__mf_hooked = true;
    }
    hook('renderSearch');
    hook('renderMonthLedger');
    hook('renderExcelMonthDetail');
    hook('renderLedger');

    // ---- Excel save -> auto open QS ----
    if(typeof saveExcelRows==='function' && !saveExcelRows.__mf_autoQS){
      const _save = saveExcelRows;
      window.saveExcelRows = function(){
        const want = !!state.meta.autoQuickSettleOnExcelSave;
        const beforeIds = new Set((state.tx||[]).map(t=>t.id));
        let snap = null;
        try{
          // snapshot last cash row intent
          const rows = (window.excelRows||[]).slice();
          for(let i=rows.length-1;i>=0;i--){
            const r = rows[i]||{};
            const type = (r.type||'').toString().toUpperCase();
            const hasAny = (r.partyName||'').trim() || (r.projectName||'').trim() || (r.itemName||'').trim() || String(r.amount||'').trim() || (r.memo||'').trim();
            if(!hasAny) continue;
            if(type==='RECEIPT' || type==='PAYMENT'){
              snap = {
                type,
                date: (r.date||today()),
                partyName: (r.partyName||'').trim(),
                total: Math.round(toNum(r.amount||0))
              };
              break;
            }
          }
        }catch(e){}

        const ret = _save.apply(this, arguments);

        if(!want) return ret;

        setTimeout(()=>{
          try{
            // only in excel view
            const v = $('view-excel');
            if(v && v.style.display==='none') return;
            // find newly created cash tx
            const newCash = (state.tx||[]).filter(t=> !beforeIds.has(t.id) && isCash(t));
            if(!newCash.length) return;
            let target = null;
            if(snap){
              const sParty = nk(snap.partyName);
              for(const t of newCash){
                const pn = nk(getPartyName(t.partyId));
                if(t.type===snap.type && pn===sParty && (t.date||'')===snap.date && Math.abs(toNum(t.total)-snap.total)<=1){
                  target = t; break;
                }
              }
            }
            if(!target){
              newCash.sort((a,b)=> ((a.date||'')+a.id).localeCompare((b.date||'')+b.id));
              target = newCash[newCash.length-1];
            }
            if(!target) return;
            // open only if remaining >0
            const role = cashRole(target);
            if(sourceRemaining(target, role).rem<=0) return;
            openQs(target.id);
          }catch(e){}
        }, 80);

        return ret;
      };
      window.saveExcelRows.__mf_autoQS = true;
    }

    // Manual open: add small button next to "입력행 저장" (optional)
    (function(){
      const btn = $('btnSaveRows');
      if(!btn || $('btnOpenLastQS')) return;
      const b = document.createElement('button');
      b.className='btn';
      b.id='btnOpenLastQS';
      b.textContent='마지막 수금/지급 퀵정산';
      b.title='엑셀입력 저장 후 마지막 수금/지급을 바로 배분';
      btn.parentElement?.insertBefore(b, btn);
      b.addEventListener('click', ()=>{
        try{
          const v = $('view-excel');
          if(v && v.style.display==='none') setView('excel');
          const cash = (state.tx||[]).filter(isCash);
          if(!cash.length){ alert('수금/지급 거래가 없습니다.'); return; }
          cash.sort((a,b)=> ((a.date||'')+a.id).localeCompare((b.date||'')+b.id));
          const last = cash[cash.length-1];
          openQs(last.id);
        }catch(e){ alert('퀵정산 열기 실패'); }
      });
    })();

    // Close handler also closes on ESC
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeQs(); });

    // Ensure UI exists
    ensureHoldUI();
    syncHoldVisible();

  }catch(e){
    // Fail silent: do not break ERP
    try{ console.error('MF_A16_FIX3 error', e); }catch(_){ }
  }
})();
/* MF_A16_FIX3_END */
</script>


<!-- Quick Settle Modal (퀵정산 위저드) -->
<div id="qsModal" class="modal hidden">
  <div class="modal__backdrop" data-act="closeQs"></div>
  <div class="modal__panel">
    <div class="modal__head">
      <div class="modal__title" id="qsTitle">퀵정산</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <span class="pill">거래처: <b id="qsParty">-</b></span>
        <span class="pill">금액: <b id="qsTotal">0</b></span>
        <span class="pill">잔액: <b id="qsRem">0</b></span>
        <button class="btn" data-act="closeQs">닫기</button>
      </div>
    </div>
    <div class="modal__body">
      <div class="card">
        <div class="toolbar">
          <div class="left" style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
            <span class="badge b-pri" id="qsModeBadge">AR</span>
            <select id="qsRule" style="width:160px;">
              <option value="FIFO">오래된 건부터(FIFO)</option>
              <option value="LIFO">최신 건부터(LIFO)</option>
            </select>
            <select id="qsProject" style="width:220px;"></select>
            <input id="qsFilter" class="in" placeholder="프로젝트/품목/번호/메모 검색" style="width:260px;">
            <label class="tiny"><input type="checkbox" id="qsIncludeHold"> 보류 포함</label>
          </div>
          <div class="right" style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
            <button class="btn" id="qsAutoFill">자동 채우기</button>
            <button class="btn" id="qsIssue" title="선택된 대상(매출/매입/경비)에 계산서 발행 처리">선택 발행</button>
            <button class="btn pri" id="qsSave">정산 저장</button>
          </div>
        </div>
        <div class="note" style="margin-top:8px;">체크한 대상만 배분됩니다. 자동 채우기는 선택한 순서대로 잔액을 배분합니다.</div>
        <div class="gridwrap" style="margin-top:10px;">
          <table class="txgrid">
            <thead>
              <tr>
                <th style="width:70px;">선택</th>
                <th style="min-width:110px;">일자</th>
                <th style="min-width:220px;">프로젝트</th>
                <th style="min-width:220px;">품목</th>
                <th style="min-width:140px;">번호</th>
                <th class="right" style="min-width:140px;">잔액</th>
                <th class="right" style="min-width:160px;">배분금액</th>
                <th style="min-width:240px;">메모</th>
              </tr>
            </thead>
            <tbody id="qsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Aged AR/AP Modal (장기 미수/미지급) -->
<div id="agedModal" class="modal hidden">
  <div class="modal__backdrop" data-act="closeAgedModal"></div>
  <div class="modal__panel">
    <div class="modal__head">
      <div class="modal__title">장기 미수/미지급</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" data-act="closeAgedModal">닫기</button>
      </div>
    </div>
    <div class="modal__body">
      <div class="card">
        <div class="toolbar">
          <div class="left">
            <span class="badge b-warn">장기 미수/미지급</span>
            <span class="note">기준일수 이상 잔액(미정산)이 남은 원거래. 행 클릭 → 검색/조합 이동</span>
          </div>
          <div class="right">
            <select id="agedDaysArAp" style="width:140px;">
              <option value="30">30일+</option>
              <option value="60" selected>60일+</option>
              <option value="90">90일+</option>
            </select>
            <label class="tiny"><input type="checkbox" id="agedShowAR" checked> 미수</label>
            <label class="tiny"><input type="checkbox" id="agedShowAP" checked> 미지급</label>
          </div>
        </div>
        <div class="gridwrap" style="margin-top:10px;">
          <table class="txgrid">
            <thead>
              <tr>
                <th style="min-width:90px;">경과</th>
                <th style="min-width:110px;">일자</th>
                <th style="min-width:90px;">구분</th>
                <th style="min-width:180px;">거래처</th>
                <th style="min-width:200px;">프로젝트</th>
                <th style="min-width:220px;">품목</th>
                <th class="right" style="min-width:140px;">잔액</th>
                <th style="min-width:120px;">계산서</th>
                <th style="min-width:140px;">번호</th>
                <th style="min-width:260px;">메모</th>
              </tr>
            </thead>
            <tbody id="agedBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Allocation Detail Modal (정산내역) -->
<div id="allocModal" class="modal hidden">
  <div class="modal__backdrop" data-act="closeAllocModal"></div>
  <div class="modal__panel">
    <div class="modal__head">
      <div class="modal__title" id="allocModalTitle">정산내역</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn pri" id="btnAllocGoSettle">정산/매칭</button>
        <button class="btn" data-act="closeAllocModal">닫기</button>
      </div>
    </div>
    <div class="modal__body">
      <div class="note" id="allocModalSummary" style="margin-bottom:10px;"></div>
      <div class="gridwrap">
        <table class="txgrid">
          <thead><tr><th style="min-width:110px;">입금/지급일</th><th style="min-width:90px;">원천</th><th style="min-width:280px;">메모</th><th class="right" style="min-width:140px;">배분금액</th></tr></thead>
          <tbody id="allocModalBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>


<!-- AR/AP Detail Modal -->
<div id="arapDetailModal" class="modal hidden">
  <div class="modal__backdrop" data-act="closeArapDetail"></div>
  <div class="modal__panel">
    <div class="modal__head">
      <div class="modal__title" id="arapDetailTitle">미수/미지급 상세</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" id="btnArapDetailGoSearch">검색/조합</button>
        <button class="btn" id="btnArapDetailToExcel">엑셀입력</button>
        <button class="btn pri" id="btnArapDetailGoSettle">정산/매칭</button>
        <button class="btn" data-act="closeArapDetail">닫기</button>
      </div>
    </div>
    <div class="modal__body">
      <div class="note" id="arapDetailSummary" style="margin-bottom:10px;"></div>
      <div class="gridwrap">
        <table class="txgrid">
          <thead>
            <tr>
              <th>일자</th><th>구분</th><th>프로젝트</th><th>품목</th>
              <th class="right">총액</th><th class="right">정산(누적)</th><th class="right">잔액</th>
              <th>결제상태</th><th>최근결제일</th><th>계산서</th><th>번호</th><th>메모</th>
            </tr>
          </thead>
          <tbody id="arapDetailBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>


<script id="mf_patch_integrated_20260201">
/* MakeFreeERP Integrated Patch (stable, db unchanged)
   - Expense templates in Excel input
   - Pair badge (same date+item has SALE and PURCHASE) in Search/Month tables
   - UI scale helpers (master lists scroll + search; autocomplete top-N by usage)
   - Sort fix: same date keep input order (month/search tables)
*/
(function(){
  'use strict';
  const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));
  const $  = (id)=>document.getElementById(id);

  // ---- Build marker (UI) ----
  try{ const bt=$('buildTag'); if(bt) bt.textContent = 'Build: A17_INTEGRATED_EXPENSE_PAIR_UI_SCALE_SORT_20260201'; }catch(e){}

  // ---- Helpers ----
  function safeToast(msg){
    try{ if(typeof toast==='function') toast(msg); }catch(e){}
  }
  function txInputKey(t){
    try{
      if(!t) return 0;
      if(typeof t.createdAt === 'number' && Number.isFinite(t.createdAt)) return t.createdAt;
      if(typeof t.createdAt === 'string'){
        const d = Date.parse(t.createdAt);
        if(Number.isFinite(d)) return d;
      }
      const id = String(t.id||'');
      const last = id.split('_').pop();
      const v = parseInt(last, 36);
      return Number.isFinite(v) ? v : 0;
    }catch(e){ return 0; }
  }
  function txOrderMap(){
    const m=new Map();
    try{
      (window.state?.tx||[]).forEach((t)=>{ if(t && t.id) m.set(t.id, txInputKey(t)); });
    }catch(e){}
    return m;
  }
  function getTxById(id){
    try{ return (window.state?.tx||[]).find(t=>t.id===id) || null; }catch(e){ return null; }
  }
  function ensureRowIds(tbody){
    $$('.mf_row_id_ready', tbody).forEach(x=>x.classList.remove('mf_row_id_ready'));
    $$('.mf_row_id_ready', tbody).forEach(()=>{});
    $$('#'+tbody.id+' tr', tbody).forEach(()=>{});
    // set tr.dataset.id using any element with data-id inside the row
    $$('#'+tbody.id+' tr', tbody).forEach(tr=>{
      if(tr.dataset.id) return;
      const el = tr.querySelector('[data-id]');
      if(el && el.getAttribute('data-id')) tr.dataset.id = el.getAttribute('data-id');
    });
  }

  function flowWeight(type){
    switch(String(type||'')){
      case 'PURCHASE': return 10;
      case 'EXPENSE': return 15;
      case 'SALE': return 20;
      case 'RECEIPT': return 30;
      case 'PAYMENT': return 40;
      case 'OFFSET': return 50;
      default: return 60;
    }
  }
  function dateKeyFromText(s){
    const t = String(s||'');
    const m = t.match(/(\d{4})\D*(\d{1,2})\D*(\d{1,2})/);
    if(!m) return 0;
    const y = parseInt(m[1],10)||0;
    const mo = parseInt(m[2],10)||0;
    const d = parseInt(m[3],10)||0;
    return y*10000 + mo*100 + d;
  }
  function sortTbodyByDateThenInputOrder(tbody, dateColIndex, mode){
    if(!tbody) return;
    mode = mode || "DATE_ASC_INPUT";
    const desc = String(mode).includes("DESC");
    const flow = String(mode).includes("FLOW");
    const order = txOrderMap();
    const trs = Array.from(tbody.querySelectorAll("tr"));
    if(!trs.length) return;

    const metas = trs.map(tr=>{
      let id = tr.dataset.id || "";
      if(!id){
        const el = tr.querySelector("[data-id]");
        if(el && el.getAttribute("data-id")) id = el.getAttribute("data-id");
      }
      tr.dataset.id = id;
      const t = id ? getTxById(id) : null;
      const dk = (t && t.date) ? dateKeyFromText(t.date) : dateKeyFromText(tr.children?.[dateColIndex]?.textContent);
      const ok = t ? (order.get(id) ?? txInputKey(t)) : 0;
      const w = t ? flowWeight(t.type) : 60;
      const itemId = (t && t.itemId) ? String(t.itemId) : "";
      const gid = itemId ? (dk + "|" + itemId) : (dk + "|__" + (id || Math.random()));
      return {tr, id, dk, ok, w, gid};
    });

    const gmin = new Map();
    metas.forEach(m=>{
      const cur = gmin.get(m.gid);
      if(cur===undefined || m.ok < cur) gmin.set(m.gid, m.ok);
    });

    metas.sort((a,b)=>{
      if(a.dk !== b.dk) return desc ? (b.dk - a.dk) : (a.dk - b.dk);

      if(flow){
        if(a.w !== b.w) return a.w - b.w;
        if(a.ok !== b.ok) return a.ok - b.ok;
        return String(a.id).localeCompare(String(b.id));
      }

      const ga = gmin.get(a.gid) ?? a.ok;
      const gb = gmin.get(b.gid) ?? b.ok;
      if(ga !== gb) return ga - gb;
      // 같은 날짜+같은 품목(그룹) 안에서는 매입/경비 → 매출 순서로 정렬
      if(a.w !== b.w) return a.w - b.w;
      if(a.ok !== b.ok) return a.ok - b.ok;
      return String(a.id).localeCompare(String(b.id));
    });

    metas.forEach(m=>tbody.appendChild(m.tr));
  }

  function applyPairBadge(tbody, dateIdx, itemIdx){
    if(!tbody) return;
    const order = txOrderMap();
    const ids = [];
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      let id = tr.dataset.id;
      if(!id){
        const el = tr.querySelector('[data-id]');
        if(el) id = el.getAttribute('data-id');
      }
      if(id) ids.push(id);
    });
    if(!ids.length) return;

    const keyMap = new Map(); // key -> {sale,purch}
    ids.forEach(id=>{
      const t = getTxById(id);
      if(!t) return;
      const itemId = t.itemId || '';
      const date = (t.date||'').trim();
      if(!date || !itemId) return;
      const key = date + '|' + itemId;
      const o = keyMap.get(key) || {sale:false,purch:false};
      if(t.type==='SALE') o.sale=true;
      if(t.type==='PURCHASE') o.purch=true;
      keyMap.set(key, o);
    });

    const hasPairKey = (t)=>{
      const itemId=t?.itemId||''; const date=(t?.date||'').trim();
      if(!date || !itemId) return false;
      const o = keyMap.get(date+'|'+itemId);
      return !!(o && o.sale && o.purch);
    };

    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      let id = tr.dataset.id;
      if(!id){
        const el = tr.querySelector('[data-id]');
        if(el) id = el.getAttribute('data-id');
      }
      if(!id) return;
      const t = getTxById(id);
      if(!t) return;
      // apply only to SALE/PURCHASE rows
      if(!(t.type==='SALE' || t.type==='PURCHASE')) return;
      if(!hasPairKey(t)) return;
      const td = tr.children[itemIdx];
      if(!td) return;
      if(td.querySelector('.mf_pair_badge')) return;
      const badge = document.createElement('span');
      badge.className = 'badge b-warn mf_pair_badge';
      badge.style.marginLeft = '6px';
      badge.textContent = '매입+매출';
      td.appendChild(badge);
    });
  }

  // ---- Expense Templates (Excel input) ----
  function addExpenseTemplateRows(kind){
    if(typeof window.excelRows==='undefined' || typeof window.newEmptyRow!=='function') return;
    const pushRow = (label, memo)=>{
      const r = window.newEmptyRow();
      r.type = 'EXPENSE';
      r.partyName = label;
      r.itemName = label;
      r.projectName = '';
      r.qty = 1;
      r.unitPrice = '';
      r.amount = '';
      r.vatMode = 'INCLUDED';
      r.invoiceIssued = false;
      r.invoiceNo = '';
      r.memo = memo || '';
      // insert at top for visibility
      window.excelRows.unshift(r);
    };

    const todayStr = (typeof today==='function') ? today() : '';
    const mkMemo = (title)=> `${title} (${todayStr})`;

    if(kind==='SET'){
      ['급여','4대보험','임대료','통신비','이자','세금'].forEach(n=>pushRow(n, mkMemo(n)));
    }else if(kind==='RECENT'){
      try{
        const tx = (window.state?.tx||[]).slice().reverse().find(t=>t.type==='EXPENSE');
        if(tx){
          const label = (window.getName && window.state?.masters) ? (getName(state.masters.parties, tx.partyId) || '경비') : '경비';
          const item = (window.getName && window.state?.masters) ? (getName(state.masters.items, tx.itemId) || label) : label;
          const r = window.newEmptyRow();
          r.type='EXPENSE';
          r.partyName = label;
          r.itemName = item;
          r.projectName = '';
          r.qty = tx.qty ?? 1;
          r.unitPrice = tx.unitPrice ?? '';
          r.amount = tx.total ?? '';
          r.vatMode = tx.vatMode || 'INCLUDED';
          r.invoiceIssued = !!tx.invoiceIssued;
          r.invoiceNo = tx.invoiceNo || '';
          r.memo = tx.memo || '';
          window.excelRows.unshift(r);
        }else{
          pushRow('경비', mkMemo('경비'));
        }
      }catch(e){
        pushRow('경비', mkMemo('경비'));
      }
    }else{
      const label = kind;
      pushRow(label, mkMemo(label));
    }

    try{
      if(typeof window.ensureExcelRows==='function') ensureExcelRows(20);
      if(typeof window.renderExcelGrid==='function') renderExcelGrid();
      if(typeof window.saveExcelDraftDebounced==='function') saveExcelDraftDebounced('템플릿');
    }catch(e){}
    safeToast('경비 템플릿 추가');
  }

  function injectExpenseTemplateBar(){
    const view = $('view-excel');
    if(!view) return;
    if($('mfExpenseBar')) return;
    const card = view.querySelector('.card');
    if(!card) return;
    const bar = document.createElement('div');
    bar.id='mfExpenseBar';
    bar.className='card';
    bar.style.marginTop='12px';
    bar.innerHTML = `
      <div class="toolbar">
        <div class="left" style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
          <span class="badge b-pri">경비 템플릿</span>
          <button class="btn tiny" data-exp="급여">급여</button>
          <button class="btn tiny" data-exp="4대보험">4대보험</button>
          <button class="btn tiny" data-exp="이자">이자</button>
          <button class="btn tiny" data-exp="세금">세금</button>
          <button class="btn tiny" data-exp="임대료">임대료</button>
          <button class="btn tiny" data-exp="통신비">통신비</button>
          <button class="btn tiny" data-exp="운송비">운송비</button>
          <button class="btn tiny" data-exp="외주비">외주비</button>
        </div>
        <div class="right" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <button class="btn" data-exp="SET" title="급여+보험+임대료+통신비+이자+세금">정기세트</button>
          <button class="btn" data-exp="RECENT" title="최근 경비 1건 복사">최근경비</button>
          <span class="note">* 거래처/품목은 고정, 상세는 메모</span>
        </div>
      </div>
    `;
    // insert near top of excel view (after main card)
    card.parentNode.insertBefore(bar, card.nextSibling);

    bar.querySelectorAll('[data-exp]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const k = btn.getAttribute('data-exp');
        addExpenseTemplateRows(k);
      });
    });
  }

  // ---- Master UI scale: scroll + search filter ----
  function injectMasterSearchAndScroll(){
    const view = $('view-master');
    if(!view) return;

    function setupBlock(inputId, tbodyId){
      const tbody = $(tbodyId);
      if(!tbody) return;
      const wrap = tbody.closest('.gridwrap');
      if(wrap){
        wrap.style.maxHeight = '420px';
        wrap.style.overflow = 'auto';
      }
      const input = $(inputId);
      if(!input || input.dataset.mfBound) return;
      input.dataset.mfBound='1';
      input.placeholder = (input.placeholder||'') + ' / 검색가능';
      input.addEventListener('input', ()=>{
        const q = (input.value||'').trim().toLowerCase();
        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.forEach(tr=>{
          const txt = (tr.textContent||'').toLowerCase();
          tr.style.display = (!q || txt.includes(q)) ? '' : 'none';
        });
      });
    }
    // reuse existing add inputs as search+add: keep safe; user can still add
    setupBlock('mParty', 'partyBody');
    setupBlock('mProj', 'projBody');
    setupBlock('mItem', 'itemBody');
  }

  // ---- Autocomplete: top-N by usage ----
  function patchAutocompleteTopN(){
    if(typeof window.renderAutoCompleteLists!=='function') return;
    if(window.renderAutoCompleteLists.__mfPatched) return;

    const orig = window.renderAutoCompleteLists;
    window.renderAutoCompleteLists = function(){
      try{
        const {parties, items, projects} = (typeof getMastersForAutocomplete==='function') ? getMastersForAutocomplete() : {parties:[],items:[],projects:[]};
        const tx = window.state?.tx || [];
        const cParty = new Map(), cItem = new Map(), cProj = new Map();
        tx.forEach(t=>{
          if(t.partyId) cParty.set(t.partyId,(cParty.get(t.partyId)||0)+1);
          if(t.itemId) cItem.set(t.itemId,(cItem.get(t.itemId)||0)+1);
          if(t.projectId) cProj.set(t.projectId,(cProj.get(t.projectId)||0)+1);
        });
        const sortBy = (arr, cmap)=> (arr||[]).slice().sort((a,b)=>{
          const ca = cmap.get(a.id)||0, cb = cmap.get(b.id)||0;
          if(cb!==ca) return cb-ca;
          return (a.name||'').localeCompare((b.name||''), 'ko');
        });
        const topParties = sortBy(parties, cParty).slice(0, 300);
        const topItems   = sortBy(items, cItem).slice(0, 400);
        const topProjects= sortBy(projects, cProj).slice(0, 400);

        if(typeof setDatalistOptions==='function'){
          setDatalistOptions('dlParties', topParties);
          setDatalistOptions('dlItems', topItems);
          setDatalistOptions('dlProjects', topProjects);
        }else{
          orig();
        }
      }catch(e){
        orig();
      }
    };
    window.renderAutoCompleteLists.__mfPatched = true;
  }

  // ---- Wrap render functions for sort+badge ----
  function wrapRender(){
    // Month view
    if(typeof window.renderMonthLedger==='function' && !window.renderMonthLedger.__mfWrapped){
      const orig = window.renderMonthLedger;
      window.renderMonthLedger = function(){
        orig();
        try{
          const tb = $('monthBody');
          if(tb){
            // ensure dataset ids
            Array.from(tb.querySelectorAll('tr')).forEach(tr=>{
              if(tr.dataset.id) return;
              const el = tr.querySelector('[data-id]');
              if(el) tr.dataset.id = el.getAttribute('data-id');
            });
            const __mMode = (document.getElementById('mSort')?.value) || 'DATE_ASC_INPUT';
            sortTbodyByDateThenInputOrder(tb, 0, __mMode);
            applyPairBadge(tb, 0, 4);
          }
        }catch(e){}
      };
      window.renderMonthLedger.__mfWrapped=true;
    }

    // Search view
    if(typeof window.renderSearch==='function' && !window.renderSearch.__mfWrapped){
      const origS = window.renderSearch;
      window.renderSearch = function(){
        origS();
        try{
          const tb = $('qBody');
          if(tb){
            Array.from(tb.querySelectorAll('tr')).forEach(tr=>{
              if(tr.dataset.id) return;
              const el = tr.querySelector('[data-id]');
              if(el) tr.dataset.id = el.getAttribute('data-id');
            });
            // date column index in search is 1 (0 checkbox)
            const __qMode = (document.getElementById('qSort')?.value) || (localStorage.getItem(LS+'_search_sort_v1')||'DATE_ASC_INPUT');
            sortTbodyByDateThenInputOrder(tb, 1, __qMode);
            // item column index in search is 5 (0 checkbox)
            applyPairBadge(tb, 1, 5);
          }
        }catch(e){}
      };
      window.renderSearch.__mfWrapped=true;
    }
  }

  // ---- Init when ready ----
  
  const LS_SEARCH_SORT = (typeof LS==='string' ? (LS+'_search_sort_v1') : 'MakeFreeERP_search_sort_v1');

  function sortModeHint(mode){
    switch(String(mode||'')){
      case 'DATE_ASC_INPUT': return '날짜 오름차순, 입력시간 순(같은 품목이면 매입→매출)';
      case 'DATE_DESC_INPUT': return '날짜 내림차순, 입력시간 순(같은 품목이면 매입→매출)';
      case 'DATE_ASC_FLOW': return '날짜 오름차순, 같은 날짜에서 매입→매출→수금/지급 흐름';
      case 'DATE_DESC_FLOW': return '날짜 내림차순, 같은 날짜에서 매입→매출→수금/지급 흐름';
      default: return '';
    }
  }

  function initSearchSort(){
    const sel = document.getElementById('qSort');
    if(!sel) return;
    const hint = document.getElementById('qSortHint');

    // load saved mode
    const saved = localStorage.getItem(LS_SEARCH_SORT);
    const allowed = Array.from(sel.options).map(o=>o.value);
    if(saved && allowed.includes(saved)) sel.value = saved;
    else sel.value = 'DATE_ASC_INPUT';

    const refresh = ()=>{
      if(hint) hint.textContent = sortModeHint(sel.value);
    };
    refresh();

    sel.addEventListener('change', ()=>{
      try{ localStorage.setItem(LS_SEARCH_SORT, sel.value); }catch(e){}
      refresh();
      try{ window.renderSearch && window.renderSearch(); }catch(e){}
    });
  }

  function init(){
    try{ injectExpenseTemplateBar(); }catch(e){}
    try{ injectMasterSearchAndScroll(); }catch(e){}
    try{ patchAutocompleteTopN(); }catch(e){}
    try{ wrapRender(); }catch(e){}
    try{ initSearchSort(); }catch(e){}
    // Trigger initial render updates if applicable
    try{ if(typeof renderAutoCompleteLists==='function') renderAutoCompleteLists(); }catch(e){}
    try{ if(typeof renderMonthLedger==='function') renderMonthLedger(); }catch(e){}
    try{ if(typeof renderSearch==='function') renderSearch(); }catch(e){}
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', init);
  }else{
    init();
  }
})();
</script>


<script id="mf_patch_v3_20260204">
(function(){
  "use strict";
  var $ = function(id){ return document.getElementById(id); };

  function safe(fn){ try{ return fn(); } catch(e){ return null; } }
  function toastSafe(msg){ safe(function(){ if(typeof toast==="function") toast(msg); }); }

  // 1) 월거래 화면: 퀵 수금/지급(안전) 기능 완전 비활성화 + 잔존 설정 초기화
  safe(function(){
    // 과거 설정으로 qc-on이 켜져 있어도 강제로 끔
    document.body.classList.remove("qc-on");
    // 체크박스가 있으면 제거(이미 HTML에서 제거되었을 수 있음)
    var qc = $("mQuickCash");
    if(qc && qc.closest("label")) qc.closest("label").remove();
  });

  // 퀵 수금/지급 토글 함수가 있으면 강제로 false로 오버라이드
  safe(function(){
    if(typeof getQuickCashOn === "function"){
      window.getQuickCashOn = function(){ return false; };
    }
    if(typeof setQuickCashOn === "function"){
      window.setQuickCashOn(false);
    }
  });

  
  // 1.5) 월거래 화면 재렌더(퀵처리 컬럼/버튼 잔존 제거)
  safe(function(){ if(typeof renderMonthLedger === "function") renderMonthLedger(); });
// 2) 우측 팝업 편집기(패널)로 화면이 깨지는 이슈 방지: 월거래 상세에서 패널 진입 차단
  safe(function(){
    if(typeof qeOpen === "function"){
      window.qeOpen = function(){
        toastSafe("월 거래내역(상세)에서는 우측 팝업 편집기 사용을 막아뒀어. 편집은 더블클릭 → 검색/조합에서 해줘!");
      };
    }
    // 혹시 남아있어도 보이지 않게 숨김
    var p = $("qePanel"); if(p){ p.style.display="none"; }
    var ov = $("qeOverlay"); if(ov){ ov.style.display="none"; }
  });

  // 3) 월거래 상세 기본 정렬: 날짜↑ + 입력순
  safe(function(){
    var sel = $("mSort");
    if(sel){
      sel.value = "DATE_ASC_FLOW";
      sel.dispatchEvent(new Event("change"));
    }
  });

  // 4) 미수/미지급 상세(거래처별)에서 수금/지급을 안전하게 바로 입력할 수 있게 추가
  //    - DB 스키마 변경 없음 (RECEIPT/PAYMENT 거래 1건 추가 + 정산/매칭 화면으로 이동)
  function ensureArapCashUI(){
    // 조회 전용: 기존 "수금/지급 입력" UI 제거(오해 방지)
    try{
      const t = document.getElementById("btnArapCashToggle"); if(t) t.remove();
      const box = document.getElementById("arapCashBox"); if(box) box.remove();
    }catch(e){}
  }


  function calcArapOpenTotal(partyId, role){
    if(!partyId || !role) return 0;
    if(typeof ensureArapDates === "function") ensureArapDates();
    var from = ($("arapFrom") && $("arapFrom").value) ? $("arapFrom").value : "";
    var to = ($("arapTo") && $("arapTo").value) ? $("arapTo").value : "";
    var tx = (window.state && Array.isArray(window.state.tx)) ? window.state.tx : [];
    var sum = 0;
    for(var i=0;i<tx.length;i++){
      var t = tx[i];
      if(!t || t.partyId !== partyId) continue;
      if(from && to && typeof inRange === "function"){
        if(!inRange(t.date, from, to)) continue;
      }
      if(role === "AR"){
        if(t.type !== "SALE") continue;
        if(typeof invoiceSettled === "function"){
          var st = invoiceSettled(t.id, "AR");
          sum += (st && st.open) ? st.open : 0;
        }
      } else {
        if(t.type !== "PURCHASE" && t.type !== "EXPENSE") continue;
        if(typeof invoiceSettled === "function"){
          var st2 = invoiceSettled(t.id, "AP");
          sum += (st2 && st2.open) ? st2.open : 0;
        }
      }
    }
    return Math.max(0, Math.round(sum));
  }

  function updateArapCashUI(){
    if(!window.__mfArapCashCtx) return;
    ensureArapCashUI();
    var ctx = window.__mfArapCashCtx;

    // 버튼 라벨 갱신
    var tgl = $("btnArapCashToggle");
    if(tgl){
      tgl.textContent = (ctx.role === "AR") ? "수금 입력(안전)" : "지급 입력(안전)";
    }

    // 기본값: 기간 To 날짜, 금액=잔액
    var d = $("arapCashDate");
    var a = $("arapCashAmt");
    var hint = $("arapCashHint");
    if(d){
      var to = ($("arapTo") && $("arapTo").value) ? $("arapTo").value : "";
      d.value = to || (new Date().toISOString().slice(0,10));
    }
    if(a){
      a.value = Math.max(0, Math.floor(ctx.openTotal || 0));
    }
    if(hint && typeof fmt === "function"){
      hint.textContent = "잔액 합계: " + fmt(ctx.openTotal || 0);
    }
    var memo = $("arapCashMemo"); if(memo) memo.value = "";
  }

  
  function inferArapCashCtxFromModal(){
    try{
      var titleEl = $("arapDetailTitle");
      var t = titleEl ? (titleEl.textContent||"") : "";
      // 기대 형식: "상세: 주연테크 · 미지급" 또는 "상세: 주연테크 · 미수"
      var partyName = "";
      var role = "";
      if(t.indexOf("상세:")>=0){
        var s = t.split("상세:")[1] || "";
        // " 주연테크 · 미지급" → split on "·"
        var parts = s.split("·").map(function(x){ return (x||"").trim(); }).filter(Boolean);
        if(parts.length>=1) partyName = parts[0];
        if(parts.length>=2){
          if(parts[1].indexOf("미수")>=0) role = "AR";
          else if(parts[1].indexOf("미지급")>=0) role = "AP";
        }
      }
      if(!partyName) return null;
      // partyId 찾기
      var pid = "";
      safe(function(){
        if(window.state && window.state.masters && Array.isArray(window.state.masters.parties)){
          var hit = window.state.masters.parties.find(function(p){ return p && norm(p.name)===norm(partyName); });
          if(hit) pid = hit.id;
        }
      });
      if(!pid) return null;
      return { partyId: pid, role: role || "AR", openTotal: calcArapOpenTotal(pid, role || "AR") };
    }catch(e){ return null; }
  }

function saveArapCash(){
    if(!window.__mfArapCashCtx){ window.__mfArapCashCtx = inferArapCashCtxFromModal(); }
    if(!window.__mfArapCashCtx){ toastSafe("거래처를 먼저 선택해줘."); return; }
    var ctx = window.__mfArapCashCtx;

    var date = $("arapCashDate") ? $("arapCashDate").value : "";
    var amt = $("arapCashAmt") ? $("arapCashAmt").value : "0";
    var memo = $("arapCashMemo") ? $("arapCashMemo").value : "";

    if(typeof toNum === "function") amt = toNum(amt);
    else amt = Math.round(Number(amt || 0));

    if(!date){ toastSafe("일자를 입력해줘."); return; }
    if(!amt || amt <= 0){ toastSafe("금액이 0이야. 금액부터 넣어줘."); return; }

    var openTotal = Math.max(0, Math.floor(ctx.openTotal || 0));
    if(openTotal > 0 && amt > openTotal){
      amt = openTotal;
      toastSafe("잔액보다 큰 금액은 잔액으로 자동 조정했어.");
      if($("arapCashAmt")) $("arapCashAmt").value = amt;
    }

    // 기본 통장 계정
    var defaultBank = "";
    safe(function(){
      if(window.state && window.state.accounts && window.state.accounts.length){
        defaultBank = window.state.accounts.find(function(a){ return a && (a.type==="BANK"); })?.id || window.state.accounts[0].id || "";
      }
    });

    var vatMode = "ZERO";
    var vat = (typeof calcVat === "function") ? calcVat(amt, vatMode) : 0;
    var total = amt + (vat||0);

    var tx = {
      id: (typeof uid === "function") ? uid() : ("tx_"+Math.random().toString(36).slice(2)+"_"+Date.now().toString(36)),
      date: date,
      type: (ctx.role === "AR") ? "RECEIPT" : "PAYMENT",
      partyId: ctx.partyId,
      projectId: "",
      itemId: "",
      qty: 0,
      unitPrice: 0,
      amount: amt,
      vatMode: vatMode,
      vat: vat || 0,
      total: total,
      invoiceIssued: false,
      invoiceNo: "",
      memo: memo || ((ctx.role === "AR") ? "수금(정산용)" : "지급(정산용)"),
      accountId: defaultBank || ""
    };

    if(!window.state || !Array.isArray(window.state.tx)){ toastSafe("데이터 상태가 이상해. 새로고침 후 다시 해줘."); return; }
    window.state.tx.push(tx);

    // 옵션: 저장 시 자동정산(자동상계) ON이면 바로 자동매칭
    safe(function(){
      if(window.state && window.state.meta && window.state.meta.autoMatchOnSave && typeof autoAllocateForSource === "function"){
        autoAllocateForSource(tx);
      }
    });

    safe(function(){ if(typeof sortTx === "function") sortTx(); });
    safe(function(){ if(typeof save === "function") save(); });

    // 모달 닫고 정산/매칭으로 이동
    safe(function(){ if(typeof closeArapDetail === "function") closeArapDetail(); });
    safe(function(){
      if($("sParty")) $("sParty").value = ctx.partyId;
      if($("sMode")) $("sMode").value = (ctx.role === "AR") ? "AR" : "AP";
      if(typeof setView === "function") setView("settle");
      if(typeof renderSettle === "function") renderSettle();
    });

    toastSafe("저장 완료! 정산/매칭 화면으로 이동했어.");
  }

  // openArapDetail 래핑해서 컨텍스트 저장 + UI 업데이트
  safe(function(){
    if(typeof openArapDetail !== "function") return;
    var _open = openArapDetail;
    // 전역 바인딩 자체를 덮어써야(직접 호출 openArapDetail)도 훅이 먹음
    openArapDetail = function(partyId, role){
      window.__mfArapCashCtx = {
        partyId: partyId,
        role: role,
        openTotal: calcArapOpenTotal(partyId, role)
      };
      _open(partyId, role);
      updateArapCashUI();
    };
    // window에도 동일하게 연결
    window.openArapDetail = openArapDetail;
  });

  // 초기 UI 셋업
  safe(function(){ ensureArapCashUI(); });

})();
</script>


<!-- MF_FINAL_INTEGRATED_PATCH_20260216D -->
<script>
(function(){

  // -----------------------------
  // 0. STATE ACCESS (global const state vs window.state)
  // -----------------------------
  function getState(){
    try{ if(typeof state !== "undefined") return state; }catch(e){}
    try{ if(window.state && window.state.masters) return window.state; }catch(e){}
    return null;
  }

  function waitForState(cb){
    var t = setInterval(function(){
      var s = getState();
      if(s && s.masters && Array.isArray(s.tx)){
        clearInterval(t);
        cb(s);
      }
    }, 200);
  }

  function safeEsc(s){
    try{ if(typeof esc === "function") return esc(s); }catch(e){}
    return String(s||"").replace(/[&<>"']/g, function(m){
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
    });
  }

  function masterKey(s){
    try{ if(typeof normMasterName === "function") return normMasterName(s); }catch(e){}
    return (s||"").toString().toLowerCase().replace(/\s+/g,"").replace(/[()㈜\[\]\-_.·,]/g,"").trim();
  }

  // STRICT: exact match first, then UNIQUE prefix match only
  function strictResolve(name, list){
    var v = masterKey(name);
    if(!v) return null;

    var arr = list || [];
    var exact = arr.find(function(x){ return masterKey(x && x.name) === v; });
    if(exact) return exact;

    var hits = arr.filter(function(x){
      var k = masterKey(x && x.name);
      return k && k.indexOf(v) === 0;
    });
    if(hits.length === 1) return hits[0];
    return null;
  }

  // -----------------------------
  // 1) B모드: 거래 입력에서 마스터 외 자동생성 완전 차단
  // -----------------------------
  waitForState(function(s){

    function resolveOrBlock(raw, list, label){
      var nm = (raw||"").toString().trim();
      if(!nm) return { ok:true, id:"", name:"" };
      var hit = strictResolve(nm, list);
      if(!hit){
        alert(label + "은(는) 마스터에서 선택해야 합니다.\n입력값: " + nm);
        return { ok:false };
      }
      return { ok:true, id:hit.id, name:hit.name };
    }

    // 엑셀입력 저장: 행 단위로 검증/자동확정(유니크 prefix면 자동확정)
    if(typeof window.saveExcelRows === "function" && !window.saveExcelRows.__mf_masteronly){
      var _saveExcelRows = window.saveExcelRows;
      window.saveExcelRows = function(){
        try{
          if(typeof excelRows !== "undefined" && Array.isArray(excelRows)){
            for(var i=0;i<excelRows.length;i++){
              var r = excelRows[i];
              if(!r) continue;

              if(r.partyName && String(r.partyName).trim()){
                var rp = strictResolve(r.partyName, s.masters.parties);
                if(!rp){ alert((i+1) + "행 거래처는 마스터에서 선택해야 합니다.\n입력값: " + r.partyName); return; }
                r.partyName = rp.name; // 자동확정
              }
              if(r.itemName && String(r.itemName).trim()){
                var ri = strictResolve(r.itemName, s.masters.items);
                if(!ri){ alert((i+1) + "행 품목은 마스터에서 선택해야 합니다.\n입력값: " + r.itemName); return; }
                r.itemName = ri.name;
              }
              if(r.projectName && String(r.projectName).trim()){
                var rj = strictResolve(r.projectName, s.masters.projects);
                if(!rj){ alert((i+1) + "행 프로젝트는 마스터에서 선택해야 합니다.\n입력값: " + r.projectName); return; }
                r.projectName = rj.name;
              }
            }
          }
        }catch(e){}
        return _saveExcelRows.apply(this, arguments);
      };
      window.saveExcelRows.__mf_masteronly = true;
    }

    // 퀵수정/수금지급 초안 저장 전 검증
    if(typeof window.qeSaveDraftCash === "function" && !window.qeSaveDraftCash.__mf_masteronly){
      var _qeSaveDraftCash = window.qeSaveDraftCash;
      window.qeSaveDraftCash = function(){
        try{
          var partyName = (document.getElementById("qeParty")?.value || "").trim();
          var projName  = (document.getElementById("qeProj")?.value || "").trim();
          var itemName  = (document.getElementById("qeItem")?.value || "").trim();

          var rp = resolveOrBlock(partyName, s.masters.parties, "거래처");
          if(!rp.ok) return;
          if(rp.name) document.getElementById("qeParty").value = rp.name;

          if(projName){
            var rj = resolveOrBlock(projName, s.masters.projects, "프로젝트");
            if(!rj.ok) return;
            if(rj.name) document.getElementById("qeProj").value = rj.name;
          }
          if(itemName){
            var ri = resolveOrBlock(itemName, s.masters.items, "품목");
            if(!ri.ok) return;
            if(ri.name) document.getElementById("qeItem").value = ri.name;
          }
        }catch(e){}
        return _qeSaveDraftCash.apply(this, arguments);
      };
      window.qeSaveDraftCash.__mf_masteronly = true;
    }

    if(typeof window.qeSave === "function" && !window.qeSave.__mf_masteronly){
      var _qeSave = window.qeSave;
      window.qeSave = function(){
        // NEW_CASH는 qeSaveDraftCash wrapper가 처리
        try{
          if(window.__qeMode === "NEW_CASH"){
            return _qeSave.apply(this, arguments);
          }
        }catch(e){}

        try{
          var partyName = (document.getElementById("qeParty")?.value || "").trim();
          var projName  = (document.getElementById("qeProj")?.value || "").trim();
          var itemName  = (document.getElementById("qeItem")?.value || "").trim();

          if(partyName){
            var rp = resolveOrBlock(partyName, s.masters.parties, "거래처");
            if(!rp.ok) return;
            document.getElementById("qeParty").value = rp.name;
          }
          if(projName){
            var rj = resolveOrBlock(projName, s.masters.projects, "프로젝트");
            if(!rj.ok) return;
            document.getElementById("qeProj").value = rj.name;
          }
          if(itemName){
            var ri = resolveOrBlock(itemName, s.masters.items, "품목");
            if(!ri.ok) return;
            document.getElementById("qeItem").value = ri.name;
          }
        }catch(e){}

        return _qeSave.apply(this, arguments);
      };
      window.qeSave.__mf_masteronly = true;
    }

  });

  // -----------------------------
  // 2) 검색/조합: 우측 고정 편집기 (CLONE 금지 / 원본 카드 이동)
  // -----------------------------
  function initSearchPanel(){
    var qBody = document.getElementById("qBody");
    if(!qBody) return;

    if(document.getElementById("mfFixedPanel")) return;

    var panel = document.createElement("div");
    panel.id = "mfFixedPanel";
    panel.style.cssText =
      "position:fixed;top:0;right:-520px;width:520px;height:100%;background:#fff;" +
      "border-left:1px solid #e5e7eb;box-shadow:-20px 0 40px rgba(0,0,0,.2);" +
      "transition:right .25s ease;z-index:99999;display:flex;flex-direction:column;";

    panel.innerHTML =
      '<div style="padding:14px;border-bottom:1px solid #e5e7eb;font-weight:800;">' +
        '거래 수정' +
        '<button style="float:right;" id="mfPanelClose">닫기</button>' +
      '</div>' +
      '<div id="mfPanelBody" style="padding:14px;overflow:auto;flex:1;"></div>';

    document.body.appendChild(panel);

    // 닫혀있을 때도 바로 열 수 있는 "편집" 탭(우측 가장자리)
    var tab = document.createElement("div");
    tab.id = "mfPanelTab";
    tab.textContent = "편집";
    tab.style.cssText =
      "position:fixed;top:140px;right:0;z-index:100000;"+
      "background:#111827;color:#fff;padding:10px 10px;border-radius:10px 0 0 10px;"+
      "cursor:pointer;box-shadow:-8px 10px 20px rgba(0,0,0,.18);font-weight:800;letter-spacing:-.2px;";
    document.body.appendChild(tab);

    function setPanelOpen(open){
      panel.style.right = open ? "0" : "-520px";
      tab.style.display = open ? "none" : "block";
    }

    document.getElementById("mfPanelClose").addEventListener("click", function(){
      setPanelOpen(false);
    });

    tab.addEventListener("click", function(){
      setPanelOpen(true);
    });

    // 원본 수정카드를 패널로 '이동' (ID/이벤트 유지)
    var btn = document.getElementById("btnSaveEdit");
    if(btn){
      var card = btn.closest(".card");
      if(card){
        card.style.display = "block";
        var body = document.getElementById("mfPanelBody");
        body.appendChild(card);
      }
    }

    // 행 클릭 시 패널만 열기(기존 '선택→로딩' 로직은 그대로 동작)
    qBody.addEventListener("click", function(e){
        try{
          var tr = e.target.closest("tr");
          if(tr){
            var id = (tr.dataset && tr.dataset.id) ? tr.dataset.id : null;
            if(!id){
              var chk = tr.querySelector("input.qSelChk[data-id]");
              if(chk) id = chk.getAttribute("data-id");
            }
            if(id && typeof window.loadEdit === "function"){
              try{ if(typeof window.selectedTxId !== "undefined" && window.selectedTxId===id){} else window.loadEdit(id); }
              catch(_e){ try{ window.loadEdit(id);}catch(__e){} }
            }
          }
        }catch(e2){}
        setPanelOpen(true);
      }, true); // CAPTURE
  }

  // -----------------------------
  // 1) 엑셀입력: "마스터 자동추가" 프롬프트 차단
  // -----------------------------
  function blockExcelAutoMasterPrompt(){
    var excelBody = document.getElementById("excelBody");
    if(!excelBody || excelBody.__mf_blockPrompt) return;
    excelBody.__mf_blockPrompt = true;
    excelBody.addEventListener("focusout", function(e){
      var inp = e && e.target;
      if(!inp || inp.tagName!=="INPUT") return;
      var k = inp.getAttribute("data-k");
      if(k!=="partyName" && k!=="itemName" && k!=="projectName") return;
      // 기존 자동추가 리스너(버블링)를 차단
      try{ e.stopImmediatePropagation(); }catch(_e){}
    }, true);
  }

  // -----------------------------
  // 2) findOrCreate: "수정/입력 저장" 경로에서는 신규 생성 금지
  // 단, 마스터 화면의 addMaster()에서만 생성 허용
  // -----------------------------
  function gateFindOrCreate(){
    try{
      if(typeof findOrCreate !== "function") return;
      if(findOrCreate.__mf_gated) return;

      window.__mf_allowCreateMasters = false;

      // addMaster에만 생성 권한 부여
      if(typeof addMaster === "function" && !addMaster.__mf_wrappedCreateFlag){
        var _addMaster = addMaster;
        addMaster = function(kind){
          window.__mf_allowCreateMasters = true;
          try{ return _addMaster.apply(this, arguments); }
          finally{ window.__mf_allowCreateMasters = false; }
        };
        addMaster.__mf_wrappedCreateFlag = true;
      }

      var _f = findOrCreate;
      findOrCreate = function(list, name){
        var nm = (name||"").toString().trim();
        if(!nm) return "";
        // 먼저 기존 목록에서 찾기
        var k = masterKey(nm);
        var hit = (list||[]).find(function(x){
          return masterKey((x && x.name)||x) === k;
        });
        if(hit) return hit.id || hit;

        // 생성은 오직 addMaster() 경로에서만 허용
        if(!window.__mf_allowCreateMasters){
          return "";
        }
        return _f.apply(this, arguments);
      };
      findOrCreate.__mf_gated = true;
    }catch(e){}
  }

  // -----------------------------
  // 3) 엑셀입력 저장 버튼: 마스터 외 입력은 저장 "중단" (추가/생성 없음)
  // -----------------------------
  function wrapSaveExcelRowsStrict(){
    try{
      if(typeof saveExcelRows !== "function") return;
      if(saveExcelRows.__mf_strict2) return;

      var _save = saveExcelRows;
      saveExcelRows = function(){
        var s = getState();
        if(!s || !s.masters){
          alert("상태 로딩이 완료되지 않았습니다. 새로고침 후 다시 시도해주세요.");
          return;
        }
        var errs = [];
        var rows = (typeof excelRows !== "undefined" && Array.isArray(excelRows)) ? excelRows : [];
        for(var i=0;i<rows.length;i++){
          var r = rows[i] || {};
          var hasAny = (r.partyName||"").trim() || (r.itemName||"").trim() || (r.projectName||"").trim()
            || (r.qty||"").toString().trim() || (r.unitPrice||"").toString().trim() || (r.amount||"").toString().trim()
            || (r.memo||"").trim();
          if(!hasAny) continue;

          var p = (r.partyName||"").trim();
          var it = (r.itemName||"").trim();
          var pr = (r.projectName||"").trim();

          if(p && !exactHit(p, s.masters.parties)){
            errs.push((i+1)+"행 거래처는 마스터에서 선택해야 합니다: "+p);
          }
          if(it && !exactHit(it, s.masters.items)){
            errs.push((i+1)+"행 품목은 마스터에서 선택해야 합니다: "+it);
          }
          if(pr && !exactHit(pr, s.masters.projects)){
            errs.push((i+1)+"행 프로젝트는 마스터에서 선택해야 합니다: "+pr);
          }
        }
        if(errs.length){
          alert(errs.slice(0,12).join("\n"));
          return;
        }
        return _save.apply(this, arguments);
      };
      saveExcelRows.__mf_strict2 = true;
    }catch(e){}
  }

  // -----------------------------
  // 4) 검색/조합 우측 패널 "수정저장" 피드백
  // 버튼을 잠시 비활성화 + 닫기(선택)
  // -----------------------------
  function enhancePanelSaveFeedback(){
    document.addEventListener("click", function(ev){
      var btn = ev.target;
      if(!btn) return;
      if(btn.id !== "btnSaveEdit") return;

      // 우측 패널 안에서만 처리
      var panel = document.getElementById("mfFixedPanel") || document.getElementById("mfFixedPanelD") || document.getElementById("mfFixedPanelE") || document.getElementById("mfFixedPanel");
      var isInPanel = false;
      try{
        var p = btn;
        while(p){
          if(p.id === "mfFixedPanel") { isInPanel = true; break; }
          p = p.parentElement;
        }
      }catch(e){}
      if(!isInPanel) return;

      // 저장 누르면 즉시 피드백
      try{
        btn.disabled = true;
        var old = btn.textContent;
        btn.textContent = "저장중...";
        setTimeout(function(){
          btn.textContent = "저장됨";
          setTimeout(function(){
            btn.textContent = old;
            btn.disabled = false;
          }, 900);
        }, 350);
      }catch(e){}
    }, true);
  }

  // -----------------------------
  // 5) 대시보드 "오늘 할 일" 카드: 로컬 날짜 기준, 상단에 표시
  // -----------------------------
  function renderTodayCard(){
    var s = getState();
    if(!s || !Array.isArray(s.tx)) return;

    var dash = document.getElementById("view-dash");
    if(!dash) return;

    // 이미 있으면 갱신만
    var box = document.getElementById("mfTodayCard");
    if(!box){
      box = document.createElement("div");
      box.id = "mfTodayCard";
      box.className = "card";
      box.style.marginTop = "12px";
      box.innerHTML = `
        <div class="toolbar">
          <div class="left">
            <span class="badge b-pri">오늘 할 일 (거래내역 날짜 기반)</span>
            <span class="note">오늘 날짜 거래 자동 표시</span>
          </div>
          <div class="right"><span class="pill" id="mfTodayCnt">0</span></div>
        </div>
        <div id="mfTodayList" style="margin-top:10px;font-size:13px;"></div>
      `;

      // 대시보드 제목(h2) 바로 아래에 넣기
      var h2 = dash.querySelector("h2");
      if(h2 && h2.nextSibling){
        dash.insertBefore(box, h2.nextSibling);
      }else{
        dash.insertBefore(box, dash.firstChild);
      }
    }

    var today = localISODate();
    var tx = s.tx.filter(function(t){
      return (t && (t.date||"").toString().slice(0,10) === today);
    });

    var cntEl = document.getElementById("mfTodayCnt");
    if(cntEl) cntEl.innerHTML = "오늘 " + tx.length;

    var list = document.getElementById("mfTodayList");
    if(!list) return;

    if(tx.length === 0){
      list.innerHTML = "<div class='muted'>오늘 날짜 거래 없음</div>";
      return;
    }

    list.innerHTML = tx.slice(0,20).map(function(t){
      var amt = 0;
      try{ amt = (typeof toNum==="function") ? toNum(t.total||t.amount||0) : Number(t.total||t.amount||0); }catch(e){ amt=0; }
      var label = "";
      try{ label = (typeof typeLabel==="function") ? typeLabel(t.type) : (t.type||""); }catch(e){ label=t.type||""; }
      return "<div style='padding:6px 0;border-bottom:1px solid #eee;'>"
        + (t.date||"") + " / "
        + safeEsc(t.partyName||"") + " / "
        + safeEsc(label) + " / "
        + (isFinite(amt)? amt.toLocaleString() : "0") + "</div>";
    }).join("");
  }

  function init(){
    try{ if(typeof blockExcelAutoMasterPrompt==="function") blockExcelAutoMasterPrompt(); }catch(e){};
    gateFindOrCreate();
    wrapSaveExcelRowsStrict();
    enhancePanelSaveFeedback();

    // 대시보드 갱신: 렌더 함수가 있으면 그 이후에도 훅
    try{
      if(typeof renderDashboard === "function" && !renderDashboard.__mf_todayWrapped){
        var _rd = renderDashboard;
        renderDashboard = function(){
          var r = _rd.apply(this, arguments);
          try{ renderTodayCard(); }catch(e){}
          return r;
        };
        renderDashboard.__mf_todayWrapped = true;
      }
    }catch(e){}

    // 초기 1회
    setTimeout(function(){
      try{ renderTodayCard(); }catch(e){}
    }, 900);
  }

  // DOM 준비 후 실행
  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", init);
  }else{
    init();
  }

})();
</script>


<script id="mf_patch_v6_20260220">
(function(){
  "use strict";
  const $ = (id)=>document.getElementById(id);

  function localDateStr(d=new Date()){
    const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
    return z.toISOString().slice(0,10);
  }
  function monthStartStr(d=new Date()){
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    return `${y}-${m}-01`;
  }

  function lsKey(base, suffix){
    try{
      if(typeof LS === "string" && LS) return LS + "_" + suffix;
    }catch(e){}
    return "MakeFreeERP_" + suffix;
  }

  const PREF_KEY = lsKey(null, "pref_search_default_range_v1"); // "TODAY" | "MONTH"
  function getPref(){
    try{
      const v = localStorage.getItem(PREF_KEY);
      if(v==="TODAY"||v==="MONTH") return v;
    }catch(e){}
    return "TODAY"; // default: today (as user requested)
  }
  function setPref(v){
    try{ localStorage.setItem(PREF_KEY, v); }catch(e){}
  }

  function applyRange(mode){
    const from = $("qFrom");
    const to = $("qTo");
    if(!from || !to) return;

    // UX: show temporary loading hint
    try{
      const qc = $("qCount");
      if(qc) qc.textContent = "조회중...";
    }catch(e){}

    let f = "", t = "";
    if(mode==="TODAY"){
      t = localDateStr();
      f = t;
    }else{
      // MONTH: from month start to today (more intuitive than open-ended)
      f = monthStartStr();
      t = localDateStr();
    }

    from.value = f;
    to.value = t;

    // Run query after UI updates
    try{
      requestAnimationFrame(function(){
        try{ window.renderSearch && window.renderSearch(); }catch(e){}
        try{ window.scheduleSortBurst && window.scheduleSortBurst(); }catch(e){}
        try{
          const anchor = document.getElementById("qBody") || document.querySelector("#view-search .gridwrap");
          if(anchor && anchor.scrollIntoView) anchor.scrollIntoView({behavior:"smooth", block:"start"});
        }catch(e){}
      });
    }catch(e){
      try{ window.renderSearch && window.renderSearch(); }catch(e2){}
      try{ window.scheduleSortBurst && window.scheduleSortBurst(); }catch(e2){}
    }
  }

  function ensureRangeButtons(){
    const from = $("qFrom");
    const to = $("qTo");
    if(!from || !to) return;

    // Auto-run search when dates change (prevents "data not showing" confusion)
    try{
      if(!from.__mf_autoq){
        const h = function(){
          try{ window.renderSearch && window.renderSearch(); }catch(e){}
          try{ window.scheduleSortBurst && window.scheduleSortBurst(); }catch(e){}
        };
        from.addEventListener("change", function(){ setTimeout(h, 0); }, true);
        to.addEventListener("change", function(){ setTimeout(h, 0); }, true);
        from.__mf_autoq = true;
      }
    }catch(e){}
// already injected?
    if($("qQuickRangeBox")) return;

    const toWrap = to.closest(".f3") || to.parentElement;
    if(!toWrap || !toWrap.parentElement) return;

    const box = document.createElement("div");
    box.className = "f12";
    box.id = "qQuickRangeBox";
    box.innerHTML =
      '<label>기간 빠른설정</label>' +
      '<div class="row" style="gap:8px;flex-wrap:wrap;">' +
        '<button class="btn" type="button" id="qSetToday">오늘</button>' +
        '<button class="btn" type="button" id="qSetMonth">이번달</button>' +
        '<span class="note" id="qDefaultRangeHint" style="margin-left:6px;"></span>' +
      '</div>';

    toWrap.parentElement.insertBefore(box, toWrap.nextSibling);

    const hint = $("qDefaultRangeHint");
    const refreshHint = ()=>{
      const p = getPref();
      if(hint) hint.textContent = `기본기간: ${p==="TODAY" ? "오늘" : "이번달"}`;
    };
    refreshHint();

    $("qSetToday").addEventListener("click", ()=>{
      setPref("TODAY");
      refreshHint();
      applyRange("TODAY");
    });
    $("qSetMonth").addEventListener("click", ()=>{
      setPref("MONTH");
      refreshHint();
      applyRange("MONTH");
    });
  }

  function applyDefaultRangeOnce(){
    const from = $("qFrom");
    const to = $("qTo");
    if(!from || !to) return;

    // always apply preference on load (user can override by changing and it will persist via pref buttons)
    const pref = getPref();
    applyRange(pref);
    ensureRangeButtons();
  }

  function jumpToSearchToday(){
    try{
      if(typeof window.setView === "function") window.setView("search");
    }catch(e){}
    // set today range and run
    try{
      const t = localDateStr();
      if($("qFrom")) $("qFrom").value = t;
      if($("qTo")) $("qTo").value = t;
      try{ window.renderSearch && window.renderSearch(); }catch(e){}
    }catch(e){}
  }

  function ensureTodayCardButton(){
    const card = document.getElementById("mfTodayCard");
    if(!card) return;
    if(document.getElementById("mfBtnTodaySearch")) return;

    // Insert button in toolbar right side if possible
    const tb = card.querySelector(".toolbar");
    if(!tb) return;
    let right = tb.querySelector(".right");
    if(!right){
      right = document.createElement("div");
      right.className = "right";
      right.style.display = "flex";
      right.style.gap = "8px";
      tb.appendChild(right);
    }
    const btn = document.createElement("button");
    btn.className = "btn";
    btn.id = "mfBtnTodaySearch";
    btn.type = "button";
    btn.textContent = "오늘(검색/조합)";
    btn.addEventListener("click", jumpToSearchToday);
    right.appendChild(btn);
  }

  function init(){
    // delay slightly because some views render after DOMContentLoaded
    setTimeout(applyDefaultRangeOnce, 300);
    setTimeout(ensureTodayCardButton, 800);
  }

  if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", init);
  else init();
})();
</script>


<!-- MF PATCH v8: Search date default (TODAY) + quick range buttons -->
<script id="mf_patch_v8_search_default_range">
(function(){
  "use strict";
  var PREF_KEY = 'MakeFreeERP_search_range_pref_v1';

  function pad2(n){ n = String(n); return n.length===1 ? ('0'+n) : n; }
  function todayStr(){
    var d = new Date();
    return d.getFullYear() + '-' + pad2(d.getMonth()+1) + '-' + pad2(d.getDate());
  }
  function monthStartStr(){
    var d = new Date();
    return d.getFullYear() + '-' + pad2(d.getMonth()+1) + '-01';
  }

  function setRange(mode){
    var qFrom = document.getElementById('qFrom');
    var qTo   = document.getElementById('qTo');
    if(!qFrom || !qTo) return;
    var t = todayStr();
    if(mode==='MONTH'){
      qFrom.value = monthStartStr();
      qTo.value = t;
    }else{ // TODAY
      qFrom.value = t;
      qTo.value = t;
    }
    try{ localStorage.setItem(PREF_KEY, mode); }catch(e){}
    try{ if(typeof window.renderSearch==='function') window.renderSearch(); }catch(e){}
  }

  function injectButtons(){
    var form = document.querySelector('#view-search .form');
    var qTo = document.getElementById('qTo');
    if(!form || !qTo) return;
    // avoid duplicates
    if(document.getElementById('mfQuickRangeBox')) return;

    var box = document.createElement('div');
    box.className = 'f3';
    box.id = 'mfQuickRangeBox';
    box.innerHTML = '<label>빠른기간</label>'
      + '<div class="row" style="gap:8px;flex-wrap:wrap;">'
      + '  <button type="button" class="btn" id="mfRangeToday">오늘</button>'
      + '  <button type="button" class="btn" id="mfRangeMonth">이번달</button>'
      + '</div>'
      + '<div class="note" style="margin-top:6px;">기본값을 기억해둘게</div>';

    // insert right after qTo's parent
    var qToWrap = qTo.parentElement;
    if(qToWrap && qToWrap.parentElement===form){
      form.insertBefore(box, qToWrap.nextSibling);
    }else{
      form.appendChild(box);
    }

    var bt = document.getElementById('mfRangeToday');
    var bm = document.getElementById('mfRangeMonth');
    if(bt) bt.addEventListener('click', function(){ setRange('TODAY'); });
    if(bm) bm.addEventListener('click', function(){ setRange('MONTH'); });
  }

  function init(){
    injectButtons();
    var pref = null;
    try{ pref = localStorage.getItem(PREF_KEY); }catch(e){}
    if(pref!=='MONTH' && pref!=='TODAY') pref = 'TODAY';

    // Only apply if user hasn't manually set a different range in this session
    // If qFrom/qTo are empty or look like auto-filled month start, apply pref.
    var qFrom = document.getElementById('qFrom');
    var qTo   = document.getElementById('qTo');
    if(!qFrom || !qTo) return;

    var curFrom = (qFrom.value||'').trim();
    var curTo = (qTo.value||'').trim();
    var t = todayStr();
    var ms = monthStartStr();

    // If empty or defaulted to month-start..today, allow pref to override
    var looksDefaultMonth = (curFrom===ms && (curTo==='' || curTo===t));
    var looksEmpty = (!curFrom && !curTo);

    if(looksEmpty || looksDefaultMonth){
      setRange(pref);
    }
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', function(){ setTimeout(init, 300); });
  }else{
    setTimeout(init, 300);
  }
})();
</script>


<script id="mf_patch_v20_right_panel_scoped">
(function(){
  'use strict';
  if(window.__MF_RIGHTPANEL_V20__) return;
  window.__MF_RIGHTPANEL_V20__ = true;

  const $ = (id)=>document.getElementById(id);

  // Visible build marker
  try{
    const t = document.title || "";
    if(!t.includes("UIFIX_20260221_V20")) document.title = "MakeFree ERP Ultimate [UIFIX_20260221_V20]";
  }catch(e){}
  try{
    const bt = $('buildTag');
    if(bt) bt.textContent = 'Build: UIFIX_20260221_V20';
  }catch(e){}

  // Allowed views for TX edit panel
  function isAllowedClickScope(target){
    try{
      if(!target || !target.closest) return false;
      return !!(target.closest('#view-search') || target.closest('#view-month') || target.closest('#view-excel'));
    }catch(e){ return false; }
  }

  function ensurePanel(){
    if($('mfFixedPanel')) return;

    const panel = document.createElement('div');
    panel.id = 'mfFixedPanel';
    panel.style.cssText =
      "position:fixed;top:0;right:-520px;width:520px;height:100%;background:#fff;" +
      "border-left:1px solid #e5e7eb;box-shadow:-20px 0 40px rgba(0,0,0,.18);" +
      "transition:right .22s ease;z-index:99999;display:flex;flex-direction:column;";

    panel.innerHTML =
      '<div style="padding:14px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;gap:10px;">' +
        '<div style="font-weight:900;letter-spacing:-.2px;">거래 수정</div>' +
        '<div id="mfEditHeadHint" style="font-size:12px;color:#6b7280;flex:1;"></div>' +
        '<button class="btn" id="mfPanelClose" style="margin-left:auto;">닫기</button>' +
      '</div>' +
      '<div id="mfPanelBody" style="padding:14px;overflow:auto;flex:1;"></div>';

    document.body.appendChild(panel);

    const tab = document.createElement('div');
    tab.id = 'mfPanelTab';
    tab.textContent = '편집';
    tab.style.cssText =
      "position:fixed;top:140px;right:0;z-index:100000;" +
      "background:#111827;color:#fff;padding:10px 10px;border-radius:10px 0 0 10px;" +
      "cursor:pointer;box-shadow:-8px 10px 20px rgba(0,0,0,.18);font-weight:900;letter-spacing:-.2px;";
    document.body.appendChild(tab);

    function setOpen(open){
      panel.style.right = open ? '0' : '-520px';
      tab.style.display = open ? 'none' : 'block';
    }

    $('mfPanelClose').addEventListener('click', ()=>setOpen(false));
    tab.addEventListener('click', ()=>setOpen(true));

    window.mfOpenEditPanel = ()=>setOpen(true);
    window.mfCloseEditPanel = ()=>setOpen(false);
  }

  function moveEditCard(){
    // "수정 저장" 버튼이 포함된 카드(원본)를 우측 패널로 이동 (ID/이벤트 유지)
    const btn = $('btnSaveEdit');
    if(!btn) return false;

    const card = btn.closest('.card') || btn.closest('section') || btn.parentElement;
    if(!card) return false;

    // 이미 이동된 경우
    if(card.closest('#mfPanelBody')) return true;

    const body = $('mfPanelBody');
    if(!body) return false;

    card.style.display = 'block';
    card.style.margin = '0';
    body.appendChild(card);

    // 아래쪽 공백이 남아있으면(원래 자리) 자동 정리
    try{
      const anchors = document.querySelectorAll('[data-anchor="editCardHost"]');
      anchors.forEach(a=>a.remove());
    }catch(e){}

    return true;
  }

  function getIdFromRow(tr){
    if(!tr) return null;
    let id = tr.getAttribute('data-id') || (tr.dataset ? tr.dataset.id : null);
    if(!id){
      const el = tr.querySelector('[data-id]');
      if(el) id = el.getAttribute('data-id');
    }
    return id || null;
  }

  function shouldIgnoreClickTarget(target){
    if(!target) return false;
    const tag = (target.tagName||'').toUpperCase();
    if(tag === 'INPUT'){
      // 체크박스는 "선택"이므로 편집패널을 열어야 함
      const type = (target.getAttribute('type')||'').toLowerCase();
      if(type === 'checkbox') return false;
      return true;
    }
    if(tag === 'SELECT' || tag === 'TEXTAREA') return true;
    if(tag === 'BUTTON') return false; // 버튼 클릭도 패널 열리는게 자연스러움
    return false;
  }

  function safeLoadEdit(id){
    if(typeof window.loadEdit !== 'function') return false;
    try{
      window.loadEdit(id);
      return true;
    }catch(_e){
      // numeric fallback
      try{
        const n = Number(id);
        if(!Number.isNaN(n)) { window.loadEdit(n); return true; }
      }catch(__e){}
    }
    return false;
  }

  function getTxById(id){
    try{
      if(!window.state || !Array.isArray(window.state.tx)) return null;
      const sid = String(id);
      return window.state.tx.find(x=>String(x.id)===sid) || null;
    }catch(e){ return null; }
  }

  function rowHighlight(tr){
    try{
      const tb = tr && tr.parentElement;
      if(!tb) return;
      Array.from(tb.querySelectorAll('tr')).forEach(r=>r.classList.remove('sel','qActive'));
      tr.classList.add('sel');
    }catch(e){}
  }

  function updateHeaderHint(id){
    try{
      const hint = $('mfEditHeadHint');
      if(!hint) return;
      const tx = getTxById(id);
      if(!tx){ hint.textContent = 'id_' + String(id); return; }
      let party = '';
      try{
        const pid = tx.partyId;
        const ps = (window.state && window.state.masters && window.state.masters.parties) ? window.state.masters.parties : [];
        const p = ps.find(x=>String(x.id)===String(pid));
        party = p ? p.name : '';
      }catch(e){}
      let label = '';
      try{ label = (typeof window.typeLabel==='function') ? window.typeLabel(tx.type) : (tx.type||''); }catch(e){ label = tx.type||''; }
      let amt = '';
      try{
        const v = (tx.total!=null ? tx.total : tx.amount);
        if(typeof window.fmt==='function') amt = window.fmt(v);
        else if(typeof window.fmtMoney==='function') amt = window.fmtMoney(v);
        else amt = Number(v||0).toLocaleString();
      }catch(e){ amt = ''; }
      hint.textContent = [tx.date, label, party, amt].filter(Boolean).join(' · ');
    }catch(e){}
  }

  function bindScopedRowClick(){
    if(document.__mf_bindRowClickV20) return;
    document.__mf_bindRowClickV20 = true;

    document.addEventListener('click', function(e){
      try{
        const t = e.target;
        // Only within allowed transaction views
        if(!isAllowedClickScope(t)) return;
        if(shouldIgnoreClickTarget(t)) return;

        // thead는 제외
        if(t && t.closest && t.closest('thead')) return;

        let tr = t && t.closest ? t.closest('tr') : null;
        if(!tr) return;

        const id = getIdFromRow(tr);
        if(!id) return;
        // Ensure it's a real transaction id
        if(!getTxById(id)) return;

        rowHighlight(tr);
        safeLoadEdit(id);
        updateHeaderHint(id);
        if(typeof window.mfOpenEditPanel === 'function') window.mfOpenEditPanel();
      }catch(err){}
    }, true); // capture
  }

  function init(){
    ensurePanel();
    moveEditCard();
    bindScopedRowClick();
  }

  // Run init repeatedly until edit card exists (search view might render later)
  document.addEventListener('DOMContentLoaded', function(){
    let tries = 0;
    const timer = setInterval(function(){
      tries++;
      try{ init(); }catch(e){}
      if($('btnSaveEdit') && $('mfFixedPanel') && moveEditCard()){
        clearInterval(timer);
      }
      if(tries > 80) clearInterval(timer); // ~16s max
    }, 200);
  });

  // Also hook view switch if available
  try{
    if(typeof window.setView === 'function' && !window.setView.__mf_hook_v20){
      const _sv = window.setView;
      window.setView = function(){
        const r = _sv.apply(this, arguments);
        try{ init(); }catch(e){}
        // Close & hide tab on non-transaction views
        try{
          const v = arguments && arguments[0] ? String(arguments[0]) : '';
          const ok = (v==='search' || v==='month' || v==='excel');
          const tab = $('mfPanelTab');
          if(tab) tab.style.display = ok ? tab.style.display : 'none';
          if(!ok && typeof window.mfCloseEditPanel==='function') window.mfCloseEditPanel();
        }catch(e){}
        return r;
      };
      window.setView.__mf_hook_v20 = true;
    }
  }catch(e){}
})();
</script>

</body>
</html>
